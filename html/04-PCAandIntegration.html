<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="UM Bioinformatics Core" />

<meta name="date" content="2024-10-15" />

<title>PCA and Integration</title>

<script src="site_libs/header-attrs-2.28/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>
<!--
Favicon dervied from
https://twemoji.twitter.com/
https://favicon.io/emoji-favicons/dna/
-->
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="shortcut icon" href="favicon-16x16.png" />
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>




<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Intro to scRNA-Seq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="workshop_intro.html">Intro</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="00A-OrientingOnScRNASeq.html">Orienting on scRNA-Seq</a>
    </li>
    <li>
      <a href="01-GettingStarted.html">Getting Started with Seurat</a>
    </li>
    <li>
      <a href="00B-CellRangerInAction.html">Cell Ranger in Action</a>
    </li>
    <li>
      <a href="02-QCandFiltering.html">Secondary QC &amp; Filtering</a>
    </li>
    <li>
      <a href="03-Normalization.html">Normalization</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04-PCAandIntegration.html">PCA &amp; Integration</a>
    </li>
    <li>
      <a href="05-ProjectionAndClustering.html">Projection &amp; Clustering</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="06-MarkerVisualization.html">Marker identification and visualization</a>
    </li>
    <li>
      <a href="07-CellTypeAnnos.html">Cell type annotation</a>
    </li>
    <li>
      <a href="08-DifferentialExpression.html">Differential expression analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="workshop_wrap_up.html">Wrap up</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">PCA and Integration</h1>
<h4 class="author">UM Bioinformatics Core</h4>
<h4 class="date">2024-10-15</h4>

</div>


<style type="text/css">
body, td {
   font-size: 18px;
}
code.r{
  font-size: 12px;
}
pre {
  font-size: 12px
}

table.fig, th.fig, td.fig {
  border: 1px solid black;
  border-collapse: collapse;
  padding: 15px;
}
</style>
<script>
  addClassKlippyTo("pre.r, pre.markdown, pre.bash");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<div id="workflow-overview" class="section level1 unlisted unnumbered">
<h1 class="unlisted unnumbered">Workflow Overview</h1>
<p><br/>
<img src="images/wayfinder/wayfinder.png" alt="wayfinder" style="height: 400px;"/>
<br/> <br/></p>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>In this section, we will use principal component analysis (PCA) to
reduce the dimensionality of the data, first by grouping correlated
features and second by excluding correlated features that are less
likely to correspond to interesting biological variance.</p>
<table class="fig">
<tr class="fig">
<td class="fig">
<img src="images/graphical_abstracts/graphical_abstract_pca.png" />
</td>
</tr>
<tr class="fig">
<td class="fig">
A. Clustering the expression patterns directly on the feature-barcode
count matrix is impractical because the expression patterns in the
counts are often weak, repetitive, and diffuse (scattered across many,
many genes). Also clustering cells across 20k dimensions (i.e. 20k
genes) is extremely computationally intensive.<br/> B. Principal
Component Analysis considers (PCA) the count data from new orientations
that maximize the variance across the data. In this way, PCA replaces
the original count matrix with new matrix of principal component (PC)
values for each cell.<br/> C. Because PCA ranks the PCs from most
variance to least, the truly discriminating PCs will be a small subset
of top-most PCs. Focusing only on the top 10-30 PCs instead of 20k genes
tells the same story, but cuts through 99.9% of the clutter making
clustering about 1000x faster.
</td>
</tr>
</table>
<p><br/></p>
<p>After filtering and normalization, our next goal is to cluster the
cells according to their expression profiles. However, even after
filtering, we expect to have about 20,000 cells assayed with
approximately 21,000 genes measured per cell. This means that we are
working very “high-dimensional” data.</p>
<p>High dimensional data presents two challenges:</p>
<ul>
<li>The scale of the data makes analysis steps costly and slow<br />
</li>
<li>There is likely uninteresting variation across our data that we want
to exclude</li>
</ul>
<p>Similar to the previous sections, the process of parameter selection
after PCA is often iterative and while we will be showing a single
option, multiple parameter choices may need to be tested.</p>
<div id="objectives" class="section level2">
<h2>Objectives</h2>
<ul>
<li>Understand why PCA is used to reduce high-dimensional single-cell
data prior to integration and clustering<br />
</li>
<li>Use the <code>RunPCA()</code> function to generate principal
components for our data<br />
</li>
<li>Choose an appropriate number of principal components to capture
variance in our data<br />
</li>
<li>Use <code>IntegrateLayers</code> to integrate across our data prior
to clustering</li>
</ul>
<hr />
<!--Before this section - Day 1: Starting w/ Seurat, Initial QC, & Batch correction (SCtransform)-->
<!--Instruction Note: Using integrated data here and will compare to unintegrated results in next section, similar to  [here](https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-021-03957-4)?-->
</div>
</div>
<div id="what-is-pca" class="section level1">
<h1>What is PCA?</h1>
<!--- Give some context and background on PCA
- What is PCA
- Why do we use it 
--->
<!--- add PCA illustration here? --->
<p>In practical terms, Principal component analysis (PCA) creates a
simpler, more concise version of data while preserving the same “story”.
For example, we can think of a full single-cell data set as similar to
the full Lord of the Rings trilogy - large and complex with quite a bit
of detail that might be repeated and isn’t necessary to understand the
overall plot and make running the analysis prohibitively slow and
costly.</p>
<p>Like a Cliff notes version or a movie pitch for the book series, the
PCs capture correlated expression and reduce the size and complexity of
the data, while still allowing the overall structure of the data - that
we would expect to be related to cell-types or plot points in the
analogy - to be represented, while also making the computation
faster.</p>
<p><img
src="images/curriculum/04-PCAandIntegration/PCA_purpose.png" /></p>
<div id="pca-example" class="section level3">
<h3>PCA example</h3>
<p>To understand how PCA works for single-cell data, we can consider a
smaller dataset measuring the expression of four genes measured in just
two cells, we could plot the expression of those four genes, with data
from one cell plotted on the x-axis and the second cell plotted on the
y-axis.</p>
<p><img
src="images/curriculum/04-PCAandIntegration/HBC-PCA_2sample_genes.png"
alt="A simple PCA example (from HBC)" />
<!--- Update plot to replace "Sample" with "cell" in figure and table ---></p>
<p>If we wanted to represent the most variation across the data, we
would draw a diagonal line between gene B and gene C - this would
represent the first principal component (PC). However, this line doesn’t
capture all the variance in this data as the genes also vary above and
below the line, so we could draw another line (at a right angle to the
first) representing the second most variation in the data - which would
represent the second principal component (PC).</p>
<p><img
src="images/curriculum/04-PCAandIntegration/HBC-PCA_2sample_variation3.png"
alt="PCA gene loadings (from HBC)" />
<!--- Update plot to replace "Sample" with "cell" in figure ---></p>
<!--- <Consider moving to dropdown and adding figure to show loadings> However, as we can see in the example below, genes near the end of each line are those with the greatest influence on the direction and length of the PC.-->
<p>We’ll skip the process of generating all possible PCs, but running
PCA on our data will result in a score for each cell for each PC and
each gene will have a weight or loading for a given PC. By definition,
the PCs capture the greatest factors of heterogeneity in decreasing
order in the data set <a
href="https://bioconductor.org/books/3.13/OSCA.basic/dimensionality-reduction.html#principal-components-analysis">(source)</a>.</p>
</div>
<div id="why-pca-is-useful-for-single-cell-data" class="section level2">
<h2>Why PCA is useful for single-cell data</h2>
<p>In contrast to bulk RNA-seq, where the majority of the variance in a
given dataset are usually explained by the first and second PC, for
single-cell data we expect that many more PCs are contributing to the
overall variance.</p>
<p>However, we can assume that biological processes affect multiple
genes in a coordinated way. Therefore the top PCs likely represent
biological structure rather than random technical or biological noise,
which affects each gene independently and and we can use the top several
PCs to approximate the full data set in downstream analysis (<a
href="https://bioconductor.org/books/3.12/OSCA/dimensionality-reduction.html#principal-components-analysis">source</a>).</p>
<p>This reduction in dimensionality, for example from 10,000 cells x
19,000 genes to 20 PCs, allows us to select PCs that are more likely to
correspond to biological variation related to the expected cell
types/subtypes and make the downstream clustering computationally
feasible.</p>
<blockquote>
<h4 id="more-context-using-pca-for-single-cell-data"
class="unlisted unnumbered">More context using PCA for single-cell
data</h4>
<p>To read more on PCA, please refer to the <a
href="https://hbctraining.github.io/scRNA-seq_online/lessons/05_theory_of_PCA.html">HBC
- Theory of PCA content</a>, from which this section is adapted and the
original source material for that content, specifically <a
href="https://www.youtube.com/watch?v=_UVHneBUBW0">Josh Starmer’s
StatQuest video</a>.</p>
<p>For additional detail on , the OSCA chapter on <a
href="https://bioconductor.org/books/3.15/OSCA.basic/dimensionality-reduction.html">Principal
components analysis</a> includes a more descriptive overview.</p>
</blockquote>
<div id="sparsity-in-single-cell-data" class="section level3">
<h3>Sparsity in single-cell data</h3>
<p>In addition to the “high-dimensionality” expected for single-cell
data, we expect the data to be both “sparse” and “noisy”. Sparse in the
sense that many genes will either not be expressed or not measured in
many of the cells and have zero values. Noisy due to biological
variability and the practical limitations of both capture and sequencing
depth <a
href="https://ouyanglab.com/singlecell/basic.html#a-gentle-introduction-to-dr">(source)</a>.</p>
<blockquote>
<p><em>Note on zero “inflation” of single-cell data</em></p>
<p>Single-cell data is sometimes described as “zero inflated”, however
work by <a
href="https://www.biorxiv.org/content/10.1101/582064v1.full">Svensson</a>
has challenged that characterization and argued that the higher number
of zeros observed in scRNA-seq compared to bulk RNA-seq is more likely
due to biological variance and lower sequencing saturation than
technical artifacts. Work by <a
href="https://genomebiology.biomedcentral.com/articles/10.1186/s13059-020-02103-2">Choi
et al. (2020)</a> support that zeros in single-cell data are due to
biology but <a
href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8783472/">Jiang et
al. (2022)</a> delves more into the “controversy” zero inflation,
including common approaches for handling zeros and the downstream
impacts.</p>
</blockquote>
<p>For sparse, high-dimensional, <em>biological</em> data, we expect
many genes to have correlated expression as they would be impacted by
the same biological process and for other genes to have either low (more
noisy) or similar expression across the cell population and therefore
not likely to correspond to cell-type/subtypes.</p>
<p>So how do we determine what and how many genes to use before
classifying cells into clusters based on their expression?</p>
<details>
<summary>
<em>More detail on dimensionality reduction </em>
</summary>
The <a
href="https://ouyanglab.com/singlecell/basic.html#a-gentle-introduction-to-dr">Ouyang
Lab has a “gentle introduction” section of their materials</a> that goes
into greater details on dimensionality reduction including how similar
strategies are used in deep learning models. Additionaly, the OSCA book
has a <a
href="https://bioconductor.org/books/3.15/OSCA.basic/dimensionality-reduction.html">chapter
on Dimensionality reduction</a> that has useful context.
</details>
<p><br></p>
<p><br></p>
</div>
</div>
</div>
<div id="run-pca-on-our-dataset" class="section level1">
<h1>Run PCA on our dataset</h1>
<!--- Add introduction to function, including link to documentation --->
<p>Since PCA is sensitive to scale, we will run it on the SCT normalized
assay (<a
href="https://ouyanglab.com/singlecell/basic.html#pca-principal-component-analysis">reference</a>).
We will name the reduction in an informative way to keep them clear for
us in the future. In this case, our data has not yet been integrated,
but it has been SCT normalized. So we will name the reduction
<code>unintegrated.sct.pca</code>. Note that <code>SCTTransform()</code>
returned a set of highly variable genes, and the <code>RunPCA()</code>
function will use this subset to determine the PCs and genes associated
with those PCs.</p>
<pre class="r"><code># Build a PCA and add it to the Seurat object  ----------------------------

geo_so = RunPCA(geo_so, reduction.name = &#39;unintegrated.sct.pca&#39;)
geo_so</code></pre>
<pre><code>An object of class Seurat 
46955 features across 31560 samples within 2 assays 
Active assay: SCT (20466 features, 3000 variable features)
 3 layers present: counts, data, scale.data
 1 other assay present: RNA
 1 dimensional reduction calculated: unintegrated.sct.pca</code></pre>
<p>After running the command in the console, we should see that the
<code>geo_so</code> Seurat object has a new reduction. Viewed in our
running schematic:</p>
<div class="float">
<img src="images/seurat_schematic/Slide6.png"
alt="Image: Schematic after RunPCA()." />
<div class="figcaption">Image: Schematic after RunPCA().</div>
</div>
<p>We can then visualize the first several PCs using the
<code>DimHeatmp()</code> function, which orders both cells and features
(genes) according to their PCA scores and allows us to see some general
patterns in the data. Here we will specify that the first 24 PCs be
included in the figure and that 500 cells are randomly subsetted for the
plot. <em>Note - you may need to increase your plot window size to
resolve errors regarding figure margins.</em></p>
<pre class="r"><code># Build heatmaps of PCAs  -------------------------------------------------

# Plot cell by gene heatmaps for first several PCs
DimHeatmap(geo_so, dims=1, cells=500, balanced=TRUE, reduction = &#39;unintegrated.sct.pca&#39;) # look at first PC alone first
DimHeatmap(geo_so, dims=1:18, cells=500, balanced=TRUE, reduction = &#39;unintegrated.sct.pca&#39;) # first 18 PCs

# note - need to use png() to write to file because this isn&#39;t a ggplot
png(filename = &#39;results/figures/qc_pca_heatmap.png&#39;, width = 12, height = 40, units = &#39;in&#39;, res = 300)
  DimHeatmap(geo_so, dims=1:18, cells=500, balanced=TRUE, reduction = &#39;unintegrated.sct.pca&#39;)
dev.off()</code></pre>
<div class="figure" style="text-align: center">
<img src="images/curriculum/04-PCAandIntegration/04-pca_heatmap_one-1.png" alt="DimHeatmap for PC1 alone" width="50%" />
<p class="caption">
DimHeatmap for PC1 alone
</p>
</div>
<div class="figure" style="text-align: center">
<img src="images/curriculum/04-PCAandIntegration/04-pca_heatmap_18-1.png" alt="DimHeatmap for PC1-18" width="816" />
<p class="caption">
DimHeatmap for PC1-18
</p>
</div>
<p>As we scroll down in this plot, we see less and less structure in our
plots indicating that no only is less variation is being represented by
larger PCs overall but also that those PCs are less likely to correspond
to variation of interest, e.g. corresponding to cell types/subtypes.</p>
<details>
<summary>
<em>What genes are contributing the most to each PC?</em>
</summary>
<p>We can also visualize the loadings for genes contributing to each
principal components using Seurat provided functions <a
href="https://holab-hku.github.io/Fundamental-scRNA/downstream.html#perform-linear-dimensional-reduction">source</a>.</p>
<p>We can highlight genes loaded for dimenstions of interest using using
<code>VizDimLoadings()</code>:</p>
<pre class="r"><code># Gene loadings for PC1 and PC2  ------------------------------------------
VizDimLoadings(geo_so, dims = 1:2, reduction = &#39;unintegrated.sct.pca&#39;)
ggsave(filename = &#39;results/figures/qc_pca_loadings.png&#39;, width = 12, height = 6, units = &#39;in&#39;)</code></pre>
<img src="images/curriculum/04-PCAandIntegration/04-pca_loading_plot-1.png" width="816" style="display: block; margin: auto;" />
</details>
<p><br> </br></p>
<blockquote>
<h4 id="how-does-seurat-use-pca-scores" class="unlisted unnumbered">How
does Seurat use PCA scores?</h4>
<p>Per the <a
href="https://holab-hku.github.io/Fundamental-scRNA/downstream.html#perform-linear-dimensional-reduction">Ho
Lab’s materials</a> - “To overcome the extensive technical noise in any
single feature for scRNA-seq data, Seurat clusters cells based on their
PCA scores, with each PC essentially representing a ‘metafeature’ that
combines information across a correlated feature set. The top principal
components therefore represent a robust compression of the dataset.”
<!-- Note, may want to edit/remove above section --></p>
</blockquote>
<div id="visualizing-relative-contributions-of-each-pc"
class="section level3">
<h3>Visualizing relative contributions of each PC</h3>
<p>One way to evaluate the PCs to include is by looking at an elbow
plot, which shows the percent variance explained by successive PCs.
We’ll use the <code>ElbowPlot()</code> function to do this, specifying
that the first 50 PCs be plotted.</p>
<pre class="r"><code># Elbow plot help visualize how many PCs to include -----------------------

ElbowPlot(geo_so, ndims = 50, reduction = &#39;unintegrated.sct.pca&#39;)
ggsave(filename = &#39;results/figures/qc_sct_elbow_plot.png&#39;, width = 8, height = 8, units = &#39;in&#39;)</code></pre>
<p><img src="images/curriculum/04-PCAandIntegration/04-elbow_plot-1.png" width="80%" style="display: block; margin: auto;" /></p>
<p>In this plot, we could arbitrarily choose a number along the x-axis
that looks like a sharp change in the variance from one PC to the next,
that is, an elbow. Of course, while that’s often the recommendation in
tutorials, the choice of where the point of the “elbow” is, is not
always obvious, and this plot is no different. We could also try to
quantify our choice.</p>
</div>
<div
id="choosing-the-number-of-significant-pcs-for-dimensionality-reduction"
class="section level2">
<h2>Choosing the number of significant PCs for dimensionality
reduction</h2>
<!-- Section may still need to be edited more & consider adding a figure -->
<p>As we discussed above, we don’t want to use all the PCs generated for
a single cell data set but instead want to select a subset to limit the
downstream steps to variation that’s more likely to correspond to cell
types or subtypes. So how many PCs should be used?</p>
<p>A good starting point for determining how many PCs to select for your
single-cell analysis is to understand the “resolution” of your
biological question. Is answering your biological question dependent on
identifying rarer cell types or specific subtypes? Or are broader
cell-types more relevant?</p>
<p>For this dataset, we are expecting a diversity of cell types and cell
populations that mediate wound healing, but are also that are part of
the aberrant transition to bone, which might be more rare in the
population. So for this dataset, we might want to consider starting with
more PCS rather than too few PCs to start. Again, in a full analysis
workflow, our selection at this step might be more of a starting point
for further iterations than a final decision.</p>
<!-- Section may need more editing
Related - how important is that decision to the downstream impact (e.g. how much does changing the number of PCs change the clustering)?
-->
<div id="using-a-crude-optimization-to-select-a-starting-point"
class="section level3">
<h3>Using a (crude) optimization to select a starting point</h3>
<p>Instead of choosing based on the elbow plot by sight alone, we can
try to quantify our choice. Here we create a function to return a
minimum PCs based on two possible metrics (cumulative variation or above
a minium step size) and then we’ll apply that function to our data:</p>
<pre class="r"><code># Function to determine optimal PCs to include ----------------------------

optimal_pcs = function(so, reduction) {
    # quantitative check for number of PCs to include
    pct = so@reductions[[reduction]]@stdev / sum(so@reductions[[reduction]]@stdev) * 100
    cum = cumsum(pct)
    co1 = which(cum &gt; 90 &amp; pct &lt; 5)[1]
    co2 = sort(which((pct[1:length(pct)-1] - pct[2:length(pct)]) &gt; .1), decreasing = T)[1] + 1
    pcs = min(co1, co2) 
    
    return(pcs)
}

# Apply function to our data
pcs = optimal_pcs(geo_so, &#39;unintegrated.sct.pca&#39;)
pcs</code></pre>
<pre><code>[1] 16</code></pre>
<pre class="r"><code># Based on the heatmap, we&#39;ll modify to 13 PCs
pcs = 13</code></pre>
<p>Again, this number is likely a starting point and may need to be
revised depending on the outcome of the downstream steps.</p>
<blockquote>
<h4 id="other-more-quanitative-parameter-selection-options"
class="unlisted unnumbered">Other more quanitative parameter selection
options</h4>
<p>While outside the scope of this workshop, there are community efforts
to develop more sophisticated methods to select an appropriate number of
PCs, like the <a href="https://github.com/rbpatt2019/chooseR">chooseR
package</a> <a
href="https://academic.oup.com/bioinformatics/article/38/10/2949/6565314">findPC
package</a> or <a
href="https://lazappi.id.au/posts/2017-07-19-building-a-clustering-tree/">using
clustering trees</a> to evaluate the stability of parameter choices.</p>
</blockquote>
</div>
<div id="visualizing-our-pc-results" class="section level3">
<h3>Visualizing our PC results</h3>
<p>In addition to selecting a reduced number of PCs to represent our
data, we can also visualize , similarly to how we often look at samples
for bulk RNA-seq using the <code>DimPlot()</code> function, with each
cell plotted along the selected PCs and colored by a selected meta-data
column:</p>
<pre><code>?DimPlot # default dims = c(1,2)</code></pre>
<pre class="r"><code># PCA style plot for PC1 and PC2 (unintegrated) --------------------------- 

DimPlot(geo_so, reduction = &#39;unintegrated.sct.pca&#39;, group.by = &#39;orig.ident&#39;) # first label by sample
DimPlot(geo_so, reduction = &#39;unintegrated.sct.pca&#39;, group.by = &#39;day&#39;) # then label by day
ggsave(filename = &#39;results/figures/qc_pca_plot_unintegrated_sct_day.png&#39;, width = 7, height = 6, units = &#39;in&#39;) # save </code></pre>
<p><img src="images/curriculum/04-PCAandIntegration/04-pca_loading_plots-1.png" width="816" style="display: block; margin: auto;" /><img src="images/curriculum/04-PCAandIntegration/04-pca_loading_plots-2.png" width="816" style="display: block; margin: auto;" /></p>
<p>In the first plot with each cell labeled by the original sample name,
it looks like there might be some batches but it’s hard to distinguish.
From the second by <code>day</code>, we can see that even after
normalization there seems to be variation that corresponds more to a
batch effect related to the day status than interesting biological
variation. This suggests that clustering our data using our selected
number of PCs, integration should be performed to mitigate these
differences and better align our data.</p>
</div>
</div>
</div>
<div id="integrate-layers" class="section level1">
<h1>Integrate Layers</h1>
<p>Based on our PCA plot and often a standard part of multiple sample
scRNA-seq analysis, we will integrate our data across all samples.
Currently, each sample is stored as a layer in our <code>geo_so</code>
object, Since earlier in the workshop, we used
<code>SCTransform()</code> to normalize our data, select variable genes
and then have generated a PCA reduction, we can use the
<code>IntegrateLayers()</code> function to do that.</p>
<div class="float">
<img
src="images/curriculum/04-PCAandIntegration/HBC-CCA-Integration_simplified.png"
alt="CCA integration illustration, modified from Stuart and Butler, 2018 -https://doi.org/10.1101/460147" />
<div class="figcaption">CCA integration illustration, modified from
Stuart and Butler, 2018 -<a href="https://doi.org/10.1101/460147"
class="uri">https://doi.org/10.1101/460147</a></div>
</div>
<p>The details of how integration works depends on the method, but for
the RPCA approach that we’ll be using here - the process is similar to
the canonical correlation analysis (CCA) approach illustration above <a
href="https://www.biorxiv.org/content/10.1101/2021.08.04.453579v1.full.pdf">(source)</a>.
However, RPCA is more efficient (faster) to run and better preserves
distinct cell identities between samples <a
href="https://www.nature.com/articles/s41592-021-01336-8">(source)</a>.
As described in the corresponding <a
href="https://satijalab.org/seurat/articles/integration_rpca.html">Seurat
tutorial</a>, each dataset is projected into the others’ PCA space and
constrain the anchors</p>
<p>New to Seurat v5 are improvements that make selecting different
integration methods much easier. The results of each alternative
integration method are stored within the same <code>Seurat</code>
object, which makes comparing downstream effects much easier. So, if we
wanted to run the <code>RPCAIntegration</code> method, we would run
(<strong>but we won’t here</strong>):</p>
<pre class="r"><code>### DO NOT RUN ###
geo_so = IntegrateLayers(
  object = geo_so, 
  method = RPCAIntegration, 
  orig.reduction = &#39;unintegrated.sct.pca&#39;,
  normalization.method = &#39;SCT&#39;,
  new.reduction = &#39;integrated.sct.rpca&#39;)</code></pre>
<p>The Seurat v5 vignette on integrative analysis (<a
href="https://satijalab.org/seurat/articles/seurat5_integration#perform-streamlined-one-line-integrative-analysis">link</a>)
provides examples of each integration method. Note, that the vignette
code uses the <code>NormalizeData()</code>, <code>ScaleData()</code>,
<code>FindVariableFeatures()</code> pipeline, so their
<code>IntegrateLayers()</code> call does not include
<code>normalization.method = 'SCT'</code>, as ours must.</p>
<p>Note we have specified the unintegrated reduction
<code>unintegrated.sct.pca</code>, which is what
<code>IntegrateLayers()</code> operates on, along with the
<code>SCT</code> assay. Let’s take a look to see what’s different about
the <code>Seurat</code> object:</p>
<blockquote>
<p><strong>Load integrated data</strong></p>
<p>Because the <code>IntegrateLayers()</code> function takes a while to
run, we will simply load the RPCA integrated <code>geo_so</code> object
from a file we have previously generated.</p>
<pre class="r"><code>geo_so = readRDS(&#39;/home/workshop/rcavalca/ISC_R/results/rdata/geo_so_sct_integrated.rds&#39;)</code></pre>
</blockquote>
<pre class="r"><code># Check our updated object that we&#39;ve read in from file ------------------- 

# Observe that we now have a new reduction, `integrated.sct.rpca`
geo_so </code></pre>
<pre><code>An object of class Seurat 
46955 features across 31560 samples within 2 assays 
Active assay: SCT (20466 features, 3000 variable features)
 3 layers present: counts, data, scale.data
 1 other assay present: RNA
 2 dimensional reductions calculated: unintegrated.sct.pca, integrated.sct.rpca</code></pre>
<p>Viewed in our running schematic:</p>
<div class="float">
<img src="images/seurat_schematic/Slide7.png"
alt="Image: Schematic after IntegrateLayers()." />
<div class="figcaption">Image: Schematic after IntegrateLayers().</div>
</div>
<p>We can also confirm that our integration method has helped to correct
the <code>Day</code> effects we saw in the initial PCA plots</p>
<pre class="r"><code># PCA style plot for PC1 and PC2 (integrated) -----------------------------
DimPlot(geo_so, reduction = &#39;integrated.sct.rpca&#39;, group.by = &#39;day&#39;)
ggsave(filename = &#39;results/figures/qc_pca_plot_integrated_sct_day.png&#39;, width = 7, height = 6, units = &#39;in&#39;)</code></pre>
<p><img src="images/curriculum/04-PCAandIntegration/04-check_integration-1.png" width="816" style="display: block; margin: auto;" /></p>
<!--- confirmed in testing that PCA plot is updated if run on catched geo_so object --->
</div>
<div id="save-our-progress" class="section level1">
<h1>Save our progress</h1>
<p>Before we move on, let’s save our updated Seurat object to file:</p>
<pre class="r"><code># Save updated seurat object to file  -------------------------------------
saveRDS(geo_so, file = &#39;results/rdata/geo_so_sct_integrated.rds&#39;)</code></pre>
<blockquote>
<p><strong>Other integration methods</strong></p>
<p>After normalizing the data with <code>SCTransform()</code> and
performed the dimension reduction with <code>RunPCA()</code>,
alternatively we could also use the <code>CCA</code> integration method
with:</p>
<pre class="r"><code>### DO NOT RUN ###
geo_so = IntegrateLayers(
    object = geo_so, 
    method = CCAIntegration, 
    orig.reduction = &#39;unintegrated.sct.pca&#39;,
    normalization.method = &#39;SCT&#39;,
    new.reduction = &#39;integrated.sct.cca&#39;)</code></pre>
</blockquote>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>In this section, we:</p>
<ul>
<li>Discussed how PCA is used in scRNA-seq analysis.</li>
<li>Demonstrated some visualizations after computing PCA.</li>
<li>Discussed how to decide how many PCs to use in downstream
analysis.</li>
<li>Integrated the data.</li>
</ul>
<p>Next steps: Clustering and projection</p>
<hr />
<p>These materials have been adapted and extended from materials listed
above. These are open access materials distributed under the terms of
the <a href="http://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution license (CC BY 4.0)</a>, which permits unrestricted
use, distribution, and reproduction in any medium, provided the original
author and source are credited.</p>
<br/> <br/>
<hr/>
<table style="width:100%;">
<colgroup>
<col width="28%" />
<col width="42%" />
<col width="28%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"><a href="03-Normalization.html">Previous
lesson</a></th>
<th align="center"><a href="#top">Top of this lesson</a></th>
<th align="right"><a href="05-ProjectionAndClustering.html">Next
lesson</a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAiUENBIGFuZCBJbnRlZ3JhdGlvbiIKYXV0aG9yOiAiVU0gQmlvaW5mb3JtYXRpY3MgQ29yZSIKZGF0ZTogImByIFN5cy5EYXRlKClgIgpvdXRwdXQ6CiAgICAgICAgaHRtbF9kb2N1bWVudDoKICAgICAgICAgICAgaW5jbHVkZXM6CiAgICAgICAgICAgICAgICBpbl9oZWFkZXI6IGhlYWRlci5odG1sCiAgICAgICAgICAgIHRoZW1lOiBwYXBlcgogICAgICAgICAgICB0b2M6IHRydWUKICAgICAgICAgICAgdG9jX2RlcHRoOiA0CiAgICAgICAgICAgIHRvY19mbG9hdDogdHJ1ZQogICAgICAgICAgICBudW1iZXJfc2VjdGlvbnM6IGZhbHNlCiAgICAgICAgICAgIGZpZ19jYXB0aW9uOiB0cnVlCiAgICAgICAgICAgIG1hcmtkb3duOiBHRk0KICAgICAgICAgICAgY29kZV9kb3dubG9hZDogdHJ1ZQotLS0KCjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CmJvZHksIHRkIHsKICAgZm9udC1zaXplOiAxOHB4Owp9CmNvZGUucnsKICBmb250LXNpemU6IDEycHg7Cn0KcHJlIHsKICBmb250LXNpemU6IDEycHgKfQoKdGFibGUuZmlnLCB0aC5maWcsIHRkLmZpZyB7CiAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7CiAgYm9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsKICBwYWRkaW5nOiAxNXB4Owp9Cjwvc3R5bGU+CgpgYGB7ciBrbGlwcHksIGVjaG89RkFMU0UsIGluY2x1ZGU9VFJVRX0Ka2xpcHB5OjprbGlwcHkobGFuZyA9IGMoInIiLCAibWFya2Rvd24iLCAiYmFzaCIpLCBwb3NpdGlvbiA9IGMoInRvcCIsICJyaWdodCIpKQpgYGAKCmBgYHtyLCBpbmNsdWRlID0gRkFMU0V9CnNvdXJjZSgiLi4vYmluL2NodW5rLW9wdGlvbnMuUiIpCmtuaXRyX2ZpZ19wYXRoKCIwNC1QQ0FhbmRJbnRlZ3JhdGlvbi8wNC0iKQpgYGAKIyBXb3JrZmxvdyBPdmVydmlldyB7LnVubGlzdGVkIC51bm51bWJlcmVkfQoKPGJyLz4KPGltZyBzcmM9ImltYWdlcy93YXlmaW5kZXIvd2F5ZmluZGVyLnBuZyIgYWx0PSJ3YXlmaW5kZXIiIHN0eWxlPSJoZWlnaHQ6IDQwMHB4OyIvPgo8YnIvPgo8YnIvPgoKIyBJbnRyb2R1Y3Rpb24gCgpJbiB0aGlzIHNlY3Rpb24sIHdlIHdpbGwgdXNlIHByaW5jaXBhbCBjb21wb25lbnQgYW5hbHlzaXMgKFBDQSkgdG8gcmVkdWNlIHRoZSBkaW1lbnNpb25hbGl0eSBvZiB0aGUgZGF0YSwgZmlyc3QgYnkgZ3JvdXBpbmcgY29ycmVsYXRlZCBmZWF0dXJlcyBhbmQgc2Vjb25kIGJ5IGV4Y2x1ZGluZyBjb3JyZWxhdGVkIGZlYXR1cmVzIHRoYXQgYXJlIGxlc3MgbGlrZWx5IHRvIGNvcnJlc3BvbmQgdG8gaW50ZXJlc3RpbmcgYmlvbG9naWNhbCB2YXJpYW5jZS4KCjx0YWJsZSBjbGFzcz0nZmlnJz4KPHRyIGNsYXNzPSdmaWcnPjx0ZCBjbGFzcz0nZmlnJz4hW10oaW1hZ2VzL2dyYXBoaWNhbF9hYnN0cmFjdHMvZ3JhcGhpY2FsX2Fic3RyYWN0X3BjYS5wbmcpPC90ZD48L3RyPgo8dHIgY2xhc3M9J2ZpZyc+PHRkIGNsYXNzPSdmaWcnPkEuIENsdXN0ZXJpbmcgdGhlIGV4cHJlc3Npb24gcGF0dGVybnMgZGlyZWN0bHkgb24gdGhlIGZlYXR1cmUtYmFyY29kZSBjb3VudCBtYXRyaXggaXMgaW1wcmFjdGljYWwgYmVjYXVzZSB0aGUgZXhwcmVzc2lvbiBwYXR0ZXJucyBpbiB0aGUgY291bnRzIGFyZSBvZnRlbiB3ZWFrLCByZXBldGl0aXZlLCBhbmQgZGlmZnVzZSAoc2NhdHRlcmVkIGFjcm9zcyBtYW55LCBtYW55IGdlbmVzKS4gQWxzbyBjbHVzdGVyaW5nIGNlbGxzIGFjcm9zcyAyMGsgZGltZW5zaW9ucyAoaS5lLiAyMGsgZ2VuZXMpIGlzIGV4dHJlbWVseSBjb21wdXRhdGlvbmFsbHkgaW50ZW5zaXZlLjxici8+CkIuIFByaW5jaXBhbCBDb21wb25lbnQgQW5hbHlzaXMgY29uc2lkZXJzIChQQ0EpIHRoZSBjb3VudCBkYXRhIGZyb20gbmV3IG9yaWVudGF0aW9ucyB0aGF0IG1heGltaXplIHRoZSB2YXJpYW5jZSBhY3Jvc3MgdGhlIGRhdGEuIEluIHRoaXMgd2F5LCBQQ0EgcmVwbGFjZXMgdGhlIG9yaWdpbmFsIGNvdW50IG1hdHJpeCB3aXRoIG5ldyBtYXRyaXggb2YgcHJpbmNpcGFsIGNvbXBvbmVudCAoUEMpIHZhbHVlcyBmb3IgZWFjaCBjZWxsLjxici8+CkMuIEJlY2F1c2UgUENBIHJhbmtzIHRoZSBQQ3MgZnJvbSBtb3N0IHZhcmlhbmNlIHRvIGxlYXN0LCB0aGUgdHJ1bHkgZGlzY3JpbWluYXRpbmcgUENzIHdpbGwgYmUgYSBzbWFsbCBzdWJzZXQgb2YgdG9wLW1vc3QgUENzLiBGb2N1c2luZyBvbmx5IG9uIHRoZSB0b3AgMTAtMzAgUENzIGluc3RlYWQgb2YgMjBrIGdlbmVzIHRlbGxzIHRoZSBzYW1lIHN0b3J5LCBidXQgY3V0cyB0aHJvdWdoIDk5LjklIG9mIHRoZSBjbHV0dGVyIG1ha2luZyBjbHVzdGVyaW5nIGFib3V0IDEwMDB4IGZhc3Rlci4KPC90ZD48L3RyPgo8L3RhYmxlPgo8YnIvPgoKQWZ0ZXIgZmlsdGVyaW5nIGFuZCBub3JtYWxpemF0aW9uLCBvdXIgbmV4dCBnb2FsIGlzIHRvIGNsdXN0ZXIgdGhlIGNlbGxzIGFjY29yZGluZyB0byB0aGVpciBleHByZXNzaW9uIHByb2ZpbGVzLiBIb3dldmVyLCBldmVuIGFmdGVyIGZpbHRlcmluZywgd2UgZXhwZWN0IHRvIGhhdmUgYWJvdXQgMjAsMDAwIGNlbGxzIGFzc2F5ZWQgd2l0aCBhcHByb3hpbWF0ZWx5IDIxLDAwMCBnZW5lcyBtZWFzdXJlZCBwZXIgY2VsbC4gVGhpcyBtZWFucyB0aGF0IHdlIGFyZSB3b3JraW5nIHZlcnkgImhpZ2gtZGltZW5zaW9uYWwiIGRhdGEuIAoKSGlnaCBkaW1lbnNpb25hbCBkYXRhIHByZXNlbnRzIHR3byBjaGFsbGVuZ2VzOgoKLSBUaGUgc2NhbGUgb2YgdGhlIGRhdGEgbWFrZXMgYW5hbHlzaXMgc3RlcHMgY29zdGx5IGFuZCBzbG93ICAgICAKLSBUaGVyZSBpcyBsaWtlbHkgdW5pbnRlcmVzdGluZyB2YXJpYXRpb24gYWNyb3NzIG91ciBkYXRhIHRoYXQgd2Ugd2FudCB0byBleGNsdWRlICAgIAoKClNpbWlsYXIgdG8gdGhlIHByZXZpb3VzIHNlY3Rpb25zLCB0aGUgcHJvY2VzcyBvZiBwYXJhbWV0ZXIgc2VsZWN0aW9uIGFmdGVyIFBDQSBpcyBvZnRlbiBpdGVyYXRpdmUgYW5kIHdoaWxlIHdlIHdpbGwgYmUgc2hvd2luZyBhIHNpbmdsZSBvcHRpb24sIG11bHRpcGxlIHBhcmFtZXRlciBjaG9pY2VzIG1heSBuZWVkIHRvIGJlIHRlc3RlZC4gIAoKCiMjIE9iamVjdGl2ZXMKCi0gVW5kZXJzdGFuZCB3aHkgUENBIGlzIHVzZWQgdG8gcmVkdWNlIGhpZ2gtZGltZW5zaW9uYWwgc2luZ2xlLWNlbGwgZGF0YSBwcmlvciB0byBpbnRlZ3JhdGlvbiBhbmQgY2x1c3RlcmluZyAgIAotIFVzZSB0aGUgYFJ1blBDQSgpYCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBwcmluY2lwYWwgY29tcG9uZW50cyBmb3Igb3VyIGRhdGEgICAgCi0gQ2hvb3NlIGFuIGFwcHJvcHJpYXRlIG51bWJlciBvZiBwcmluY2lwYWwgY29tcG9uZW50cyB0byBjYXB0dXJlIHZhcmlhbmNlIGluIG91ciBkYXRhICAgCi0gVXNlIGBJbnRlZ3JhdGVMYXllcnNgIHRvIGludGVncmF0ZSBhY3Jvc3Mgb3VyIGRhdGEgcHJpb3IgdG8gY2x1c3RlcmluZyAgIAoKLS0tCgpgYGB7ciwgcmVhZF9yZHNfaGlkZGVuLCBlY2hvID0gRkFMU0UsIHdhcm5pbmcgPSBGQUxTRSwgbWVzc2FnZSA9IEZBTFNFfQppZighZXhpc3RzKCdnZW9fc28nKSkgewogIGxpYnJhcnkoU2V1cmF0KQogIGxpYnJhcnkoQlBDZWxscykKICBsaWJyYXJ5KHRpZHl2ZXJzZSkKCiAgb3B0aW9ucyhmdXR1cmUuZ2xvYmFscy5tYXhTaXplID0gMWU5KQoKICBnZW9fc28gPSByZWFkUkRTKCdyZXN1bHRzL3JkYXRhL2dlb19zb19zY3Rfbm9ybWFsaXplZC5yZHMnKQp9CmBgYAoKCjwhLS1CZWZvcmUgdGhpcyBzZWN0aW9uIC0gRGF5IDE6IFN0YXJ0aW5nIHcvIFNldXJhdCwgSW5pdGlhbCBRQywgJiBCYXRjaCBjb3JyZWN0aW9uIChTQ3RyYW5zZm9ybSktLT4KCjwhLS1JbnN0cnVjdGlvbiBOb3RlOiBVc2luZyBpbnRlZ3JhdGVkIGRhdGEgaGVyZSBhbmQgd2lsbCBjb21wYXJlIHRvIHVuaW50ZWdyYXRlZCByZXN1bHRzIGluIG5leHQgc2VjdGlvbiwgc2ltaWxhciB0byAgW2hlcmVdKGh0dHBzOi8vYm1jYmlvaW5mb3JtYXRpY3MuYmlvbWVkY2VudHJhbC5jb20vYXJ0aWNsZXMvMTAuMTE4Ni9zMTI4NTktMDIxLTAzOTU3LTQpPy0tPgoKCgojIFdoYXQgaXMgUENBPwoKPCEtLS0gR2l2ZSBzb21lIGNvbnRleHQgYW5kIGJhY2tncm91bmQgb24gUENBCi0gV2hhdCBpcyBQQ0EKLSBXaHkgZG8gd2UgdXNlIGl0IAotLS0+Cgo8IS0tLSBhZGQgUENBIGlsbHVzdHJhdGlvbiBoZXJlPyAtLS0+CkluIHByYWN0aWNhbCB0ZXJtcywgUHJpbmNpcGFsIGNvbXBvbmVudCBhbmFseXNpcyAoUENBKSBjcmVhdGVzIGEgc2ltcGxlciwgbW9yZSBjb25jaXNlIHZlcnNpb24gb2YgZGF0YSB3aGlsZSBwcmVzZXJ2aW5nIHRoZSBzYW1lICJzdG9yeSIuIEZvciBleGFtcGxlLCB3ZSBjYW4gdGhpbmsgb2YgYSBmdWxsIHNpbmdsZS1jZWxsIGRhdGEgc2V0IGFzIHNpbWlsYXIgdG8gdGhlIGZ1bGwgTG9yZCBvZiB0aGUgUmluZ3MgdHJpbG9neSAtIGxhcmdlIGFuZCBjb21wbGV4IHdpdGggcXVpdGUgYSBiaXQgb2YgZGV0YWlsIHRoYXQgbWlnaHQgYmUgcmVwZWF0ZWQgYW5kIGlzbid0IG5lY2Vzc2FyeSB0byB1bmRlcnN0YW5kIHRoZSBvdmVyYWxsIHBsb3QgYW5kIG1ha2UgcnVubmluZyB0aGUgYW5hbHlzaXMgcHJvaGliaXRpdmVseSBzbG93IGFuZCBjb3N0bHkuIAoKTGlrZSBhIENsaWZmIG5vdGVzIHZlcnNpb24gb3IgYSBtb3ZpZSBwaXRjaCBmb3IgdGhlIGJvb2sgc2VyaWVzLCB0aGUgUENzIGNhcHR1cmUgY29ycmVsYXRlZCBleHByZXNzaW9uIGFuZCByZWR1Y2UgdGhlIHNpemUgYW5kIGNvbXBsZXhpdHkgb2YgdGhlIGRhdGEsIHdoaWxlIHN0aWxsIGFsbG93aW5nIHRoZSBvdmVyYWxsIHN0cnVjdHVyZSBvZiB0aGUgZGF0YSAtIHRoYXQgd2Ugd291bGQgZXhwZWN0IHRvIGJlIHJlbGF0ZWQgdG8gY2VsbC10eXBlcyBvciBwbG90IHBvaW50cyBpbiB0aGUgYW5hbG9neSAtIHRvIGJlIHJlcHJlc2VudGVkLCB3aGlsZSBhbHNvIG1ha2luZyB0aGUgY29tcHV0YXRpb24gZmFzdGVyLgoKIVtdKC4vaW1hZ2VzL2N1cnJpY3VsdW0vMDQtUENBYW5kSW50ZWdyYXRpb24vUENBX3B1cnBvc2UucG5nKQoKIyMjIFBDQSBleGFtcGxlCgpUbyB1bmRlcnN0YW5kIGhvdyBQQ0Egd29ya3MgZm9yIHNpbmdsZS1jZWxsIGRhdGEsIHdlIGNhbiBjb25zaWRlciBhIHNtYWxsZXIgZGF0YXNldCBtZWFzdXJpbmcgdGhlIGV4cHJlc3Npb24gb2YgZm91ciBnZW5lcyBtZWFzdXJlZCBpbiBqdXN0IHR3byBjZWxscywgd2UgY291bGQgcGxvdCB0aGUgZXhwcmVzc2lvbiBvZiB0aG9zZSBmb3VyIGdlbmVzLCB3aXRoIGRhdGEgZnJvbSBvbmUgY2VsbCBwbG90dGVkIG9uIHRoZSB4LWF4aXMgYW5kIHRoZSBzZWNvbmQgY2VsbCBwbG90dGVkIG9uIHRoZSB5LWF4aXMuCgohW0Egc2ltcGxlIFBDQSBleGFtcGxlIChmcm9tIEhCQyldKC4vaW1hZ2VzL2N1cnJpY3VsdW0vMDQtUENBYW5kSW50ZWdyYXRpb24vSEJDLVBDQV8yc2FtcGxlX2dlbmVzLnBuZykKPCEtLS0gVXBkYXRlIHBsb3QgdG8gcmVwbGFjZSAiU2FtcGxlIiB3aXRoICJjZWxsIiBpbiBmaWd1cmUgYW5kIHRhYmxlIC0tLT4KCklmIHdlIHdhbnRlZCB0byByZXByZXNlbnQgdGhlIG1vc3QgdmFyaWF0aW9uIGFjcm9zcyB0aGUgZGF0YSwgd2Ugd291bGQgZHJhdyBhIGRpYWdvbmFsIGxpbmUgYmV0d2VlbiBnZW5lIEIgYW5kIGdlbmUgQyAtIHRoaXMgd291bGQgcmVwcmVzZW50IHRoZSBmaXJzdCBwcmluY2lwYWwgY29tcG9uZW50IChQQykuIEhvd2V2ZXIsIHRoaXMgbGluZSBkb2Vzbid0IGNhcHR1cmUgYWxsIHRoZSB2YXJpYW5jZSBpbiB0aGlzIGRhdGEgYXMgdGhlIGdlbmVzIGFsc28gdmFyeSBhYm92ZSBhbmQgYmVsb3cgdGhlIGxpbmUsIHNvIHdlIGNvdWxkIGRyYXcgYW5vdGhlciBsaW5lIChhdCBhIHJpZ2h0IGFuZ2xlIHRvIHRoZSBmaXJzdCkgcmVwcmVzZW50aW5nIHRoZSBzZWNvbmQgbW9zdCB2YXJpYXRpb24gaW4gdGhlIGRhdGEgLSB3aGljaCB3b3VsZCByZXByZXNlbnQgdGhlIHNlY29uZCBwcmluY2lwYWwgY29tcG9uZW50IChQQykuIAoKIVtQQ0EgZ2VuZSBsb2FkaW5ncyAoZnJvbSBIQkMpXSguL2ltYWdlcy9jdXJyaWN1bHVtLzA0LVBDQWFuZEludGVncmF0aW9uL0hCQy1QQ0FfMnNhbXBsZV92YXJpYXRpb24zLnBuZykKPCEtLS0gVXBkYXRlIHBsb3QgdG8gcmVwbGFjZSAiU2FtcGxlIiB3aXRoICJjZWxsIiBpbiBmaWd1cmUgLS0tPiAKCjwhLS0tIDxDb25zaWRlciBtb3ZpbmcgdG8gZHJvcGRvd24gYW5kIGFkZGluZyBmaWd1cmUgdG8gc2hvdyBsb2FkaW5ncz4gSG93ZXZlciwgYXMgd2UgY2FuIHNlZSBpbiB0aGUgZXhhbXBsZSBiZWxvdywgZ2VuZXMgbmVhciB0aGUgZW5kIG9mIGVhY2ggbGluZSBhcmUgdGhvc2Ugd2l0aCB0aGUgZ3JlYXRlc3QgaW5mbHVlbmNlIG9uIHRoZSBkaXJlY3Rpb24gYW5kIGxlbmd0aCBvZiB0aGUgUEMuLS0+CgoKV2UnbGwgc2tpcCB0aGUgcHJvY2VzcyBvZiBnZW5lcmF0aW5nIGFsbCBwb3NzaWJsZSBQQ3MsIGJ1dCBydW5uaW5nIFBDQSBvbiBvdXIgZGF0YSB3aWxsIHJlc3VsdCBpbiBhIHNjb3JlIGZvciBlYWNoIGNlbGwgZm9yIGVhY2ggUEMgYW5kIGVhY2ggZ2VuZSB3aWxsIGhhdmUgYSB3ZWlnaHQgb3IgbG9hZGluZyBmb3IgYSBnaXZlbiBQQy4gQnkgZGVmaW5pdGlvbiwgdGhlIFBDcyBjYXB0dXJlIHRoZSBncmVhdGVzdCBmYWN0b3JzIG9mIGhldGVyb2dlbmVpdHkgaW4gZGVjcmVhc2luZyBvcmRlciBpbiB0aGUgZGF0YSBzZXQgWyhzb3VyY2UpXShodHRwczovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xMy9PU0NBLmJhc2ljL2RpbWVuc2lvbmFsaXR5LXJlZHVjdGlvbi5odG1sI3ByaW5jaXBhbC1jb21wb25lbnRzLWFuYWx5c2lzKS4KCiMjIFdoeSBQQ0EgaXMgdXNlZnVsIGZvciBzaW5nbGUtY2VsbCBkYXRhCgpJbiBjb250cmFzdCB0byBidWxrIFJOQS1zZXEsIHdoZXJlIHRoZSBtYWpvcml0eSBvZiB0aGUgdmFyaWFuY2UgaW4gYSBnaXZlbiBkYXRhc2V0IGFyZSB1c3VhbGx5IGV4cGxhaW5lZCBieSB0aGUgZmlyc3QgYW5kIHNlY29uZCBQQywgZm9yIHNpbmdsZS1jZWxsIGRhdGEgd2UgZXhwZWN0IHRoYXQgbWFueSBtb3JlIFBDcyBhcmUgY29udHJpYnV0aW5nIHRvIHRoZSBvdmVyYWxsIHZhcmlhbmNlLiAKCkhvd2V2ZXIsIHdlIGNhbiBhc3N1bWUgdGhhdCBiaW9sb2dpY2FsIHByb2Nlc3NlcyBhZmZlY3QgbXVsdGlwbGUgZ2VuZXMgaW4gYSBjb29yZGluYXRlZCB3YXkuIFRoZXJlZm9yZSB0aGUgdG9wIFBDcyBsaWtlbHkgcmVwcmVzZW50IGJpb2xvZ2ljYWwgc3RydWN0dXJlIHJhdGhlciB0aGFuIHJhbmRvbSB0ZWNobmljYWwgb3IgYmlvbG9naWNhbCBub2lzZSwgd2hpY2ggYWZmZWN0cyBlYWNoIGdlbmUgaW5kZXBlbmRlbnRseSBhbmQgYW5kIHdlIGNhbiB1c2UgdGhlIHRvcCBzZXZlcmFsIFBDcyB0byBhcHByb3hpbWF0ZSB0aGUgZnVsbCBkYXRhIHNldCBpbiBkb3duc3RyZWFtIGFuYWx5c2lzIChbc291cmNlXShodHRwczovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xMi9PU0NBL2RpbWVuc2lvbmFsaXR5LXJlZHVjdGlvbi5odG1sI3ByaW5jaXBhbC1jb21wb25lbnRzLWFuYWx5c2lzKSkuCgpUaGlzIHJlZHVjdGlvbiBpbiBkaW1lbnNpb25hbGl0eSwgZm9yIGV4YW1wbGUgZnJvbSAxMCwwMDAgY2VsbHMgeCAxOSwwMDAgZ2VuZXMgdG8gMjAgUENzLCBhbGxvd3MgdXMgdG8gc2VsZWN0IFBDcyB0aGF0IGFyZSBtb3JlIGxpa2VseSB0byBjb3JyZXNwb25kIHRvIGJpb2xvZ2ljYWwgdmFyaWF0aW9uIHJlbGF0ZWQgdG8gdGhlIGV4cGVjdGVkIGNlbGwgdHlwZXMvc3VidHlwZXMgYW5kIG1ha2UgdGhlIGRvd25zdHJlYW0gY2x1c3RlcmluZyBjb21wdXRhdGlvbmFsbHkgZmVhc2libGUuCgo+ICMjIyMgTW9yZSBjb250ZXh0IHVzaW5nIFBDQSBmb3Igc2luZ2xlLWNlbGwgZGF0YSB7LnVubGlzdGVkIC51bm51bWJlcmVkfQo+Cj4gVG8gcmVhZCBtb3JlIG9uIFBDQSwgcGxlYXNlIHJlZmVyIHRvIHRoZSBbSEJDIC0gVGhlb3J5IG9mIFBDQSBjb250ZW50XShodHRwczovL2hiY3RyYWluaW5nLmdpdGh1Yi5pby9zY1JOQS1zZXFfb25saW5lL2xlc3NvbnMvMDVfdGhlb3J5X29mX1BDQS5odG1sKSwgZnJvbSB3aGljaCB0aGlzIHNlY3Rpb24gaXMgYWRhcHRlZCBhbmQgdGhlIG9yaWdpbmFsIHNvdXJjZSBtYXRlcmlhbCBmb3IgdGhhdCBjb250ZW50LCBzcGVjaWZpY2FsbHkgW0pvc2ggU3Rhcm1lcidzIFN0YXRRdWVzdCB2aWRlb10oaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1fVVZIbmVCVUJXMCkuCj4KPiBGb3IgYWRkaXRpb25hbCBkZXRhaWwgb24gLCB0aGUgT1NDQSBjaGFwdGVyIG9uIFtQcmluY2lwYWwgY29tcG9uZW50cyBhbmFseXNpc10oaHR0cHM6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzLzMuMTUvT1NDQS5iYXNpYy9kaW1lbnNpb25hbGl0eS1yZWR1Y3Rpb24uaHRtbCkgaW5jbHVkZXMgYSBtb3JlIGRlc2NyaXB0aXZlIG92ZXJ2aWV3LgoKIyMjIFNwYXJzaXR5IGluIHNpbmdsZS1jZWxsIGRhdGEKCkluIGFkZGl0aW9uIHRvIHRoZSAiaGlnaC1kaW1lbnNpb25hbGl0eSIgZXhwZWN0ZWQgZm9yIHNpbmdsZS1jZWxsIGRhdGEsIHdlIGV4cGVjdCB0aGUgZGF0YSB0byBiZSBib3RoICJzcGFyc2UiIGFuZCAibm9pc3kiLiBTcGFyc2UgaW4gdGhlIHNlbnNlIHRoYXQgbWFueSBnZW5lcyB3aWxsIGVpdGhlciBub3QgYmUgZXhwcmVzc2VkIG9yIG5vdCBtZWFzdXJlZCBpbiBtYW55IG9mIHRoZSBjZWxscyBhbmQgaGF2ZSB6ZXJvIHZhbHVlcy4gTm9pc3kgZHVlIHRvIGJpb2xvZ2ljYWwgdmFyaWFiaWxpdHkgYW5kIHRoZSBwcmFjdGljYWwgbGltaXRhdGlvbnMgb2YgYm90aCBjYXB0dXJlIGFuZCBzZXF1ZW5jaW5nIGRlcHRoIFsoc291cmNlKV0oaHR0cHM6Ly9vdXlhbmdsYWIuY29tL3NpbmdsZWNlbGwvYmFzaWMuaHRtbCNhLWdlbnRsZS1pbnRyb2R1Y3Rpb24tdG8tZHIpLgoKPiAqTm90ZSBvbiB6ZXJvICJpbmZsYXRpb24iIG9mIHNpbmdsZS1jZWxsIGRhdGEqCj4KPiBTaW5nbGUtY2VsbCBkYXRhIGlzIHNvbWV0aW1lcyBkZXNjcmliZWQgYXMgInplcm8gaW5mbGF0ZWQiLCBob3dldmVyIHdvcmsgYnkgW1N2ZW5zc29uXShodHRwczovL3d3dy5iaW9yeGl2Lm9yZy9jb250ZW50LzEwLjExMDEvNTgyMDY0djEuZnVsbCkgaGFzIGNoYWxsZW5nZWQgdGhhdCBjaGFyYWN0ZXJpemF0aW9uIGFuZCBhcmd1ZWQgdGhhdCB0aGUgaGlnaGVyIG51bWJlciBvZiB6ZXJvcyBvYnNlcnZlZCBpbiBzY1JOQS1zZXEgY29tcGFyZWQgdG8gYnVsayBSTkEtc2VxIGlzIG1vcmUgbGlrZWx5IGR1ZSB0byBiaW9sb2dpY2FsIHZhcmlhbmNlIGFuZCBsb3dlciBzZXF1ZW5jaW5nIHNhdHVyYXRpb24gdGhhbiB0ZWNobmljYWwgYXJ0aWZhY3RzLiBXb3JrIGJ5IFtDaG9pIGV0IGFsLiAoMjAyMCldKGh0dHBzOi8vZ2Vub21lYmlvbG9neS5iaW9tZWRjZW50cmFsLmNvbS9hcnRpY2xlcy8xMC4xMTg2L3MxMzA1OS0wMjAtMDIxMDMtMikgc3VwcG9ydCB0aGF0IHplcm9zIGluIHNpbmdsZS1jZWxsIGRhdGEgYXJlIGR1ZSB0byBiaW9sb2d5IGJ1dCBbSmlhbmcgZXQgYWwuICgyMDIyKV0oaHR0cHM6Ly93d3cubmNiaS5ubG0ubmloLmdvdi9wbWMvYXJ0aWNsZXMvUE1DODc4MzQ3Mi8pIGRlbHZlcyBtb3JlIGludG8gdGhlICJjb250cm92ZXJzeSIgemVybyBpbmZsYXRpb24sIGluY2x1ZGluZyBjb21tb24gYXBwcm9hY2hlcyBmb3IgaGFuZGxpbmcgemVyb3MgYW5kIHRoZSBkb3duc3RyZWFtIGltcGFjdHMuCgpGb3Igc3BhcnNlLCBoaWdoLWRpbWVuc2lvbmFsLCBfYmlvbG9naWNhbF8gZGF0YSwgd2UgZXhwZWN0IG1hbnkgZ2VuZXMgdG8gaGF2ZSBjb3JyZWxhdGVkIGV4cHJlc3Npb24gYXMgdGhleSB3b3VsZCBiZSBpbXBhY3RlZCBieSB0aGUgc2FtZSBiaW9sb2dpY2FsIHByb2Nlc3MgYW5kIGZvciBvdGhlciBnZW5lcyB0byBoYXZlIGVpdGhlciBsb3cgKG1vcmUgbm9pc3kpIG9yIHNpbWlsYXIgZXhwcmVzc2lvbiBhY3Jvc3MgdGhlIGNlbGwgcG9wdWxhdGlvbiBhbmQgdGhlcmVmb3JlIG5vdCBsaWtlbHkgdG8gY29ycmVzcG9uZCB0byBjZWxsLXR5cGUvc3VidHlwZXMuIAoKU28gaG93IGRvIHdlIGRldGVybWluZSB3aGF0IGFuZCBob3cgbWFueSBnZW5lcyB0byB1c2UgYmVmb3JlIGNsYXNzaWZ5aW5nIGNlbGxzIGludG8gY2x1c3RlcnMgYmFzZWQgb24gdGhlaXIgZXhwcmVzc2lvbj8KCjxkZXRhaWxzPgogICAgPHN1bW1hcnk+Kk1vcmUgZGV0YWlsIG9uIGRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbiAqPC9zdW1tYXJ5PgogICAgVGhlIFtPdXlhbmcgTGFiIGhhcyBhICJnZW50bGUgaW50cm9kdWN0aW9uIiBzZWN0aW9uIG9mIHRoZWlyIG1hdGVyaWFsc10oaHR0cHM6Ly9vdXlhbmdsYWIuY29tL3NpbmdsZWNlbGwvYmFzaWMuaHRtbCNhLWdlbnRsZS1pbnRyb2R1Y3Rpb24tdG8tZHIpIHRoYXQgZ29lcyBpbnRvIGdyZWF0ZXIgZGV0YWlscyBvbiBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24gaW5jbHVkaW5nIGhvdyBzaW1pbGFyIHN0cmF0ZWdpZXMgYXJlIHVzZWQgaW4gZGVlcCBsZWFybmluZyBtb2RlbHMuIEFkZGl0aW9uYWx5LCB0aGUgT1NDQSBib29rIGhhcyBhIFtjaGFwdGVyIG9uIERpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbl0oaHR0cHM6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzLzMuMTUvT1NDQS5iYXNpYy9kaW1lbnNpb25hbGl0eS1yZWR1Y3Rpb24uaHRtbCkgdGhhdCBoYXMgdXNlZnVsIGNvbnRleHQuIAo8L2RldGFpbHM+Cjxicj4KCjxicj4KCiMgUnVuIFBDQSBvbiBvdXIgZGF0YXNldCAgICAKCjwhLS0tIEFkZCBpbnRyb2R1Y3Rpb24gdG8gZnVuY3Rpb24sIGluY2x1ZGluZyBsaW5rIHRvIGRvY3VtZW50YXRpb24gLS0tPgoKU2luY2UgUENBIGlzIHNlbnNpdGl2ZSB0byBzY2FsZSwgd2Ugd2lsbCBydW4gaXQgb24gdGhlIFNDVCBub3JtYWxpemVkIGFzc2F5IChbcmVmZXJlbmNlXShodHRwczovL291eWFuZ2xhYi5jb20vc2luZ2xlY2VsbC9iYXNpYy5odG1sI3BjYS1wcmluY2lwYWwtY29tcG9uZW50LWFuYWx5c2lzKSkuIFdlIHdpbGwgbmFtZSB0aGUgcmVkdWN0aW9uIGluIGFuIGluZm9ybWF0aXZlIHdheSB0byBrZWVwIHRoZW0gY2xlYXIgZm9yIHVzIGluIHRoZSBmdXR1cmUuIEluIHRoaXMgY2FzZSwgb3VyIGRhdGEgaGFzIG5vdCB5ZXQgYmVlbiBpbnRlZ3JhdGVkLCBidXQgaXQgaGFzIGJlZW4gU0NUIG5vcm1hbGl6ZWQuIFNvIHdlIHdpbGwgbmFtZSB0aGUgcmVkdWN0aW9uIGB1bmludGVncmF0ZWQuc2N0LnBjYWAuIE5vdGUgdGhhdCBgU0NUVHJhbnNmb3JtKClgIHJldHVybmVkIGEgc2V0IG9mIGhpZ2hseSB2YXJpYWJsZSBnZW5lcywgYW5kIHRoZSBgUnVuUENBKClgIGZ1bmN0aW9uIHdpbGwgdXNlIHRoaXMgc3Vic2V0IHRvIGRldGVybWluZSB0aGUgUENzIGFuZCBnZW5lcyBhc3NvY2lhdGVkIHdpdGggdGhvc2UgUENzLgoKCmBgYHtyLCBydW5fcGNhLCB3YXJuaW5nID0gRkFMU0UsIG1lc3NhZ2UgPSBGQUxTRX0KIyBCdWlsZCBhIFBDQSBhbmQgYWRkIGl0IHRvIHRoZSBTZXVyYXQgb2JqZWN0ICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpnZW9fc28gPSBSdW5QQ0EoZ2VvX3NvLCByZWR1Y3Rpb24ubmFtZSA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScpCmdlb19zbwpgYGAKCkFmdGVyIHJ1bm5pbmcgdGhlIGNvbW1hbmQgaW4gdGhlIGNvbnNvbGUsIHdlIHNob3VsZCBzZWUgdGhhdCB0aGUgYGdlb19zb2AgU2V1cmF0IG9iamVjdCBoYXMgYSBuZXcgcmVkdWN0aW9uLiBWaWV3ZWQgaW4gb3VyIHJ1bm5pbmcgc2NoZW1hdGljOgoKIVtJbWFnZTogU2NoZW1hdGljIGFmdGVyIFJ1blBDQSgpLl0oaW1hZ2VzL3NldXJhdF9zY2hlbWF0aWMvU2xpZGU2LnBuZykKCldlIGNhbiB0aGVuIHZpc3VhbGl6ZSB0aGUgZmlyc3Qgc2V2ZXJhbCBQQ3MgdXNpbmcgdGhlIGBEaW1IZWF0bXAoKWAgZnVuY3Rpb24sIHdoaWNoIG9yZGVycyBib3RoIGNlbGxzIGFuZCBmZWF0dXJlcyAoZ2VuZXMpIGFjY29yZGluZyB0byB0aGVpciBQQ0Egc2NvcmVzIGFuZCBhbGxvd3MgdXMgdG8gc2VlIHNvbWUgZ2VuZXJhbCBwYXR0ZXJucyBpbiB0aGUgZGF0YS4gSGVyZSB3ZSB3aWxsIHNwZWNpZnkgdGhhdCB0aGUgZmlyc3QgMjQgUENzIGJlIGluY2x1ZGVkIGluIHRoZSBmaWd1cmUgYW5kIHRoYXQgNTAwIGNlbGxzIGFyZSByYW5kb21seSBzdWJzZXR0ZWQgZm9yIHRoZSBwbG90LiBfTm90ZSAtIHlvdSBtYXkgbmVlZCB0byBpbmNyZWFzZSB5b3VyIHBsb3Qgd2luZG93IHNpemUgdG8gcmVzb2x2ZSBlcnJvcnMgcmVnYXJkaW5nIGZpZ3VyZSBtYXJnaW5zLl8gIAoKYGBge3IsIHBjYV9oZWF0bWFwX3Bsb3QsIGV2YWw9RkFMU0V9CiMgQnVpbGQgaGVhdG1hcHMgb2YgUENBcyAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKIyBQbG90IGNlbGwgYnkgZ2VuZSBoZWF0bWFwcyBmb3IgZmlyc3Qgc2V2ZXJhbCBQQ3MKRGltSGVhdG1hcChnZW9fc28sIGRpbXM9MSwgY2VsbHM9NTAwLCBiYWxhbmNlZD1UUlVFLCByZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnKSAjIGxvb2sgYXQgZmlyc3QgUEMgYWxvbmUgZmlyc3QKRGltSGVhdG1hcChnZW9fc28sIGRpbXM9MToxOCwgY2VsbHM9NTAwLCBiYWxhbmNlZD1UUlVFLCByZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnKSAjIGZpcnN0IDE4IFBDcwoKIyBub3RlIC0gbmVlZCB0byB1c2UgcG5nKCkgdG8gd3JpdGUgdG8gZmlsZSBiZWNhdXNlIHRoaXMgaXNuJ3QgYSBnZ3Bsb3QKcG5nKGZpbGVuYW1lID0gJ3Jlc3VsdHMvZmlndXJlcy9xY19wY2FfaGVhdG1hcC5wbmcnLCB3aWR0aCA9IDEyLCBoZWlnaHQgPSA0MCwgdW5pdHMgPSAnaW4nLCByZXMgPSAzMDApCiAgRGltSGVhdG1hcChnZW9fc28sIGRpbXM9MToxOCwgY2VsbHM9NTAwLCBiYWxhbmNlZD1UUlVFLCByZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnKQpkZXYub2ZmKCkKYGBgCgpgYGB7ciwgcGNhX2hlYXRtYXBfb25lLCBlY2hvPUZBTFNFLCBtZXNzYWdlID0gRkFMU0UsIG91dC53aWR0aD0nNTAlJywgZmlnLmNhcD0nRGltSGVhdG1hcCBmb3IgUEMxIGFsb25lJ30KIyBsb29rIGF0IGZpcnN0IFBDIGFsb25lIGZpcnN0CkRpbUhlYXRtYXAoZ2VvX3NvLCBkaW1zPTEsIGNlbGxzPTUwMCwgYmFsYW5jZWQ9VFJVRSwgcmVkdWN0aW9uID0gJ3VuaW50ZWdyYXRlZC5zY3QucGNhJykgCgpgYGAKCgpgYGB7ciwgcGNhX2hlYXRtYXBfMTgsIGVjaG89RkFMU0UsIG1lc3NhZ2UgPSBGQUxTRSwgZmlnLmNhcD0nRGltSGVhdG1hcCBmb3IgUEMxLTE4J30KIyBQbG90IGNlbGwgYnkgZ2VuZSBoZWF0bWFwcyBmb3IgZmlyc3Qgc2V2ZXJhbCBQQ3MgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgojIGZpcnN0IDE4IFBDcwpEaW1IZWF0bWFwKGdlb19zbywgZGltcz0xOjE4LCBjZWxscz01MDAsIGJhbGFuY2VkPVRSVUUsIHJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScpIApgYGAKCkFzIHdlIHNjcm9sbCBkb3duIGluIHRoaXMgcGxvdCwgd2Ugc2VlIGxlc3MgYW5kIGxlc3Mgc3RydWN0dXJlIGluIG91ciBwbG90cyBpbmRpY2F0aW5nIHRoYXQgbm8gb25seSBpcyBsZXNzIHZhcmlhdGlvbiBpcyBiZWluZyByZXByZXNlbnRlZCBieSBsYXJnZXIgUENzIG92ZXJhbGwgYnV0IGFsc28gdGhhdCB0aG9zZSBQQ3MgYXJlIGxlc3MgbGlrZWx5IHRvIGNvcnJlc3BvbmQgdG8gdmFyaWF0aW9uIG9mIGludGVyZXN0LCBlLmcuIGNvcnJlc3BvbmRpbmcgdG8gY2VsbCB0eXBlcy9zdWJ0eXBlcy4KCgo8ZGV0YWlscz4KICA8c3VtbWFyeT4qV2hhdCBnZW5lcyBhcmUgY29udHJpYnV0aW5nIHRoZSBtb3N0IHRvIGVhY2ggUEM/Kjwvc3VtbWFyeT4KICBXZSBjYW4gYWxzbyB2aXN1YWxpemUgdGhlIGxvYWRpbmdzIGZvciBnZW5lcyBjb250cmlidXRpbmcgdG8gZWFjaCBwcmluY2lwYWwgY29tcG9uZW50cyB1c2luZyBTZXVyYXQgcHJvdmlkZWQgZnVuY3Rpb25zIFtzb3VyY2VdKGh0dHBzOi8vaG9sYWItaGt1LmdpdGh1Yi5pby9GdW5kYW1lbnRhbC1zY1JOQS9kb3duc3RyZWFtLmh0bWwjcGVyZm9ybS1saW5lYXItZGltZW5zaW9uYWwtcmVkdWN0aW9uKS4KICAKICBXZSBjYW4gaGlnaGxpZ2h0IGdlbmVzIGxvYWRlZCBmb3IgZGltZW5zdGlvbnMgb2YgaW50ZXJlc3QgdXNpbmcgdXNpbmcgYFZpekRpbUxvYWRpbmdzKClgOgoKYGBge3IsIHBjYV9sb2FkaW5nX3Bsb3QsIGV2YWwgPSBUUlVFLCBmaWcuc2hvdz0naG9sZCd9CiMgR2VuZSBsb2FkaW5ncyBmb3IgUEMxIGFuZCBQQzIgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpWaXpEaW1Mb2FkaW5ncyhnZW9fc28sIGRpbXMgPSAxOjIsIHJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScpCmdnc2F2ZShmaWxlbmFtZSA9ICdyZXN1bHRzL2ZpZ3VyZXMvcWNfcGNhX2xvYWRpbmdzLnBuZycsIHdpZHRoID0gMTIsIGhlaWdodCA9IDYsIHVuaXRzID0gJ2luJykKCmBgYAo8L2RldGFpbHM+Cjxicj4KPC9icj4KCj4gIyMjIyBIb3cgZG9lcyBTZXVyYXQgdXNlIFBDQSBzY29yZXM/IHsudW5saXN0ZWQgLnVubnVtYmVyZWR9Cj4gCj4gUGVyIHRoZSBbSG8gTGFiJ3MgbWF0ZXJpYWxzXShodHRwczovL2hvbGFiLWhrdS5naXRodWIuaW8vRnVuZGFtZW50YWwtc2NSTkEvZG93bnN0cmVhbS5odG1sI3BlcmZvcm0tbGluZWFyLWRpbWVuc2lvbmFsLXJlZHVjdGlvbikgLSAiVG8gb3ZlcmNvbWUgdGhlIGV4dGVuc2l2ZSB0ZWNobmljYWwgbm9pc2UgaW4gYW55IHNpbmdsZSBmZWF0dXJlIGZvciBzY1JOQS1zZXEgZGF0YSwgU2V1cmF0IGNsdXN0ZXJzIGNlbGxzIGJhc2VkIG9uIHRoZWlyIFBDQSBzY29yZXMsIHdpdGggZWFjaCBQQyBlc3NlbnRpYWxseSByZXByZXNlbnRpbmcgYSDigJhtZXRhZmVhdHVyZeKAmSB0aGF0IGNvbWJpbmVzIGluZm9ybWF0aW9uIGFjcm9zcyBhIGNvcnJlbGF0ZWQgZmVhdHVyZSBzZXQuIFRoZSB0b3AgcHJpbmNpcGFsIGNvbXBvbmVudHMgdGhlcmVmb3JlIHJlcHJlc2VudCBhIHJvYnVzdCBjb21wcmVzc2lvbiBvZiB0aGUgZGF0YXNldC4iIAo8IS0tIE5vdGUsIG1heSB3YW50IHRvIGVkaXQvcmVtb3ZlIGFib3ZlIHNlY3Rpb24gLS0+CgoKCiMjIyBWaXN1YWxpemluZyByZWxhdGl2ZSBjb250cmlidXRpb25zIG9mIGVhY2ggUEMKCgpPbmUgd2F5IHRvIGV2YWx1YXRlIHRoZSBQQ3MgdG8gaW5jbHVkZSBpcyBieSBsb29raW5nIGF0IGFuIGVsYm93IHBsb3QsIHdoaWNoIHNob3dzIHRoZSBwZXJjZW50IHZhcmlhbmNlIGV4cGxhaW5lZCBieSBzdWNjZXNzaXZlIFBDcy4gV2UnbGwgdXNlIHRoZSBgRWxib3dQbG90KClgIGZ1bmN0aW9uIHRvIGRvIHRoaXMsIHNwZWNpZnlpbmcgdGhhdCB0aGUgZmlyc3QgNTAgUENzIGJlIHBsb3R0ZWQuIAoKYGBge3IsIGVsYm93X3Bsb3QsIGZpZy5zaG93PSdob2xkJywgb3V0LndpZHRoPSc4MCUnfQojIEVsYm93IHBsb3QgaGVscCB2aXN1YWxpemUgaG93IG1hbnkgUENzIHRvIGluY2x1ZGUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkVsYm93UGxvdChnZW9fc28sIG5kaW1zID0gNTAsIHJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScpCmdnc2F2ZShmaWxlbmFtZSA9ICdyZXN1bHRzL2ZpZ3VyZXMvcWNfc2N0X2VsYm93X3Bsb3QucG5nJywgd2lkdGggPSA4LCBoZWlnaHQgPSA4LCB1bml0cyA9ICdpbicpCmBgYAoKSW4gdGhpcyBwbG90LCB3ZSBjb3VsZCBhcmJpdHJhcmlseSBjaG9vc2UgYSBudW1iZXIgYWxvbmcgdGhlIHgtYXhpcyB0aGF0IGxvb2tzIGxpa2UgYSBzaGFycCBjaGFuZ2UgaW4gdGhlIHZhcmlhbmNlIGZyb20gb25lIFBDIHRvIHRoZSBuZXh0LCB0aGF0IGlzLCBhbiBlbGJvdy4gT2YgY291cnNlLCB3aGlsZSB0aGF0J3Mgb2Z0ZW4gdGhlIHJlY29tbWVuZGF0aW9uIGluIHR1dG9yaWFscywgdGhlIGNob2ljZSBvZiB3aGVyZSB0aGUgcG9pbnQgb2YgdGhlICJlbGJvdyIgaXMsIGlzIG5vdCBhbHdheXMgb2J2aW91cywgYW5kIHRoaXMgcGxvdCBpcyBubyBkaWZmZXJlbnQuIFdlIGNvdWxkIGFsc28gdHJ5IHRvIHF1YW50aWZ5IG91ciBjaG9pY2UuCgojIyBDaG9vc2luZyB0aGUgbnVtYmVyIG9mIHNpZ25pZmljYW50IFBDcyBmb3IgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uCgo8IS0tIFNlY3Rpb24gbWF5IHN0aWxsIG5lZWQgdG8gYmUgZWRpdGVkIG1vcmUgJiBjb25zaWRlciBhZGRpbmcgYSBmaWd1cmUgLS0+IApBcyB3ZSBkaXNjdXNzZWQgYWJvdmUsIHdlIGRvbid0IHdhbnQgdG8gdXNlIGFsbCB0aGUgUENzIGdlbmVyYXRlZCBmb3IgYSBzaW5nbGUgY2VsbCBkYXRhIHNldCBidXQgaW5zdGVhZCB3YW50IHRvIHNlbGVjdCBhIHN1YnNldCB0byBsaW1pdCB0aGUgZG93bnN0cmVhbSBzdGVwcyB0byB2YXJpYXRpb24gdGhhdCdzIG1vcmUgbGlrZWx5IHRvIGNvcnJlc3BvbmQgdG8gY2VsbCB0eXBlcyBvciBzdWJ0eXBlcy4gU28gaG93IG1hbnkgUENzIHNob3VsZCBiZSB1c2VkPwoKQSBnb29kIHN0YXJ0aW5nIHBvaW50IGZvciBkZXRlcm1pbmluZyBob3cgbWFueSBQQ3MgdG8gc2VsZWN0IGZvciB5b3VyIHNpbmdsZS1jZWxsIGFuYWx5c2lzIGlzIHRvIHVuZGVyc3RhbmQgdGhlICJyZXNvbHV0aW9uIiBvZiB5b3VyIGJpb2xvZ2ljYWwgcXVlc3Rpb24uIElzIGFuc3dlcmluZyB5b3VyIGJpb2xvZ2ljYWwgcXVlc3Rpb24gZGVwZW5kZW50IG9uIGlkZW50aWZ5aW5nIHJhcmVyIGNlbGwgdHlwZXMgb3Igc3BlY2lmaWMgc3VidHlwZXM/IE9yIGFyZSBicm9hZGVyIGNlbGwtdHlwZXMgbW9yZSByZWxldmFudD8KCkZvciB0aGlzIGRhdGFzZXQsIHdlIGFyZSBleHBlY3RpbmcgYSBkaXZlcnNpdHkgb2YgY2VsbCB0eXBlcyBhbmQgY2VsbCBwb3B1bGF0aW9ucyB0aGF0IG1lZGlhdGUgd291bmQgaGVhbGluZywgYnV0IGFyZSBhbHNvIHRoYXQgYXJlIHBhcnQgb2YgdGhlIGFiZXJyYW50IHRyYW5zaXRpb24gdG8gYm9uZSwgd2hpY2ggbWlnaHQgYmUgbW9yZSByYXJlIGluIHRoZSBwb3B1bGF0aW9uLiBTbyBmb3IgdGhpcyBkYXRhc2V0LCB3ZSBtaWdodCB3YW50IHRvIGNvbnNpZGVyIHN0YXJ0aW5nIHdpdGggbW9yZSBQQ1MgcmF0aGVyIHRoYW4gdG9vIGZldyBQQ3MgdG8gc3RhcnQuIEFnYWluLCBpbiBhIGZ1bGwgYW5hbHlzaXMgd29ya2Zsb3csIG91ciBzZWxlY3Rpb24gYXQgdGhpcyBzdGVwIG1pZ2h0IGJlIG1vcmUgb2YgYSBzdGFydGluZyBwb2ludCBmb3IgZnVydGhlciBpdGVyYXRpb25zIHRoYW4gYSBmaW5hbCBkZWNpc2lvbi4gCgo8IS0tIFNlY3Rpb24gbWF5IG5lZWQgbW9yZSBlZGl0aW5nClJlbGF0ZWQgLSBob3cgaW1wb3J0YW50IGlzIHRoYXQgZGVjaXNpb24gdG8gdGhlIGRvd25zdHJlYW0gaW1wYWN0IChlLmcuIGhvdyBtdWNoIGRvZXMgY2hhbmdpbmcgdGhlIG51bWJlciBvZiBQQ3MgY2hhbmdlIHRoZSBjbHVzdGVyaW5nKT8KLS0+IAoKCiMjIyBVc2luZyBhIChjcnVkZSkgb3B0aW1pemF0aW9uIHRvIHNlbGVjdCBhIHN0YXJ0aW5nIHBvaW50CgpJbnN0ZWFkIG9mIGNob29zaW5nIGJhc2VkIG9uIHRoZSBlbGJvdyBwbG90IGJ5IHNpZ2h0IGFsb25lLCB3ZSBjYW4gdHJ5IHRvIHF1YW50aWZ5IG91ciBjaG9pY2UuIEhlcmUgd2UgY3JlYXRlIGEgZnVuY3Rpb24gdG8gcmV0dXJuIGEgbWluaW11bSBQQ3MgYmFzZWQgb24gdHdvIHBvc3NpYmxlIG1ldHJpY3MgKGN1bXVsYXRpdmUgdmFyaWF0aW9uIG9yIGFib3ZlIGEgbWluaXVtIHN0ZXAgc2l6ZSkgYW5kIHRoZW4gd2UnbGwgYXBwbHkgdGhhdCBmdW5jdGlvbiB0byBvdXIgZGF0YToKCmBgYHtyLCBvcHRpbWFsX3Bjc30KIyBGdW5jdGlvbiB0byBkZXRlcm1pbmUgb3B0aW1hbCBQQ3MgdG8gaW5jbHVkZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpvcHRpbWFsX3BjcyA9IGZ1bmN0aW9uKHNvLCByZWR1Y3Rpb24pIHsKICAgICMgcXVhbnRpdGF0aXZlIGNoZWNrIGZvciBudW1iZXIgb2YgUENzIHRvIGluY2x1ZGUKICAgIHBjdCA9IHNvQHJlZHVjdGlvbnNbW3JlZHVjdGlvbl1dQHN0ZGV2IC8gc3VtKHNvQHJlZHVjdGlvbnNbW3JlZHVjdGlvbl1dQHN0ZGV2KSAqIDEwMAogICAgY3VtID0gY3Vtc3VtKHBjdCkKICAgIGNvMSA9IHdoaWNoKGN1bSA+IDkwICYgcGN0IDwgNSlbMV0KICAgIGNvMiA9IHNvcnQod2hpY2goKHBjdFsxOmxlbmd0aChwY3QpLTFdIC0gcGN0WzI6bGVuZ3RoKHBjdCldKSA+IC4xKSwgZGVjcmVhc2luZyA9IFQpWzFdICsgMQogICAgcGNzID0gbWluKGNvMSwgY28yKSAKICAgIAogICAgcmV0dXJuKHBjcykKfQoKIyBBcHBseSBmdW5jdGlvbiB0byBvdXIgZGF0YQpwY3MgPSBvcHRpbWFsX3BjcyhnZW9fc28sICd1bmludGVncmF0ZWQuc2N0LnBjYScpCnBjcwoKIyBCYXNlZCBvbiB0aGUgaGVhdG1hcCwgd2UnbGwgbW9kaWZ5IHRvIDEzIFBDcwpwY3MgPSAxMwpgYGAKCgpBZ2FpbiwgdGhpcyBudW1iZXIgaXMgbGlrZWx5IGEgc3RhcnRpbmcgcG9pbnQgYW5kIG1heSBuZWVkIHRvIGJlIHJldmlzZWQgZGVwZW5kaW5nIG9uIHRoZSBvdXRjb21lIG9mIHRoZSBkb3duc3RyZWFtIHN0ZXBzLiAKCj4gIyMjIyBPdGhlciBtb3JlIHF1YW5pdGF0aXZlIHBhcmFtZXRlciBzZWxlY3Rpb24gb3B0aW9ucyB7LnVubGlzdGVkIC51bm51bWJlcmVkfQo+IAo+IFdoaWxlIG91dHNpZGUgdGhlIHNjb3BlIG9mIHRoaXMgd29ya3Nob3AsIHRoZXJlIGFyZSBjb21tdW5pdHkgZWZmb3J0cyB0byBkZXZlbG9wIG1vcmUgc29waGlzdGljYXRlZCBtZXRob2RzIHRvIHNlbGVjdCBhbiBhcHByb3ByaWF0ZSBudW1iZXIgb2YgUENzLCBsaWtlIHRoZSBbY2hvb3NlUiBwYWNrYWdlXShodHRwczovL2dpdGh1Yi5jb20vcmJwYXR0MjAxOS9jaG9vc2VSKSBbZmluZFBDIHBhY2thZ2VdKGh0dHBzOi8vYWNhZGVtaWMub3VwLmNvbS9iaW9pbmZvcm1hdGljcy9hcnRpY2xlLzM4LzEwLzI5NDkvNjU2NTMxNCkgb3IgW3VzaW5nIGNsdXN0ZXJpbmcgdHJlZXNdKGh0dHBzOi8vbGF6YXBwaS5pZC5hdS9wb3N0cy8yMDE3LTA3LTE5LWJ1aWxkaW5nLWEtY2x1c3RlcmluZy10cmVlLykgdG8gZXZhbHVhdGUgdGhlIHN0YWJpbGl0eSBvZiBwYXJhbWV0ZXIgY2hvaWNlcy4KCgojIyMgVmlzdWFsaXppbmcgb3VyIFBDIHJlc3VsdHMKCkluIGFkZGl0aW9uIHRvIHNlbGVjdGluZyBhIHJlZHVjZWQgbnVtYmVyIG9mIFBDcyB0byByZXByZXNlbnQgb3VyIGRhdGEsIHdlIGNhbiBhbHNvIHZpc3VhbGl6ZSAsIHNpbWlsYXJseSB0byBob3cgd2Ugb2Z0ZW4gbG9vayBhdCBzYW1wbGVzIGZvciBidWxrIFJOQS1zZXEgdXNpbmcgdGhlIGBEaW1QbG90KClgIGZ1bmN0aW9uLCB3aXRoIGVhY2ggY2VsbCBwbG90dGVkIGFsb25nIHRoZSBzZWxlY3RlZCBQQ3MgYW5kIGNvbG9yZWQgYnkgYSBzZWxlY3RlZCBtZXRhLWRhdGEgY29sdW1uOgoKfn5+Cj9EaW1QbG90ICMgZGVmYXVsdCBkaW1zID0gYygxLDIpCn5+fgoKYGBge3IsIHBjYV9sb2FkaW5nX3Bsb3RzLCBtZXNzYWdlPUZBTFNFLCBmaWcuc2hvdz0naG9sZCd9CiMgUENBIHN0eWxlIHBsb3QgZm9yIFBDMSBhbmQgUEMyICh1bmludGVncmF0ZWQpIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAKCkRpbVBsb3QoZ2VvX3NvLCByZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnLCBncm91cC5ieSA9ICdvcmlnLmlkZW50JykgIyBmaXJzdCBsYWJlbCBieSBzYW1wbGUKRGltUGxvdChnZW9fc28sIHJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScsIGdyb3VwLmJ5ID0gJ2RheScpICMgdGhlbiBsYWJlbCBieSBkYXkKZ2dzYXZlKGZpbGVuYW1lID0gJ3Jlc3VsdHMvZmlndXJlcy9xY19wY2FfcGxvdF91bmludGVncmF0ZWRfc2N0X2RheS5wbmcnLCB3aWR0aCA9IDcsIGhlaWdodCA9IDYsIHVuaXRzID0gJ2luJykgIyBzYXZlIApgYGAKCkluIHRoZSBmaXJzdCBwbG90IHdpdGggZWFjaCBjZWxsIGxhYmVsZWQgYnkgdGhlIG9yaWdpbmFsIHNhbXBsZSBuYW1lLCBpdCBsb29rcyBsaWtlIHRoZXJlIG1pZ2h0IGJlIHNvbWUgYmF0Y2hlcyBidXQgaXQncyBoYXJkIHRvIGRpc3Rpbmd1aXNoLiBGcm9tIHRoZSBzZWNvbmQgYnkgYGRheWAsIHdlIGNhbiBzZWUgdGhhdCBldmVuIGFmdGVyIG5vcm1hbGl6YXRpb24gdGhlcmUgc2VlbXMgdG8gYmUgdmFyaWF0aW9uIHRoYXQgY29ycmVzcG9uZHMgbW9yZSB0byBhIGJhdGNoIGVmZmVjdCByZWxhdGVkIHRvIHRoZSBkYXkgc3RhdHVzIHRoYW4gaW50ZXJlc3RpbmcgYmlvbG9naWNhbCB2YXJpYXRpb24uIFRoaXMgc3VnZ2VzdHMgdGhhdCBjbHVzdGVyaW5nIG91ciBkYXRhIHVzaW5nIG91ciBzZWxlY3RlZCBudW1iZXIgb2YgUENzLCBpbnRlZ3JhdGlvbiBzaG91bGQgYmUgcGVyZm9ybWVkIHRvIG1pdGlnYXRlIHRoZXNlIGRpZmZlcmVuY2VzIGFuZCBiZXR0ZXIgYWxpZ24gb3VyIGRhdGEuCgoKIyBJbnRlZ3JhdGUgTGF5ZXJzCgoKQmFzZWQgb24gb3VyIFBDQSBwbG90IGFuZCBvZnRlbiBhIHN0YW5kYXJkIHBhcnQgb2YgbXVsdGlwbGUgc2FtcGxlIHNjUk5BLXNlcSBhbmFseXNpcywgd2Ugd2lsbCBpbnRlZ3JhdGUgb3VyIGRhdGEgYWNyb3NzIGFsbCBzYW1wbGVzLiBDdXJyZW50bHksIGVhY2ggc2FtcGxlIGlzIHN0b3JlZCBhcyBhIGxheWVyIGluIG91ciBgZ2VvX3NvYCBvYmplY3QsIFNpbmNlIGVhcmxpZXIgaW4gdGhlIHdvcmtzaG9wLCB3ZSB1c2VkIGBTQ1RyYW5zZm9ybSgpYCB0byBub3JtYWxpemUgb3VyIGRhdGEsIHNlbGVjdCB2YXJpYWJsZSBnZW5lcyBhbmQgdGhlbiBoYXZlIGdlbmVyYXRlZCBhIFBDQSByZWR1Y3Rpb24sIHdlIGNhbiB1c2UgdGhlIGBJbnRlZ3JhdGVMYXllcnMoKWAgZnVuY3Rpb24gdG8gZG8gdGhhdC4KCiFbQ0NBIGludGVncmF0aW9uIGlsbHVzdHJhdGlvbiwgbW9kaWZpZWQgZnJvbSBTdHVhcnQgYW5kIEJ1dGxlciwgMjAxOCAtaHR0cHM6Ly9kb2kub3JnLzEwLjExMDEvNDYwMTQ3XSguL2ltYWdlcy9jdXJyaWN1bHVtLzA0LVBDQWFuZEludGVncmF0aW9uL0hCQy1DQ0EtSW50ZWdyYXRpb25fc2ltcGxpZmllZC5wbmcpCgpUaGUgZGV0YWlscyBvZiBob3cgaW50ZWdyYXRpb24gd29ya3MgZGVwZW5kcyBvbiB0aGUgbWV0aG9kLCBidXQgZm9yIHRoZSBSUENBIGFwcHJvYWNoIHRoYXQgd2UnbGwgYmUgdXNpbmcgaGVyZSAtIHRoZSBwcm9jZXNzIGlzIHNpbWlsYXIgdG8gdGhlIGNhbm9uaWNhbCBjb3JyZWxhdGlvbiBhbmFseXNpcyAoQ0NBKSBhcHByb2FjaCBpbGx1c3RyYXRpb24gYWJvdmUgWyhzb3VyY2UpXShodHRwczovL3d3dy5iaW9yeGl2Lm9yZy9jb250ZW50LzEwLjExMDEvMjAyMS4wOC4wNC40NTM1Nzl2MS5mdWxsLnBkZikuIEhvd2V2ZXIsIFJQQ0EgaXMgbW9yZSBlZmZpY2llbnQgKGZhc3RlcikgdG8gcnVuIGFuZCBiZXR0ZXIgcHJlc2VydmVzIGRpc3RpbmN0IGNlbGwgaWRlbnRpdGllcyBiZXR3ZWVuIHNhbXBsZXMgWyhzb3VyY2UpXShodHRwczovL3d3dy5uYXR1cmUuY29tL2FydGljbGVzL3M0MTU5Mi0wMjEtMDEzMzYtOCkuIEFzIGRlc2NyaWJlZCBpbiB0aGUgY29ycmVzcG9uZGluZyBbU2V1cmF0IHR1dG9yaWFsXShodHRwczovL3NhdGlqYWxhYi5vcmcvc2V1cmF0L2FydGljbGVzL2ludGVncmF0aW9uX3JwY2EuaHRtbCksIGVhY2ggZGF0YXNldCBpcyBwcm9qZWN0ZWQgaW50byB0aGUgb3RoZXJzJyBQQ0Egc3BhY2UgYW5kIGNvbnN0cmFpbiB0aGUgYW5jaG9ycyAKCk5ldyB0byBTZXVyYXQgdjUgYXJlIGltcHJvdmVtZW50cyB0aGF0IG1ha2Ugc2VsZWN0aW5nIGRpZmZlcmVudCBpbnRlZ3JhdGlvbiBtZXRob2RzIG11Y2ggZWFzaWVyLiBUaGUgcmVzdWx0cyBvZiBlYWNoIGFsdGVybmF0aXZlIGludGVncmF0aW9uIG1ldGhvZCBhcmUgc3RvcmVkIHdpdGhpbiB0aGUgc2FtZSBgU2V1cmF0YCBvYmplY3QsIHdoaWNoIG1ha2VzIGNvbXBhcmluZyBkb3duc3RyZWFtIGVmZmVjdHMgbXVjaCBlYXNpZXIuICBTbywgaWYgd2Ugd2FudGVkIHRvIHJ1biB0aGUgYFJQQ0FJbnRlZ3JhdGlvbmAgbWV0aG9kLCB3ZSB3b3VsZCBydW4gKCoqYnV0IHdlIHdvbid0IGhlcmUqKik6CgpgYGB7ciwgaW50ZWdyYXRlX2xheWVycywgY2FjaGUgPSBUUlVFLCBjYWNoZS5sYXp5ID0gRkFMU0UsIHdhcm5pbmcgPSBGQUxTRSwgbWVzc2FnZSA9IEZBTFNFfQojIyMgRE8gTk9UIFJVTiAjIyMKZ2VvX3NvID0gSW50ZWdyYXRlTGF5ZXJzKAogIG9iamVjdCA9IGdlb19zbywgCiAgbWV0aG9kID0gUlBDQUludGVncmF0aW9uLCAKICBvcmlnLnJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScsCiAgbm9ybWFsaXphdGlvbi5tZXRob2QgPSAnU0NUJywKICBuZXcucmVkdWN0aW9uID0gJ2ludGVncmF0ZWQuc2N0LnJwY2EnKQpgYGAKClRoZSBTZXVyYXQgdjUgdmlnbmV0dGUgb24gaW50ZWdyYXRpdmUgYW5hbHlzaXMgKFtsaW5rXShodHRwczovL3NhdGlqYWxhYi5vcmcvc2V1cmF0L2FydGljbGVzL3NldXJhdDVfaW50ZWdyYXRpb24jcGVyZm9ybS1zdHJlYW1saW5lZC1vbmUtbGluZS1pbnRlZ3JhdGl2ZS1hbmFseXNpcykpIHByb3ZpZGVzIGV4YW1wbGVzIG9mIGVhY2ggaW50ZWdyYXRpb24gbWV0aG9kLiBOb3RlLCB0aGF0IHRoZSB2aWduZXR0ZSBjb2RlIHVzZXMgdGhlIGBOb3JtYWxpemVEYXRhKClgLCBgU2NhbGVEYXRhKClgLCBgRmluZFZhcmlhYmxlRmVhdHVyZXMoKWAgcGlwZWxpbmUsIHNvIHRoZWlyIGBJbnRlZ3JhdGVMYXllcnMoKWAgY2FsbCBkb2VzIG5vdCBpbmNsdWRlIGBub3JtYWxpemF0aW9uLm1ldGhvZCA9ICdTQ1QnYCwgYXMgb3VycyBtdXN0LgoKTm90ZSB3ZSBoYXZlIHNwZWNpZmllZCB0aGUgdW5pbnRlZ3JhdGVkIHJlZHVjdGlvbiBgdW5pbnRlZ3JhdGVkLnNjdC5wY2FgLCB3aGljaCBpcyB3aGF0IGBJbnRlZ3JhdGVMYXllcnMoKWAgb3BlcmF0ZXMgb24sIGFsb25nIHdpdGggdGhlIGBTQ1RgIGFzc2F5LiBMZXQncyB0YWtlIGEgbG9vayB0byBzZWUgd2hhdCdzIGRpZmZlcmVudCBhYm91dCB0aGUgYFNldXJhdGAgb2JqZWN0OgoKPiAqKkxvYWQgaW50ZWdyYXRlZCBkYXRhKioKPiAKPiBCZWNhdXNlIHRoZSBgSW50ZWdyYXRlTGF5ZXJzKClgIGZ1bmN0aW9uIHRha2VzIGEgd2hpbGUgdG8gcnVuLCB3ZSB3aWxsIHNpbXBseSBsb2FkIHRoZSBSUENBIGludGVncmF0ZWQgYGdlb19zb2Agb2JqZWN0IGZyb20gYSBmaWxlIHdlIGhhdmUgcHJldmlvdXNseSBnZW5lcmF0ZWQuCj4gCj4gYGBge3IsIGV2YWwgPSBGQUxTRX0KPiBnZW9fc28gPSByZWFkUkRTKCcvaG9tZS93b3Jrc2hvcC9yY2F2YWxjYS9JU0NfUi9yZXN1bHRzL3JkYXRhL2dlb19zb19zY3RfaW50ZWdyYXRlZC5yZHMnKQo+IGBgYAo+IAoKYGBge3IsIHByZXZpZXdfc2V1cmF0fQojIENoZWNrIG91ciB1cGRhdGVkIG9iamVjdCB0aGF0IHdlJ3ZlIHJlYWQgaW4gZnJvbSBmaWxlIC0tLS0tLS0tLS0tLS0tLS0tLS0gCgojIE9ic2VydmUgdGhhdCB3ZSBub3cgaGF2ZSBhIG5ldyByZWR1Y3Rpb24sIGBpbnRlZ3JhdGVkLnNjdC5ycGNhYApnZW9fc28gCmBgYAoKVmlld2VkIGluIG91ciBydW5uaW5nIHNjaGVtYXRpYzoKCiFbSW1hZ2U6IFNjaGVtYXRpYyBhZnRlciBJbnRlZ3JhdGVMYXllcnMoKS5dKGltYWdlcy9zZXVyYXRfc2NoZW1hdGljL1NsaWRlNy5wbmcpCgpXZSBjYW4gYWxzbyBjb25maXJtIHRoYXQgb3VyIGludGVncmF0aW9uIG1ldGhvZCBoYXMgaGVscGVkIHRvIGNvcnJlY3QgdGhlIGBEYXlgIGVmZmVjdHMgd2Ugc2F3IGluIHRoZSBpbml0aWFsIFBDQSBwbG90cwoKYGBge3IsIGNoZWNrX2ludGVncmF0aW9uLCBmaWcuc2hvdz0naG9sZCd9CiMgUENBIHN0eWxlIHBsb3QgZm9yIFBDMSBhbmQgUEMyIChpbnRlZ3JhdGVkKSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpEaW1QbG90KGdlb19zbywgcmVkdWN0aW9uID0gJ2ludGVncmF0ZWQuc2N0LnJwY2EnLCBncm91cC5ieSA9ICdkYXknKQpnZ3NhdmUoZmlsZW5hbWUgPSAncmVzdWx0cy9maWd1cmVzL3FjX3BjYV9wbG90X2ludGVncmF0ZWRfc2N0X2RheS5wbmcnLCB3aWR0aCA9IDcsIGhlaWdodCA9IDYsIHVuaXRzID0gJ2luJykKYGBgCgo8IS0tLSBjb25maXJtZWQgaW4gdGVzdGluZyB0aGF0IFBDQSBwbG90IGlzIHVwZGF0ZWQgaWYgcnVuIG9uIGNhdGNoZWQgZ2VvX3NvIG9iamVjdCAtLS0+CgojIFNhdmUgb3VyIHByb2dyZXNzCgpCZWZvcmUgd2UgbW92ZSBvbiwgbGV0J3Mgc2F2ZSBvdXIgdXBkYXRlZCBTZXVyYXQgb2JqZWN0IHRvIGZpbGU6CgpgYGB7ciwgc2F2ZV9yZHNfaGlkZGVuLCBlY2hvID0gRkFMU0V9CmlmKCFmaWxlLmV4aXN0cygncmVzdWx0cy9yZGF0YS9nZW9fc29fc2N0X2ludGVncmF0ZWQucmRzJykpIHsKICBzYXZlUkRTKGdlb19zbywgZmlsZSA9ICdyZXN1bHRzL3JkYXRhL2dlb19zb19zY3RfaW50ZWdyYXRlZC5yZHMnKQp9CmBgYAoKYGBge3IsIHNhdmVfcmRzLCBldmFsID0gRkFMU0V9CiMgU2F2ZSB1cGRhdGVkIHNldXJhdCBvYmplY3QgdG8gZmlsZSAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpzYXZlUkRTKGdlb19zbywgZmlsZSA9ICdyZXN1bHRzL3JkYXRhL2dlb19zb19zY3RfaW50ZWdyYXRlZC5yZHMnKQpgYGAKCj4gKipPdGhlciBpbnRlZ3JhdGlvbiBtZXRob2RzKioKPiAKPiBBZnRlciBub3JtYWxpemluZyB0aGUgZGF0YSB3aXRoIGBTQ1RyYW5zZm9ybSgpYCBhbmQgcGVyZm9ybWVkIHRoZSBkaW1lbnNpb24gcmVkdWN0aW9uIHdpdGggYFJ1blBDQSgpYCwgYWx0ZXJuYXRpdmVseSB3ZSBjb3VsZCBhbHNvIHVzZSB0aGUgYENDQWAgaW50ZWdyYXRpb24gbWV0aG9kIHdpdGg6Cj4gCj4gYGBge3IsIGV2YWwgPSBGQUxTRX0KPiAjIyMgRE8gTk9UIFJVTiAjIyMKPiBnZW9fc28gPSBJbnRlZ3JhdGVMYXllcnMoCj4gICAgIG9iamVjdCA9IGdlb19zbywgCj4gICAgIG1ldGhvZCA9IENDQUludGVncmF0aW9uLCAKPiAgICAgb3JpZy5yZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnLAo+ICAgICBub3JtYWxpemF0aW9uLm1ldGhvZCA9ICdTQ1QnLAo+ICAgICBuZXcucmVkdWN0aW9uID0gJ2ludGVncmF0ZWQuc2N0LmNjYScpCj4gYGBgCj4KCiMgU3VtbWFyeQoKSW4gdGhpcyBzZWN0aW9uLCB3ZToKCi0gRGlzY3Vzc2VkIGhvdyBQQ0EgaXMgdXNlZCBpbiBzY1JOQS1zZXEgYW5hbHlzaXMuCi0gRGVtb25zdHJhdGVkIHNvbWUgdmlzdWFsaXphdGlvbnMgYWZ0ZXIgY29tcHV0aW5nIFBDQS4KLSBEaXNjdXNzZWQgaG93IHRvIGRlY2lkZSBob3cgbWFueSBQQ3MgdG8gdXNlIGluIGRvd25zdHJlYW0gYW5hbHlzaXMuCi0gSW50ZWdyYXRlZCB0aGUgZGF0YS4KCk5leHQgc3RlcHM6IENsdXN0ZXJpbmcgYW5kIHByb2plY3Rpb24KCi0tLS0KClRoZXNlIG1hdGVyaWFscyBoYXZlIGJlZW4gYWRhcHRlZCBhbmQgZXh0ZW5kZWQgZnJvbSBtYXRlcmlhbHMgbGlzdGVkIGFib3ZlLiBUaGVzZSBhcmUgb3BlbiBhY2Nlc3MgbWF0ZXJpYWxzIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgW0NyZWF0aXZlIENvbW1vbnMgQXR0cmlidXRpb24gbGljZW5zZSAoQ0MgQlkgNC4wKV0oaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbGljZW5zZXMvYnkvNC4wLyksIHdoaWNoIHBlcm1pdHMgdW5yZXN0cmljdGVkIHVzZSwgZGlzdHJpYnV0aW9uLCBhbmQgcmVwcm9kdWN0aW9uIGluIGFueSBtZWRpdW0sIHByb3ZpZGVkIHRoZSBvcmlnaW5hbCBhdXRob3IgYW5kIHNvdXJjZSBhcmUgY3JlZGl0ZWQuCgo8YnIvPgo8YnIvPgo8aHIvPgp8IFtQcmV2aW91cyBsZXNzb25dKDAzLU5vcm1hbGl6YXRpb24uaHRtbCkgfCBbVG9wIG9mIHRoaXMgbGVzc29uXSgjdG9wKSB8IFtOZXh0IGxlc3Nvbl0oMDUtUHJvamVjdGlvbkFuZENsdXN0ZXJpbmcuaHRtbCkgfAp8IDotLS0gfCA6LS0tLTogfCAtLS06IHwK</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("04-PCAandIntegration.Rmd");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
