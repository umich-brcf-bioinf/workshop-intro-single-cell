<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="UM Bioinformatics Core" />

<meta name="date" content="2024-02-25" />

<title>PCA and dimensionality reduction</title>

<script src="site_libs/header-attrs-2.24/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<!--
Favicon dervied from
https://twemoji.twitter.com/
https://favicon.io/emoji-favicons/dna/
-->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="shortcut icon" href="favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>




<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Intro to scRNA-Seq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="workshop_intro.html">Intro</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="00A-OrientingOnScRNASeq.html">Orienting on scRNA-Seq</a>
    </li>
    <li>
      <a href="00B-CellRangerInAction.html">Cell Ranger in Action</a>
    </li>
    <li>
      <a href="01-GettingStarted.html">Seurat</a>
    </li>
    <li>
      <a href="02-QCandFiltering.html">Secondary QC &amp; Filtering</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="03-Integration.html">Normalization</a>
    </li>
    <li>
      <a href="04-PCAandDimReduction.html">PCA &amp; Integration</a>
    </li>
    <li>
      <a href="05-ProjectionAndClustering.html">Projection &amp; Clustering</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="06-MarkerVisualization.html">Marker identification and visualization</a>
    </li>
    <li>
      <a href="07-CellTypeAnnos.html">Cell type annotation</a>
    </li>
    <li>
      <a href="08-DifferentialExpression.html">Differential expression analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="workshop_wrap_up.html">Wrap up</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">PCA and dimensionality reduction</h1>
<h4 class="author">UM Bioinformatics Core</h4>
<h4 class="date">2024-02-25</h4>

</div>


<style type="text/css">
body, td {
   font-size: 18px;
}
code.r{
  font-size: 12px;
}
pre {
  font-size: 12px
}
</style>
<div id="workflow-overview" class="section level1 unlisted unnumbered">
<h1 class="unlisted unnumbered">Workflow Overview</h1>
<p><br/>
<img src="images/wayfinder/wayfinder.png" alt="wayfinder" style="height: 400px;"/>
<br/> <br/></p>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>One of our ultimate goals is to cluster the cells according to their
expression profiles, and determine what cell types correspond to these
clusters for the purposes of differential expression between clusters
and/or between conditions within clusters. However, for our data we saw
that our 12 samples contain 1K - 3K cells each with measurements across
21K genes, and single cell experiments can generate up to 10K -12K cells
per sample.</p>
<p>This means that even after filtering the data, we are working very
“high-dimensional” data. High dimensional data presents some major
challenges and requires something called dimensionality reduction.
Dimension reduction helps us reduce the number of separate dimensions by
grouping correlated features into a single dimension. This makes
downstream analysis steps more computationally feasible.</p>
<p>Similar to the previous sections, the process of selecting
informative dimensions in a dataset is often iterative, but only a
single value is likely to be reported even when multiple parameter
choices may have lead to similar results/conclusions.</p>
<p>In this section, we will demonstrate the steps to perform
dimensionality reduction on our data using principal component analysis
(PCA).</p>
<div id="objectives" class="section level2">
<h2>Objectives</h2>
<ul>
<li>Understand why we use PCA for dimensionality reduction</li>
<li>Choose an appropriate number of principal components to cluster our
data</li>
</ul>
<hr />
</div>
</div>
<div id="dimensionality-reduction" class="section level1">
<h1>Dimensionality reduction</h1>
<!--Before this section - Day 1: Starting w/ Seurat, Initial QC, & Batch correction (SCtransform)-->
<!--Instruction Note: Using integrated data here and will compare to unintegrated results in next section, similar to  [here](https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-021-03957-4)?-->
<p>In addition to the “high-dimensionality” expected for single-cell
data, we expect the data to be both “sparse” and “noisy”. Sparse in the
sense that many genes will either not be expressed or not measured in
many of the cells and have zero values. Noisy due to biological
variability and practical limitations of both capture and sequencing
depth <a
href="https://ouyanglab.com/singlecell/basic.html#a-gentle-introduction-to-dr">source</a>.</p>
<blockquote>
<h4 id="zero-inflation-of-single-cell-data"
class="unlisted unnumbered">Zero “inflation” of single-cell data</h4>
<p>Single-cell data is sometimes described as “zero inflated”, however
work by <a
href="https://www.biorxiv.org/content/10.1101/582064v1.full">Svensson</a>
has challenged that characterization and argued that the higher number
of zeros observed in scRNA-seq compared to bulk RNA-seq is more likely
due to biological variance and lower sequencing saturation than a
technical artifact.</p>
</blockquote>
<p>For sparse, high-dimensional, <em>biological</em> data, we expect
many genes to have correlated expression as they would be impacted by
the same biological process and for many genes with either low (more
noisy) or similar expression across the cell population.</p>
<p>So how do we determine what and how many genes to use before
classifying cells in our samples into cell-types/subtypes based on their
expression?</p>
<details>
<summary>
<em>More detail on dimensionality reduction </em>
</summary>
The <a
href="https://ouyanglab.com/singlecell/basic.html#a-gentle-introduction-to-dr">Ouyang
Lab has a “gentle introduction” section of their materials</a> that goes
into greater details on dimensionality reduction including how similar
strategies are used in deep learning models. Additionaly, the OSCA book
has a [chapter on Dimensionality reduction(<a
href="https://bioconductor.org/books/3.15/OSCA.basic/dimensionality-reduction.html"
class="uri">https://bioconductor.org/books/3.15/OSCA.basic/dimensionality-reduction.html</a>)
</details>
<p><br></p>
<div id="what-is-pca" class="section level2">
<h2>What is PCA?</h2>
<!--- Give some context and background on PCA
- What is PCA
- Why do we use it 
--->
<p>Principal component analysis (PCA) determines axes in
high-dimensional space that capture the most variation.</p>
<div id="pca-example" class="section level3">
<h3>PCA example</h3>
<p>To understand how PCA works, we can consider a smaller dataset
measuring the expression of four genes measured in just two cells, we
could plot the expression of those four genes, with data from one cell
plotted on the x-axis and the second cell plotted on the y-axis.</p>
<p><img
src="images/curriculum/04-PCAandDimReduction/HBC-PCA_2sample_genes.png"
alt="A simple PCA example (from HBC)" />
<!--- Update plot to replace "Sample" with cell in figure and table ---></p>
<p>If we wanted to represent the most variation across the data, we
would draw a diagonal line between gene B and gene C - this would
represent the first principal component. However, this line doesn’t
capture all the variance in this data as the genes also vary above and
below the line, so we could draw another line (at a right angle to the
first) representing the second most variation int the data - which would
represent the second principal component (PC).</p>
<p>However, as we can see in the example below, genes near the end of
each line are those with the greatest influence on the direction and
length of the PC.</p>
<p><img
src="images/curriculum/04-PCAandDimReduction/HBC-PCA_2sample_variation3.png"
alt="PCA gene loadings (from HBC)" />
<!--- Update plot to replace "Sample" with cell in figure ---></p>
<p>We’ll skip the process of calculating the score for each cell per PC,
but after running PCA on our data we expect each cell to have a score
based on the expression of the genes contributing to each PC and each
gene will have a weight or loading. By definition, the PCs capture the
greatest factors of heterogeneity in decreasing order in the data
set.</p>
</div>
<div id="why-pca-is-useful-for-single-cell-data" class="section level3">
<h3>Why PCA is useful for single-cell data</h3>
<p>In contrast to bulk RNA-seq, where the majority of the variance in a
given dataset are usually explained by the first and second PC, we
expect that many more PCs are contributing to the overall variance in a
single-cell data set.</p>
<p>However, we can assume that biological processes affect multiple
genes in a coordinated way. Therefore the top PCs likely represent
biological structure rather than random technical or biological noise,
which affects each gene independently and and we can use the top several
PCs to approximate the full data set in downstream analysis (<a
href="https://bioconductor.org/books/3.12/OSCA/dimensionality-reduction.html#principal-components-analysis">source</a>).</p>
<p>This reduction in dimensionality, from 10,000 cells x 19,000 genes,
for example, to several order magnitudes less of PCs (often 30-60 PCs
will be considered) and allows us to select PCs that are more likely to
distinguish between biological variation related to the expected cell
types/subtypes and (confounding) technical variation.</p>
<blockquote>
<h4 id="more-context-using-pca-for-single-cell-data"
class="unlisted unnumbered">More context using PCA for single-cell
data</h4>
<p>To read more on PCA, please refer to the <a
href="https://hbctraining.github.io/scRNA-seq_online/lessons/05_theory_of_PCA.html">HBC
- Theory of PCA content</a>, from which this section is adapted and the
original source material for that content, specifically <a
href="https://www.youtube.com/watch?v=_UVHneBUBW0">Josh Starmer’s
StatQuest video</a>. For additional detail, the OSCA chapter on <a
href="https://bioconductor.org/books/3.15/OSCA.basic/dimensionality-reduction.html">Principal
components analysis</a> includes a more descriptive overview of PCA in
the context of single-cell data.</p>
</blockquote>
</div>
<div id="run-pca-on-our-dataset" class="section level3">
<h3>Run PCA on our dataset</h3>
<!--- Add introduction to function, including link to documentation --->
<p>Since PCA is sensitive to scale, we will run it on the SCT normalized
assay (<a
href="https://ouyanglab.com/singlecell/basic.html#pca-principal-component-analysis">reference</a>).
We will name the reduction in an informative way to keep them clear for
us in the future. In this case, our data has not yet been integrated,
but it has been SCT normalized. So we will name the reduction
<code>unintegrated.sct.pca</code>. Note that <code>SCTTransform()</code>
returned a set of highly variable genes, and the <code>RunPCA()</code>
function will use this subset to determine the PCs and genes associated
with those PCs.</p>
<pre class="r"><code>geo_so = RunPCA(geo_so, reduction.name = &#39;unintegrated.sct.pca&#39;)</code></pre>
<p>In the console, the first 5 PCs are listed along with the associated
genes. If we look at the <code>geo_so</code> object, we’ll see our
dimension reduction:</p>
<pre class="r"><code>geo_so</code></pre>
<pre><code>An object of class Seurat 
38503 features across 22320 samples within 2 assays 
Active assay: SCT (17129 features, 3000 variable features)
 3 layers present: counts, data, scale.data
 1 other assay present: RNA
 1 dimensional reductions calculated: unintegrated.sct.pca</code></pre>
<!--- Should this dim loading section drawn from [Ho Lab](https://holab-hku.github.io/Fundamental-scRNA/downstream.html#standard-pre-processing-workflow) be included in the main content? Note - would need to run command in script & capture output  --->
<p>We can also visualize both the cell and gene features that define
each principal components using Seurat provided functions <a
href="https://holab-hku.github.io/Fundamental-scRNA/downstream.html#perform-linear-dimensional-reduction">source</a>.</p>
<p>First, we can print out the top 5 (gene) features per dimension by
accessing that part of the Seurat object:</p>
<pre class="r"><code>print(geo_so[[&#39;unintegrated.sct.pca&#39;]], dims = 1:5, nfeatures = 5)</code></pre>
<pre><code>PC_ 1 
Positive:  Col1a1, Col3a1, Col1a2, Sparc, Dcn 
Negative:  Lyz2, Cd74, Apoe, H2-Aa, C1qb 
PC_ 2 
Positive:  Col1a1, Col3a1, Col1a2, Dcn, Lyz2 
Negative:  Fabp4, Aqp1, Pecam1, Egfl7, Flt1 
PC_ 3 
Positive:  Apoe, Fabp4, C1qb, Lyz2, C1qa 
Negative:  Eef1a1, Rps28, Myl6, Slc25a4, Rpl13 
PC_ 4 
Positive:  Apoe, Pf4, C1qa, C1qb, Ccl8 
Negative:  Cd74, H2-Ab1, H2-Aa, H2-Eb1, Acta2 
PC_ 5 
Positive:  Acta2, Rgs5, Tagln, Myl9, Apoe 
Negative:  Cd74, H2-Ab1, H2-Aa, H2-Eb1, Il1b</code></pre>
<p>We can also highlight genes loaded for each dimension using a
visualization:</p>
<pre class="r"><code>VizDimLoadings(geo_so, dims = 1:2, reduction = &#39;unintegrated.sct.pca&#39;)
ggsave(filename = &#39;results/figures/qc_pca_loadings.png&#39;, width = 12, height = 6, units = &#39;in&#39;)</code></pre>
<p><img
src="images/curriculum/04-PCAandDimReduction/qc_pca_loadings.png" /></p>
<p>We can look at how cells load on the first two principal components,
similarly to how we often look at samples for bulk RNA-seq, with the
<code>DimPlot</code> function:</p>
<pre class="r"><code>DimPlot(geo_so, reduction = &#39;unintegrated.sct.pca&#39;, group.by = &#39;day&#39;)
ggsave(filename = &#39;results/figures/qc_pca_plot_unintegrated_sct_day.png&#39;, width = 7, height = 6, units = &#39;in&#39;)</code></pre>
<p><img
src="images/curriculum/04-PCAandDimReduction/qc_pca_plot_unintegrated_sct_day.png" /></p>
<p>Lastly, a common visualization used in Seurat tutorials is
<code>DimHeatmap()</code>, which orders both cells and features
according to their PCA scores and allows us to see some general patterns
in the data:</p>
<pre class="r"><code>DimHeatmap(geo_so, dims=1:3, cells=500, balanced=TRUE)</code></pre>
<p><img
src="images/curriculum/04-PCAandDimReduction/qc_pca_heatmap.png" /></p>
<p>Since the heatmap isn’t a ggplot, we need to use a more general
output function to save it to file</p>
<pre class="r"><code>png(filename = &#39;results/figures/qc_pca_heatmap.png&#39;, width = 12, height = 4, units = &#39;in&#39;, res = 300)
DimHeatmap(geo_so, dims=1:3, cells=500, balanced=TRUE, reduction = &#39;unintegrated.sct.pca&#39;)
dev.off()</code></pre>
<blockquote>
<h4 id="how-does-seurat-use-pca-scores" class="unlisted unnumbered">How
does Seurat use PCA scores?</h4>
<p>Per the <a
href="https://holab-hku.github.io/Fundamental-scRNA/downstream.html#perform-linear-dimensional-reduction">Ho
Lab’s materials</a> - “To overcome the extensive technical noise in any
single feature for scRNA-seq data, Seurat clusters cells based on their
PCA scores, with each PC essentially representing a ‘metafeature’ that
combines information across a correlated feature set. The top principal
components therefore represent a robust compression of the dataset.”
<!-- Note, may want to edit/remove above section --></p>
</blockquote>
</div>
</div>
<div
id="choosing-the-number-of-significant-pcs-for-dimensionality-reduction"
class="section level2">
<h2>Choosing the number of significant PCs for dimensionality
reduction</h2>
<!-- Section still needs to be edited more & consider adding a figure -->
<p>Why not use every principal component generated for this dataset?
Using too many PCs risks including uninteresting technical variation and
a single cell itself is not a reasonable functional unit for most
biology.</p>
<p>A good starting point for determining how many PCs to select for your
single-cell analysis is to understand the “resolution” of your
biological question. Is answering your biological question dependent on
identifying rarer cell types or specific subtypes? Or are broader
cell-types more relevant?</p>
<p>For this dataset, we are expecting a diversity of cell types and the
cell populations that mediate wound healing, or that are part of the
aberrant transition to bone, might be more rare in the population so
after evaluating the relative contributions across the first set of PCs,
we might want to consider selecting too many rather than too few PCs to
start.</p>
<!-- Section still needs to be edited
Related - how important is that decision to the downstream impact (e.g. how much does changing the number of PCs change the clustering)?
-->
<div id="visualizing-relative-contributions-of-each-pc"
class="section level3">
<h3>Visualizing relative contributions of each PC</h3>
<p>One way to determine how many PCs to include is by looking at an
elbow plot, which shows the percent variance explained by successive
PCs.</p>
<pre class="r"><code>ElbowPlot(geo_so, ndims = 50, reduction = &#39;unintegrated.sct.pca&#39;)
ggsave(filename = &#39;results/figures/qc_sct_elbow_plot.png&#39;)</code></pre>
<p><img
src="images/curriculum/04-PCAandDimReduction/qc_sct_elbow_plot.png" /></p>
<p>In this plot, we could arbitrarily choose a number along the x-axis
that looks like a sharp change in the variance from one PC to the next,
that is, an elbow. Of course, the choice is not always obvious, and this
plot is no different. We could also try to quantify our choice.</p>
</div>
<div id="using-a-crude-optimization-to-select-a-starting-point"
class="section level3">
<h3>Using a (crude) optimization to select a starting point</h3>
<p>Function to return minimum PCs based on two possible metrics:</p>
<pre class="r"><code># Function to determine optimal PCs after RunPCA()
optimal_pcs = function(so, reduction) {
    # quantitative check for number of PCs to include
    pct = so@reductions[[reduction]]@stdev / sum(so@reductions[[reduction]]@stdev) * 100
    cum = cumsum(pct)
    co1 = which(cum &gt; 90 &amp; pct &lt; 5)[1]
    co2 = sort(which((pct[1:length(pct)-1] - pct[2:length(pct)]) &gt; .1), decreasing = T)[1] + 1
    pcs = min(co1, co2) 
    
    return(pcs)
}</code></pre>
<p>If we apply this function to our data, then we expect a number of PCs
somewhere within the bend of the elbow plot to be returned:</p>
<pre class="r"><code>pcs = optimal_pcs(geo_so, &#39;unintegrated.sct.pca&#39;)
pcs</code></pre>
<pre><code>15</code></pre>
<p>Again, this number is likely a starting point and may need to revise
depending on the outcome of the downstream steps.</p>
<p>While outside the scope of this workshop, there are community efforts
to develop more sophisticated methods to select like the [chooseR
package] or the option to use clustering trees to evaluate the stability
of this parameter choice.</p>
</div>
</div>
</div>
<div id="integrate-layers" class="section level1">
<h1>Integrate Layers</h1>
<p>Having normalized the data with <code>SCTransform()</code> and
performed the dimension reduction with <code>RunPCA()</code>, we are now
ready to integrate our data.</p>
<p>New to Seurat v5 is the improved <code>IntegrateLayers()</code>
function which makes selecting different integration methods much
easier. The results of each alternative integration method are stored
within the same <code>Seurat</code> object, which makes comparing
downstream effects much easier. So, if we wanted to run the slightly
faster <code>RPCAIntegration</code> method, we would run:</p>
<pre class="r"><code>geo_so = IntegrateLayers(
  object = geo_so, 
  method = RPCAIntegration, 
  orig.reduction = &#39;unintegrated.sct.pca&#39;,
  normalization.method = &#39;SCT&#39;,
  new.reduction = &#39;integrated.sct.rpca&#39;)</code></pre>
<p><a
href="https://satijalab.org/seurat/articles/seurat5_integration#perform-streamlined-one-line-integrative-analysis">This
Seurat vignette on integrative analysis in v5</a> provides examples of
each integration method. Note, that the code in this vignette assumes
the
<code>NormalizeData() &gt; ScaleData() &gt; FindVariableFeatures()</code>
pipeline was used and our <code>normalization.method = 'SCT'</code> also
differs.</p>
<p>Note we have specified the unintegrated reduction
<code>unintegrated.sct.pca</code>, which is what
<code>IntegrateLayers()</code> operates on, along with the
<code>SCT</code> assay. Let’s take a look to see what’s different about
the <code>Seurat</code> object:</p>
<pre class="r"><code>geo_so</code></pre>
<pre><code># An object of class Seurat 
# 47037 features across 29615 samples within 2 assays 
# Active assay: SCT (20548 features, 3000 variable features)
#  3 layers present: counts, data, scale.data
#  1 other assay present: RNA
#  2 dimensional reductions calculated: unintegrated.sct.pca, integrated.sct.rpca</code></pre>
<p>Observe that we now have a new reduction,
<code>integrated.sct.cca</code>, which we will use downstream.</p>
<!--- Note: output plot below appears to not reflect integrated data
We can also confirm that our integration method has helped to correct the `Day` effects we saw in the initial PCA plots


```r
DimPlot(geo_so, reduction = 'integrated.sct.pca', group.by = 'day')
ggsave(filename = 'results/figures/qc_pca_plot_integrated_sct_day.png', width = 7, height = 6, units = 'in')
```

![](./images/curriculum/04-PCAandDimReduction/qc_pca_plot_integrated_sct_day.png)

--->
<p>Before we move on, let’s save our updated Seurat object to file:</p>
<pre class="r"><code>saveRDS(object = geo_so, file = &#39;results/rdata/geo_so_sct_integrated.rda&#39;)</code></pre>
<div id="alternate-integration-methods" class="section level2">
<h2>Alternate integration methods</h2>
<p>After normalized the data with <code>SCTransform()</code> and
performed the dimension reduction with <code>RunPCA()</code>,
alternatively we could also use the <code>CCA</code> integration method
with the :</p>
<pre class="r"><code>geo_so = IntegrateLayers(
    object = geo_so, 
    method = CCAIntegration, 
    orig.reduction = &#39;unintegrated.sct.pca&#39;,
    normalization.method = &#39;SCT&#39;,
    new.reduction = &#39;integrated.sct.cca&#39;)</code></pre>
</div>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>In this section, we:</p>
<ul>
<li>Selected a number of principal components that likely correspond to
biological variation of interest in our data</li>
<li>Integrated our <code>SCTransformed</code> data using the
<code>RPCA</code> method</li>
</ul>
<p>Next steps: Clustering and projection</p>
<hr />
<p>These materials have been adapted and extended from materials listed
above. These are open access materials distributed under the terms of
the <a href="http://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution license (CC BY 4.0)</a>, which permits unrestricted
use, distribution, and reproduction in any medium, provided the original
author and source are credited.</p>
<br/> <br/>
<hr/>
<table style="width:100%;">
<colgroup>
<col width="28%" />
<col width="42%" />
<col width="28%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"><a href="03-Integration.html">Previous lesson</a></th>
<th align="center"><a href="#top">Top of this lesson</a></th>
<th align="right"><a href="05-ProjectionAndClustering.html">Next
lesson</a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAiUENBIGFuZCBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24iCmF1dGhvcjogIlVNIEJpb2luZm9ybWF0aWNzIENvcmUiCmRhdGU6ICJgciBTeXMuRGF0ZSgpYCIKb3V0cHV0OgogICAgICAgIGh0bWxfZG9jdW1lbnQ6CiAgICAgICAgICAgIGluY2x1ZGVzOgogICAgICAgICAgICAgICAgaW5faGVhZGVyOiBoZWFkZXIuaHRtbAogICAgICAgICAgICB0aGVtZTogcGFwZXIKICAgICAgICAgICAgdG9jOiB0cnVlCiAgICAgICAgICAgIHRvY19kZXB0aDogNAogICAgICAgICAgICB0b2NfZmxvYXQ6IHRydWUKICAgICAgICAgICAgbnVtYmVyX3NlY3Rpb25zOiBmYWxzZQogICAgICAgICAgICBmaWdfY2FwdGlvbjogdHJ1ZQogICAgICAgICAgICBtYXJrZG93bjogR0ZNCiAgICAgICAgICAgIGNvZGVfZG93bmxvYWQ6IHRydWUKLS0tCgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgpib2R5LCB0ZCB7CiAgIGZvbnQtc2l6ZTogMThweDsKfQpjb2RlLnJ7CiAgZm9udC1zaXplOiAxMnB4Owp9CnByZSB7CiAgZm9udC1zaXplOiAxMnB4Cn0KPC9zdHlsZT4KCmBgYHtyLCBpbmNsdWRlID0gRkFMU0V9CnNvdXJjZSgiLi4vYmluL2NodW5rLW9wdGlvbnMuUiIpCmtuaXRyX2ZpZ19wYXRoKCJYWCIpCmBgYAojIFdvcmtmbG93IE92ZXJ2aWV3IHsudW5saXN0ZWQgLnVubnVtYmVyZWR9Cgo8YnIvPgo8aW1nIHNyYz0iaW1hZ2VzL3dheWZpbmRlci93YXlmaW5kZXIucG5nIiBhbHQ9IndheWZpbmRlciIgc3R5bGU9ImhlaWdodDogNDAwcHg7Ii8+Cjxici8+Cjxici8+CgoKCiMgSW50cm9kdWN0aW9uIAoKT25lIG9mIG91ciB1bHRpbWF0ZSBnb2FscyBpcyB0byBjbHVzdGVyIHRoZSBjZWxscyBhY2NvcmRpbmcgdG8gdGhlaXIgZXhwcmVzc2lvbiBwcm9maWxlcywgYW5kIGRldGVybWluZSB3aGF0IGNlbGwgdHlwZXMgY29ycmVzcG9uZCB0byB0aGVzZSBjbHVzdGVycyBmb3IgdGhlIHB1cnBvc2VzIG9mIGRpZmZlcmVudGlhbCBleHByZXNzaW9uIGJldHdlZW4gY2x1c3RlcnMgYW5kL29yIGJldHdlZW4gY29uZGl0aW9ucyB3aXRoaW4gY2x1c3RlcnMuICBIb3dldmVyLCBmb3Igb3VyIGRhdGEgd2Ugc2F3IHRoYXQgb3VyIDEyIHNhbXBsZXMgY29udGFpbiAxSyAtIDNLIGNlbGxzIGVhY2ggd2l0aCBtZWFzdXJlbWVudHMgYWNyb3NzIDIxSyBnZW5lcywgYW5kIHNpbmdsZSBjZWxsIGV4cGVyaW1lbnRzIGNhbiBnZW5lcmF0ZSB1cCB0byAxMEsgLTEySyBjZWxscyBwZXIgc2FtcGxlLgoKVGhpcyBtZWFucyB0aGF0IGV2ZW4gYWZ0ZXIgZmlsdGVyaW5nIHRoZSBkYXRhLCB3ZSBhcmUgd29ya2luZyB2ZXJ5ICJoaWdoLWRpbWVuc2lvbmFsIiBkYXRhLiBIaWdoIGRpbWVuc2lvbmFsIGRhdGEgcHJlc2VudHMgc29tZSBtYWpvciBjaGFsbGVuZ2VzIGFuZCByZXF1aXJlcyBzb21ldGhpbmcgY2FsbGVkIGRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbi4gRGltZW5zaW9uIHJlZHVjdGlvbiBoZWxwcyB1cyByZWR1Y2UgdGhlIG51bWJlciBvZiBzZXBhcmF0ZSBkaW1lbnNpb25zIGJ5IGdyb3VwaW5nIGNvcnJlbGF0ZWQgZmVhdHVyZXMgaW50byBhIHNpbmdsZSBkaW1lbnNpb24uIFRoaXMgbWFrZXMgZG93bnN0cmVhbSBhbmFseXNpcyBzdGVwcyBtb3JlIGNvbXB1dGF0aW9uYWxseSBmZWFzaWJsZS4KClNpbWlsYXIgdG8gdGhlIHByZXZpb3VzIHNlY3Rpb25zLCB0aGUgcHJvY2VzcyBvZiBzZWxlY3RpbmcgaW5mb3JtYXRpdmUgZGltZW5zaW9ucyBpbiBhIGRhdGFzZXQgaXMgb2Z0ZW4gaXRlcmF0aXZlLCBidXQgb25seSBhIHNpbmdsZSB2YWx1ZSBpcyBsaWtlbHkgdG8gYmUgcmVwb3J0ZWQgZXZlbiB3aGVuIG11bHRpcGxlIHBhcmFtZXRlciBjaG9pY2VzIG1heSBoYXZlIGxlYWQgdG8gc2ltaWxhciByZXN1bHRzL2NvbmNsdXNpb25zLiAgCgpJbiB0aGlzIHNlY3Rpb24sIHdlIHdpbGwgZGVtb25zdHJhdGUgdGhlIHN0ZXBzIHRvIHBlcmZvcm0gZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uIG9uIG91ciBkYXRhIHVzaW5nIHByaW5jaXBhbCBjb21wb25lbnQgYW5hbHlzaXMgKFBDQSkuCgoKIyMgT2JqZWN0aXZlcwoKLSBVbmRlcnN0YW5kIHdoeSB3ZSB1c2UgUENBIGZvciBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24KLSBDaG9vc2UgYW4gYXBwcm9wcmlhdGUgbnVtYmVyIG9mIHByaW5jaXBhbCBjb21wb25lbnRzIHRvIGNsdXN0ZXIgb3VyIGRhdGEKCi0tLQoKCiMgRGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uCgo8IS0tQmVmb3JlIHRoaXMgc2VjdGlvbiAtIERheSAxOiBTdGFydGluZyB3LyBTZXVyYXQsIEluaXRpYWwgUUMsICYgQmF0Y2ggY29ycmVjdGlvbiAoU0N0cmFuc2Zvcm0pLS0+Cgo8IS0tSW5zdHJ1Y3Rpb24gTm90ZTogVXNpbmcgaW50ZWdyYXRlZCBkYXRhIGhlcmUgYW5kIHdpbGwgY29tcGFyZSB0byB1bmludGVncmF0ZWQgcmVzdWx0cyBpbiBuZXh0IHNlY3Rpb24sIHNpbWlsYXIgdG8gIFtoZXJlXShodHRwczovL2JtY2Jpb2luZm9ybWF0aWNzLmJpb21lZGNlbnRyYWwuY29tL2FydGljbGVzLzEwLjExODYvczEyODU5LTAyMS0wMzk1Ny00KT8tLT4KCkluIGFkZGl0aW9uIHRvIHRoZSAiaGlnaC1kaW1lbnNpb25hbGl0eSIgZXhwZWN0ZWQgZm9yIHNpbmdsZS1jZWxsIGRhdGEsIHdlIGV4cGVjdCB0aGUgZGF0YSB0byBiZSBib3RoICJzcGFyc2UiIGFuZCAibm9pc3kiLiBTcGFyc2UgaW4gdGhlIHNlbnNlIHRoYXQgbWFueSBnZW5lcyB3aWxsIGVpdGhlciBub3QgYmUgZXhwcmVzc2VkIG9yIG5vdCBtZWFzdXJlZCBpbiBtYW55IG9mIHRoZSBjZWxscyBhbmQgaGF2ZSB6ZXJvIHZhbHVlcy4gTm9pc3kgZHVlIHRvIGJpb2xvZ2ljYWwgdmFyaWFiaWxpdHkgYW5kIHByYWN0aWNhbCBsaW1pdGF0aW9ucyBvZiBib3RoIGNhcHR1cmUgYW5kIHNlcXVlbmNpbmcgZGVwdGggW3NvdXJjZV0oaHR0cHM6Ly9vdXlhbmdsYWIuY29tL3NpbmdsZWNlbGwvYmFzaWMuaHRtbCNhLWdlbnRsZS1pbnRyb2R1Y3Rpb24tdG8tZHIpLgoKPiAjIyMjIFplcm8gImluZmxhdGlvbiIgb2Ygc2luZ2xlLWNlbGwgZGF0YXsudW5saXN0ZWQgLnVubnVtYmVyZWR9Cj4KPiBTaW5nbGUtY2VsbCBkYXRhIGlzIHNvbWV0aW1lcyBkZXNjcmliZWQgYXMgInplcm8gaW5mbGF0ZWQiLCBob3dldmVyIHdvcmsgYnkgW1N2ZW5zc29uXShodHRwczovL3d3dy5iaW9yeGl2Lm9yZy9jb250ZW50LzEwLjExMDEvNTgyMDY0djEuZnVsbCkgaGFzIGNoYWxsZW5nZWQgdGhhdCBjaGFyYWN0ZXJpemF0aW9uIGFuZCBhcmd1ZWQgdGhhdCB0aGUgaGlnaGVyIG51bWJlciBvZiB6ZXJvcyBvYnNlcnZlZCBpbiBzY1JOQS1zZXEgY29tcGFyZWQgdG8gYnVsayBSTkEtc2VxIGlzIG1vcmUgbGlrZWx5IGR1ZSB0byBiaW9sb2dpY2FsIHZhcmlhbmNlIGFuZCBsb3dlciBzZXF1ZW5jaW5nIHNhdHVyYXRpb24gdGhhbiBhIHRlY2huaWNhbCBhcnRpZmFjdC4KCkZvciBzcGFyc2UsIGhpZ2gtZGltZW5zaW9uYWwsIF9iaW9sb2dpY2FsXyBkYXRhLCB3ZSBleHBlY3QgbWFueSBnZW5lcyB0byBoYXZlIGNvcnJlbGF0ZWQgZXhwcmVzc2lvbiBhcyB0aGV5IHdvdWxkIGJlIGltcGFjdGVkIGJ5IHRoZSBzYW1lIGJpb2xvZ2ljYWwgcHJvY2VzcyBhbmQgZm9yIG1hbnkgZ2VuZXMgd2l0aCBlaXRoZXIgbG93IChtb3JlIG5vaXN5KSBvciBzaW1pbGFyIGV4cHJlc3Npb24gYWNyb3NzIHRoZSBjZWxsIHBvcHVsYXRpb24uIAoKU28gaG93IGRvIHdlIGRldGVybWluZSB3aGF0IGFuZCBob3cgbWFueSBnZW5lcyB0byB1c2UgYmVmb3JlIGNsYXNzaWZ5aW5nIGNlbGxzIGluIG91ciBzYW1wbGVzIGludG8gY2VsbC10eXBlcy9zdWJ0eXBlcyBiYXNlZCBvbiB0aGVpciBleHByZXNzaW9uPwoKPGRldGFpbHM+CiAgICA8c3VtbWFyeT4qTW9yZSBkZXRhaWwgb24gZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uICo8L3N1bW1hcnk+CiAgICBUaGUgW091eWFuZyBMYWIgaGFzIGEgImdlbnRsZSBpbnRyb2R1Y3Rpb24iIHNlY3Rpb24gb2YgdGhlaXIgbWF0ZXJpYWxzXShodHRwczovL291eWFuZ2xhYi5jb20vc2luZ2xlY2VsbC9iYXNpYy5odG1sI2EtZ2VudGxlLWludHJvZHVjdGlvbi10by1kcikgdGhhdCBnb2VzIGludG8gZ3JlYXRlciBkZXRhaWxzIG9uIGRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbiBpbmNsdWRpbmcgaG93IHNpbWlsYXIgc3RyYXRlZ2llcyBhcmUgdXNlZCBpbiBkZWVwIGxlYXJuaW5nIG1vZGVscy4gQWRkaXRpb25hbHksIHRoZSBPU0NBIGJvb2sgaGFzIGEgW2NoYXB0ZXIgb24gRGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uKGh0dHBzOi8vYmlvY29uZHVjdG9yLm9yZy9ib29rcy8zLjE1L09TQ0EuYmFzaWMvZGltZW5zaW9uYWxpdHktcmVkdWN0aW9uLmh0bWwpCjwvZGV0YWlscz4KPGJyPgoKCgojIyBXaGF0IGlzIFBDQT8KCjwhLS0tIEdpdmUgc29tZSBjb250ZXh0IGFuZCBiYWNrZ3JvdW5kIG9uIFBDQQotIFdoYXQgaXMgUENBCi0gV2h5IGRvIHdlIHVzZSBpdCAKLS0tPgoKUHJpbmNpcGFsIGNvbXBvbmVudCBhbmFseXNpcyAoUENBKSBkZXRlcm1pbmVzIGF4ZXMgaW4gaGlnaC1kaW1lbnNpb25hbCBzcGFjZSB0aGF0IGNhcHR1cmUgdGhlIG1vc3QgdmFyaWF0aW9uLiAKCiMjIyBQQ0EgZXhhbXBsZQoKVG8gdW5kZXJzdGFuZCBob3cgUENBIHdvcmtzLCB3ZSBjYW4gY29uc2lkZXIgYSBzbWFsbGVyIGRhdGFzZXQgbWVhc3VyaW5nIHRoZSBleHByZXNzaW9uIG9mIGZvdXIgZ2VuZXMgbWVhc3VyZWQgaW4ganVzdCB0d28gY2VsbHMsIHdlIGNvdWxkIHBsb3QgdGhlIGV4cHJlc3Npb24gb2YgdGhvc2UgZm91ciBnZW5lcywgd2l0aCBkYXRhIGZyb20gb25lIGNlbGwgcGxvdHRlZCBvbiB0aGUgeC1heGlzIGFuZCB0aGUgc2Vjb25kIGNlbGwgcGxvdHRlZCBvbiB0aGUgeS1heGlzLgoKIVtBIHNpbXBsZSBQQ0EgZXhhbXBsZSAoZnJvbSBIQkMpXSguL2ltYWdlcy9jdXJyaWN1bHVtLzA0LVBDQWFuZERpbVJlZHVjdGlvbi9IQkMtUENBXzJzYW1wbGVfZ2VuZXMucG5nKQo8IS0tLSBVcGRhdGUgcGxvdCB0byByZXBsYWNlICJTYW1wbGUiIHdpdGggY2VsbCBpbiBmaWd1cmUgYW5kIHRhYmxlIC0tLT4KCklmIHdlIHdhbnRlZCB0byByZXByZXNlbnQgdGhlIG1vc3QgdmFyaWF0aW9uIGFjcm9zcyB0aGUgZGF0YSwgd2Ugd291bGQgZHJhdyBhIGRpYWdvbmFsIGxpbmUgYmV0d2VlbiBnZW5lIEIgYW5kIGdlbmUgQyAtIHRoaXMgd291bGQgcmVwcmVzZW50IHRoZSBmaXJzdCBwcmluY2lwYWwgY29tcG9uZW50LiBIb3dldmVyLCB0aGlzIGxpbmUgZG9lc24ndCBjYXB0dXJlIGFsbCB0aGUgdmFyaWFuY2UgaW4gdGhpcyBkYXRhIGFzIHRoZSBnZW5lcyBhbHNvIHZhcnkgYWJvdmUgYW5kIGJlbG93IHRoZSBsaW5lLCBzbyB3ZSBjb3VsZCBkcmF3IGFub3RoZXIgbGluZSAoYXQgYSByaWdodCBhbmdsZSB0byB0aGUgZmlyc3QpIHJlcHJlc2VudGluZyB0aGUgc2Vjb25kIG1vc3QgdmFyaWF0aW9uIGludCB0aGUgZGF0YSAtIHdoaWNoIHdvdWxkIHJlcHJlc2VudCB0aGUgc2Vjb25kIHByaW5jaXBhbCBjb21wb25lbnQgKFBDKS4gCgpIb3dldmVyLCBhcyB3ZSBjYW4gc2VlIGluIHRoZSBleGFtcGxlIGJlbG93LCBnZW5lcyBuZWFyIHRoZSBlbmQgb2YgZWFjaCBsaW5lIGFyZSB0aG9zZSB3aXRoIHRoZSBncmVhdGVzdCBpbmZsdWVuY2Ugb24gdGhlIGRpcmVjdGlvbiBhbmQgbGVuZ3RoIG9mIHRoZSBQQy4KCiFbUENBIGdlbmUgbG9hZGluZ3MgKGZyb20gSEJDKV0oLi9pbWFnZXMvY3VycmljdWx1bS8wNC1QQ0FhbmREaW1SZWR1Y3Rpb24vSEJDLVBDQV8yc2FtcGxlX3ZhcmlhdGlvbjMucG5nKQo8IS0tLSBVcGRhdGUgcGxvdCB0byByZXBsYWNlICJTYW1wbGUiIHdpdGggY2VsbCBpbiBmaWd1cmUgLS0tPgoKV2UnbGwgc2tpcCB0aGUgcHJvY2VzcyBvZiBjYWxjdWxhdGluZyB0aGUgc2NvcmUgZm9yIGVhY2ggY2VsbCBwZXIgUEMsIGJ1dCBhZnRlciBydW5uaW5nIFBDQSBvbiBvdXIgZGF0YSB3ZSBleHBlY3QgZWFjaCBjZWxsIHRvIGhhdmUgYSBzY29yZSBiYXNlZCBvbiB0aGUgZXhwcmVzc2lvbiBvZiB0aGUgZ2VuZXMgY29udHJpYnV0aW5nIHRvIGVhY2ggUEMgYW5kIGVhY2ggZ2VuZSB3aWxsIGhhdmUgYSB3ZWlnaHQgb3IgbG9hZGluZy4gQnkgZGVmaW5pdGlvbiwgdGhlIFBDcyBjYXB0dXJlIHRoZSBncmVhdGVzdCBmYWN0b3JzIG9mIGhldGVyb2dlbmVpdHkgaW4gZGVjcmVhc2luZyBvcmRlciBpbiB0aGUgZGF0YSBzZXQuIAoKIyMjIFdoeSBQQ0EgaXMgdXNlZnVsIGZvciBzaW5nbGUtY2VsbCBkYXRhCgpJbiBjb250cmFzdCB0byBidWxrIFJOQS1zZXEsIHdoZXJlIHRoZSBtYWpvcml0eSBvZiB0aGUgdmFyaWFuY2UgaW4gYSBnaXZlbiBkYXRhc2V0IGFyZSB1c3VhbGx5IGV4cGxhaW5lZCBieSB0aGUgZmlyc3QgYW5kIHNlY29uZCBQQywgd2UgZXhwZWN0IHRoYXQgbWFueSBtb3JlIFBDcyBhcmUgY29udHJpYnV0aW5nIHRvIHRoZSBvdmVyYWxsIHZhcmlhbmNlIGluIGEgc2luZ2xlLWNlbGwgZGF0YSBzZXQuIAoKSG93ZXZlciwgd2UgY2FuIGFzc3VtZSB0aGF0IGJpb2xvZ2ljYWwgcHJvY2Vzc2VzIGFmZmVjdCBtdWx0aXBsZSBnZW5lcyBpbiBhIGNvb3JkaW5hdGVkIHdheS4gVGhlcmVmb3JlIHRoZSB0b3AgUENzIGxpa2VseSByZXByZXNlbnQgYmlvbG9naWNhbCBzdHJ1Y3R1cmUgcmF0aGVyIHRoYW4gcmFuZG9tIHRlY2huaWNhbCBvciBiaW9sb2dpY2FsIG5vaXNlLCB3aGljaCBhZmZlY3RzIGVhY2ggZ2VuZSBpbmRlcGVuZGVudGx5IGFuZCBhbmQgd2UgY2FuIHVzZSB0aGUgdG9wIHNldmVyYWwgUENzIHRvIGFwcHJveGltYXRlIHRoZSBmdWxsIGRhdGEgc2V0IGluIGRvd25zdHJlYW0gYW5hbHlzaXMgKFtzb3VyY2VdKGh0dHBzOi8vYmlvY29uZHVjdG9yLm9yZy9ib29rcy8zLjEyL09TQ0EvZGltZW5zaW9uYWxpdHktcmVkdWN0aW9uLmh0bWwjcHJpbmNpcGFsLWNvbXBvbmVudHMtYW5hbHlzaXMpKS4KClRoaXMgcmVkdWN0aW9uIGluIGRpbWVuc2lvbmFsaXR5LCBmcm9tIDEwLDAwMCBjZWxscyB4IDE5LDAwMCBnZW5lcywgZm9yIGV4YW1wbGUsIHRvIHNldmVyYWwgb3JkZXIgbWFnbml0dWRlcyBsZXNzIG9mIFBDcyAob2Z0ZW4gMzAtNjAgUENzIHdpbGwgYmUgY29uc2lkZXJlZCkgYW5kIGFsbG93cyB1cyB0byBzZWxlY3QgUENzIHRoYXQgYXJlIG1vcmUgbGlrZWx5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gYmlvbG9naWNhbCB2YXJpYXRpb24gcmVsYXRlZCB0byB0aGUgZXhwZWN0ZWQgY2VsbCB0eXBlcy9zdWJ0eXBlcyBhbmQgKGNvbmZvdW5kaW5nKSB0ZWNobmljYWwgdmFyaWF0aW9uLgoKPiAjIyMjIE1vcmUgY29udGV4dCB1c2luZyBQQ0EgZm9yIHNpbmdsZS1jZWxsIGRhdGEgey51bmxpc3RlZCAudW5udW1iZXJlZH0KPgo+IFRvIHJlYWQgbW9yZSBvbiBQQ0EsIHBsZWFzZSByZWZlciB0byB0aGUgW0hCQyAtIFRoZW9yeSBvZiBQQ0EgY29udGVudF0oaHR0cHM6Ly9oYmN0cmFpbmluZy5naXRodWIuaW8vc2NSTkEtc2VxX29ubGluZS9sZXNzb25zLzA1X3RoZW9yeV9vZl9QQ0EuaHRtbCksIGZyb20gd2hpY2ggdGhpcyBzZWN0aW9uIGlzIGFkYXB0ZWQgYW5kIHRoZSBvcmlnaW5hbCBzb3VyY2UgbWF0ZXJpYWwgZm9yIHRoYXQgY29udGVudCwgc3BlY2lmaWNhbGx5IFtKb3NoIFN0YXJtZXIncyBTdGF0UXVlc3QgdmlkZW9dKGh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9X1VWSG5lQlVCVzApLiBGb3IgYWRkaXRpb25hbCBkZXRhaWwsIHRoZSBPU0NBIGNoYXB0ZXIgb24gW1ByaW5jaXBhbCBjb21wb25lbnRzIGFuYWx5c2lzXShodHRwczovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xNS9PU0NBLmJhc2ljL2RpbWVuc2lvbmFsaXR5LXJlZHVjdGlvbi5odG1sKSBpbmNsdWRlcyBhIG1vcmUgZGVzY3JpcHRpdmUgb3ZlcnZpZXcgb2YgUENBIGluIHRoZSBjb250ZXh0IG9mIHNpbmdsZS1jZWxsIGRhdGEuCgojIyMgUnVuIFBDQSBvbiBvdXIgZGF0YXNldAoKPCEtLS0gQWRkIGludHJvZHVjdGlvbiB0byBmdW5jdGlvbiwgaW5jbHVkaW5nIGxpbmsgdG8gZG9jdW1lbnRhdGlvbiAtLS0+CgpTaW5jZSBQQ0EgaXMgc2Vuc2l0aXZlIHRvIHNjYWxlLCB3ZSB3aWxsIHJ1biBpdCBvbiB0aGUgU0NUIG5vcm1hbGl6ZWQgYXNzYXkgKFtyZWZlcmVuY2VdKGh0dHBzOi8vb3V5YW5nbGFiLmNvbS9zaW5nbGVjZWxsL2Jhc2ljLmh0bWwjcGNhLXByaW5jaXBhbC1jb21wb25lbnQtYW5hbHlzaXMpKS4gV2Ugd2lsbCBuYW1lIHRoZSByZWR1Y3Rpb24gaW4gYW4gaW5mb3JtYXRpdmUgd2F5IHRvIGtlZXAgdGhlbSBjbGVhciBmb3IgdXMgaW4gdGhlIGZ1dHVyZS4gSW4gdGhpcyBjYXNlLCBvdXIgZGF0YSBoYXMgbm90IHlldCBiZWVuIGludGVncmF0ZWQsIGJ1dCBpdCBoYXMgYmVlbiBTQ1Qgbm9ybWFsaXplZC4gU28gd2Ugd2lsbCBuYW1lIHRoZSByZWR1Y3Rpb24gYHVuaW50ZWdyYXRlZC5zY3QucGNhYC4gTm90ZSB0aGF0IGBTQ1RUcmFuc2Zvcm0oKWAgcmV0dXJuZWQgYSBzZXQgb2YgaGlnaGx5IHZhcmlhYmxlIGdlbmVzLCBhbmQgdGhlIGBSdW5QQ0EoKWAgZnVuY3Rpb24gd2lsbCB1c2UgdGhpcyBzdWJzZXQgdG8gZGV0ZXJtaW5lIHRoZSBQQ3MgYW5kIGdlbmVzIGFzc29jaWF0ZWQgd2l0aCB0aG9zZSBQQ3MuCgpgYGB7ciwgZXZhbD1GQUxTRX0KZ2VvX3NvID0gUnVuUENBKGdlb19zbywgcmVkdWN0aW9uLm5hbWUgPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnKQpgYGAKCkluIHRoZSBjb25zb2xlLCB0aGUgZmlyc3QgNSBQQ3MgYXJlIGxpc3RlZCBhbG9uZyB3aXRoIHRoZSBhc3NvY2lhdGVkIGdlbmVzLiBJZiB3ZSBsb29rIGF0IHRoZSBgZ2VvX3NvYCBvYmplY3QsIHdlJ2xsIHNlZSBvdXIgZGltZW5zaW9uIHJlZHVjdGlvbjoKYGBge3IsIGV2YWwgPSBGQUxTRX0KZ2VvX3NvCmBgYAp+fn4KQW4gb2JqZWN0IG9mIGNsYXNzIFNldXJhdCAKMzg1MDMgZmVhdHVyZXMgYWNyb3NzIDIyMzIwIHNhbXBsZXMgd2l0aGluIDIgYXNzYXlzIApBY3RpdmUgYXNzYXk6IFNDVCAoMTcxMjkgZmVhdHVyZXMsIDMwMDAgdmFyaWFibGUgZmVhdHVyZXMpCiAzIGxheWVycyBwcmVzZW50OiBjb3VudHMsIGRhdGEsIHNjYWxlLmRhdGEKIDEgb3RoZXIgYXNzYXkgcHJlc2VudDogUk5BCiAxIGRpbWVuc2lvbmFsIHJlZHVjdGlvbnMgY2FsY3VsYXRlZDogdW5pbnRlZ3JhdGVkLnNjdC5wY2EKfn5+CgoKPCEtLS0gU2hvdWxkIHRoaXMgZGltIGxvYWRpbmcgc2VjdGlvbiBkcmF3biBmcm9tIFtIbyBMYWJdKGh0dHBzOi8vaG9sYWItaGt1LmdpdGh1Yi5pby9GdW5kYW1lbnRhbC1zY1JOQS9kb3duc3RyZWFtLmh0bWwjc3RhbmRhcmQtcHJlLXByb2Nlc3Npbmctd29ya2Zsb3cpIGJlIGluY2x1ZGVkIGluIHRoZSBtYWluIGNvbnRlbnQ/IE5vdGUgLSB3b3VsZCBuZWVkIHRvIHJ1biBjb21tYW5kIGluIHNjcmlwdCAmIGNhcHR1cmUgb3V0cHV0ICAtLS0+CgpXZSBjYW4gYWxzbyB2aXN1YWxpemUgYm90aCB0aGUgY2VsbCBhbmQgZ2VuZSBmZWF0dXJlcyB0aGF0IGRlZmluZSBlYWNoIHByaW5jaXBhbCBjb21wb25lbnRzIHVzaW5nIFNldXJhdCBwcm92aWRlZCBmdW5jdGlvbnMgW3NvdXJjZV0oaHR0cHM6Ly9ob2xhYi1oa3UuZ2l0aHViLmlvL0Z1bmRhbWVudGFsLXNjUk5BL2Rvd25zdHJlYW0uaHRtbCNwZXJmb3JtLWxpbmVhci1kaW1lbnNpb25hbC1yZWR1Y3Rpb24pLgoKRmlyc3QsIHdlIGNhbiBwcmludCBvdXQgdGhlIHRvcCA1IChnZW5lKSBmZWF0dXJlcyBwZXIgZGltZW5zaW9uIGJ5IGFjY2Vzc2luZyB0aGF0IHBhcnQgb2YgdGhlIFNldXJhdCBvYmplY3Q6CmBgYHtyLCBldmFsPUZBTFNFfQpwcmludChnZW9fc29bWyd1bmludGVncmF0ZWQuc2N0LnBjYSddXSwgZGltcyA9IDE6NSwgbmZlYXR1cmVzID0gNSkKYGBgCgp+fn4KUENfIDEgClBvc2l0aXZlOiAgQ29sMWExLCBDb2wzYTEsIENvbDFhMiwgU3BhcmMsIERjbiAKTmVnYXRpdmU6ICBMeXoyLCBDZDc0LCBBcG9lLCBIMi1BYSwgQzFxYiAKUENfIDIgClBvc2l0aXZlOiAgQ29sMWExLCBDb2wzYTEsIENvbDFhMiwgRGNuLCBMeXoyIApOZWdhdGl2ZTogIEZhYnA0LCBBcXAxLCBQZWNhbTEsIEVnZmw3LCBGbHQxIApQQ18gMyAKUG9zaXRpdmU6ICBBcG9lLCBGYWJwNCwgQzFxYiwgTHl6MiwgQzFxYSAKTmVnYXRpdmU6ICBFZWYxYTEsIFJwczI4LCBNeWw2LCBTbGMyNWE0LCBScGwxMyAKUENfIDQgClBvc2l0aXZlOiAgQXBvZSwgUGY0LCBDMXFhLCBDMXFiLCBDY2w4IApOZWdhdGl2ZTogIENkNzQsIEgyLUFiMSwgSDItQWEsIEgyLUViMSwgQWN0YTIgClBDXyA1IApQb3NpdGl2ZTogIEFjdGEyLCBSZ3M1LCBUYWdsbiwgTXlsOSwgQXBvZSAKTmVnYXRpdmU6ICBDZDc0LCBIMi1BYjEsIEgyLUFhLCBIMi1FYjEsIElsMWIKfn5+CgoKV2UgY2FuIGFsc28gaGlnaGxpZ2h0IGdlbmVzIGxvYWRlZCBmb3IgZWFjaCBkaW1lbnNpb24gdXNpbmcgYSB2aXN1YWxpemF0aW9uOgpgYGB7ciwgZXZhbD1GQUxTRX0KVml6RGltTG9hZGluZ3MoZ2VvX3NvLCBkaW1zID0gMToyLCByZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnKQpnZ3NhdmUoZmlsZW5hbWUgPSAncmVzdWx0cy9maWd1cmVzL3FjX3BjYV9sb2FkaW5ncy5wbmcnLCB3aWR0aCA9IDEyLCBoZWlnaHQgPSA2LCB1bml0cyA9ICdpbicpCmBgYAoKIVtdKC4vaW1hZ2VzL2N1cnJpY3VsdW0vMDQtUENBYW5kRGltUmVkdWN0aW9uL3FjX3BjYV9sb2FkaW5ncy5wbmcpCgoKV2UgY2FuIGxvb2sgYXQgaG93IGNlbGxzIGxvYWQgb24gdGhlIGZpcnN0IHR3byBwcmluY2lwYWwgY29tcG9uZW50cywgc2ltaWxhcmx5IHRvIGhvdyB3ZSBvZnRlbiBsb29rIGF0IHNhbXBsZXMgZm9yIGJ1bGsgUk5BLXNlcSwgd2l0aCB0aGUgYERpbVBsb3RgIGZ1bmN0aW9uOgpgYGB7ciwgZXZhbD1GQUxTRX0KRGltUGxvdChnZW9fc28sIHJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScsIGdyb3VwLmJ5ID0gJ2RheScpCmdnc2F2ZShmaWxlbmFtZSA9ICdyZXN1bHRzL2ZpZ3VyZXMvcWNfcGNhX3Bsb3RfdW5pbnRlZ3JhdGVkX3NjdF9kYXkucG5nJywgd2lkdGggPSA3LCBoZWlnaHQgPSA2LCB1bml0cyA9ICdpbicpCmBgYAoKIVtdKC4vaW1hZ2VzL2N1cnJpY3VsdW0vMDQtUENBYW5kRGltUmVkdWN0aW9uL3FjX3BjYV9wbG90X3VuaW50ZWdyYXRlZF9zY3RfZGF5LnBuZykKCkxhc3RseSwgYSBjb21tb24gdmlzdWFsaXphdGlvbiB1c2VkIGluIFNldXJhdCB0dXRvcmlhbHMgaXMgYERpbUhlYXRtYXAoKWAsIHdoaWNoIG9yZGVycyBib3RoIGNlbGxzIGFuZCBmZWF0dXJlcyBhY2NvcmRpbmcgdG8gdGhlaXIgUENBIHNjb3JlcyBhbmQgYWxsb3dzIHVzIHRvIHNlZSBzb21lIGdlbmVyYWwgcGF0dGVybnMgaW4gdGhlIGRhdGE6CmBgYHtyLCBldmFsPUZBTFNFfQpEaW1IZWF0bWFwKGdlb19zbywgZGltcz0xOjMsIGNlbGxzPTUwMCwgYmFsYW5jZWQ9VFJVRSkKYGBgCgohW10oLi9pbWFnZXMvY3VycmljdWx1bS8wNC1QQ0FhbmREaW1SZWR1Y3Rpb24vcWNfcGNhX2hlYXRtYXAucG5nKQoKU2luY2UgdGhlIGhlYXRtYXAgaXNuJ3QgYSBnZ3Bsb3QsIHdlIG5lZWQgdG8gdXNlIGEgbW9yZSBnZW5lcmFsIG91dHB1dCBmdW5jdGlvbiB0byBzYXZlIGl0IHRvIGZpbGUKYGBge3IsIGV2YWw9RkFMU0V9CnBuZyhmaWxlbmFtZSA9ICdyZXN1bHRzL2ZpZ3VyZXMvcWNfcGNhX2hlYXRtYXAucG5nJywgd2lkdGggPSAxMiwgaGVpZ2h0ID0gNCwgdW5pdHMgPSAnaW4nLCByZXMgPSAzMDApCkRpbUhlYXRtYXAoZ2VvX3NvLCBkaW1zPTE6MywgY2VsbHM9NTAwLCBiYWxhbmNlZD1UUlVFLCByZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnKQpkZXYub2ZmKCkKYGBgCgo+ICMjIyMgSG93IGRvZXMgU2V1cmF0IHVzZSBQQ0Egc2NvcmVzPyB7LnVubGlzdGVkIC51bm51bWJlcmVkfQo+IAo+IFBlciB0aGUgW0hvIExhYidzIG1hdGVyaWFsc10oaHR0cHM6Ly9ob2xhYi1oa3UuZ2l0aHViLmlvL0Z1bmRhbWVudGFsLXNjUk5BL2Rvd25zdHJlYW0uaHRtbCNwZXJmb3JtLWxpbmVhci1kaW1lbnNpb25hbC1yZWR1Y3Rpb24pIC0gIlRvIG92ZXJjb21lIHRoZSBleHRlbnNpdmUgdGVjaG5pY2FsIG5vaXNlIGluIGFueSBzaW5nbGUgZmVhdHVyZSBmb3Igc2NSTkEtc2VxIGRhdGEsIFNldXJhdCBjbHVzdGVycyBjZWxscyBiYXNlZCBvbiB0aGVpciBQQ0Egc2NvcmVzLCB3aXRoIGVhY2ggUEMgZXNzZW50aWFsbHkgcmVwcmVzZW50aW5nIGEg4oCYbWV0YWZlYXR1cmXigJkgdGhhdCBjb21iaW5lcyBpbmZvcm1hdGlvbiBhY3Jvc3MgYSBjb3JyZWxhdGVkIGZlYXR1cmUgc2V0LiBUaGUgdG9wIHByaW5jaXBhbCBjb21wb25lbnRzIHRoZXJlZm9yZSByZXByZXNlbnQgYSByb2J1c3QgY29tcHJlc3Npb24gb2YgdGhlIGRhdGFzZXQuIiAKPCEtLSBOb3RlLCBtYXkgd2FudCB0byBlZGl0L3JlbW92ZSBhYm92ZSBzZWN0aW9uIC0tPgoKIyMgQ2hvb3NpbmcgdGhlIG51bWJlciBvZiBzaWduaWZpY2FudCBQQ3MgZm9yIGRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbgoKPCEtLSBTZWN0aW9uIHN0aWxsIG5lZWRzIHRvIGJlIGVkaXRlZCBtb3JlICYgY29uc2lkZXIgYWRkaW5nIGEgZmlndXJlIC0tPiAKV2h5IG5vdCB1c2UgZXZlcnkgcHJpbmNpcGFsIGNvbXBvbmVudCBnZW5lcmF0ZWQgZm9yIHRoaXMgZGF0YXNldD8gVXNpbmcgdG9vIG1hbnkgUENzIHJpc2tzIGluY2x1ZGluZyB1bmludGVyZXN0aW5nIHRlY2huaWNhbCB2YXJpYXRpb24gYW5kIGEgc2luZ2xlIGNlbGwgaXRzZWxmIGlzIG5vdCBhIHJlYXNvbmFibGUgZnVuY3Rpb25hbCB1bml0IGZvciBtb3N0IGJpb2xvZ3kuIAoKQSBnb29kIHN0YXJ0aW5nIHBvaW50IGZvciBkZXRlcm1pbmluZyBob3cgbWFueSBQQ3MgdG8gc2VsZWN0IGZvciB5b3VyIHNpbmdsZS1jZWxsIGFuYWx5c2lzIGlzIHRvIHVuZGVyc3RhbmQgdGhlICJyZXNvbHV0aW9uIiBvZiB5b3VyIGJpb2xvZ2ljYWwgcXVlc3Rpb24uIElzIGFuc3dlcmluZyB5b3VyIGJpb2xvZ2ljYWwgcXVlc3Rpb24gZGVwZW5kZW50IG9uIGlkZW50aWZ5aW5nIHJhcmVyIGNlbGwgdHlwZXMgb3Igc3BlY2lmaWMgc3VidHlwZXM/IE9yIGFyZSBicm9hZGVyIGNlbGwtdHlwZXMgbW9yZSByZWxldmFudD8KCkZvciB0aGlzIGRhdGFzZXQsIHdlIGFyZSBleHBlY3RpbmcgYSBkaXZlcnNpdHkgb2YgY2VsbCB0eXBlcyBhbmQgdGhlIGNlbGwgcG9wdWxhdGlvbnMgdGhhdCBtZWRpYXRlIHdvdW5kIGhlYWxpbmcsIG9yIHRoYXQgYXJlIHBhcnQgb2YgdGhlIGFiZXJyYW50IHRyYW5zaXRpb24gdG8gYm9uZSwgbWlnaHQgYmUgbW9yZSByYXJlIGluIHRoZSBwb3B1bGF0aW9uIHNvIGFmdGVyIGV2YWx1YXRpbmcgdGhlIHJlbGF0aXZlIGNvbnRyaWJ1dGlvbnMgYWNyb3NzIHRoZSBmaXJzdCBzZXQgb2YgUENzLCB3ZSBtaWdodCB3YW50IHRvIGNvbnNpZGVyIHNlbGVjdGluZyB0b28gbWFueSByYXRoZXIgdGhhbiB0b28gZmV3IFBDcyB0byBzdGFydC4KCgo8IS0tIFNlY3Rpb24gc3RpbGwgbmVlZHMgdG8gYmUgZWRpdGVkClJlbGF0ZWQgLSBob3cgaW1wb3J0YW50IGlzIHRoYXQgZGVjaXNpb24gdG8gdGhlIGRvd25zdHJlYW0gaW1wYWN0IChlLmcuIGhvdyBtdWNoIGRvZXMgY2hhbmdpbmcgdGhlIG51bWJlciBvZiBQQ3MgY2hhbmdlIHRoZSBjbHVzdGVyaW5nKT8KLS0+IAoKCiMjIyBWaXN1YWxpemluZyByZWxhdGl2ZSBjb250cmlidXRpb25zIG9mIGVhY2ggUEMKCgpPbmUgd2F5IHRvIGRldGVybWluZSBob3cgbWFueSBQQ3MgdG8gaW5jbHVkZSBpcyBieSBsb29raW5nIGF0IGFuIGVsYm93IHBsb3QsIHdoaWNoIHNob3dzIHRoZSBwZXJjZW50IHZhcmlhbmNlIGV4cGxhaW5lZCBieSBzdWNjZXNzaXZlIFBDcy4KCmBgYHtyLCBldmFsPUZBTFNFfQpFbGJvd1Bsb3QoZ2VvX3NvLCBuZGltcyA9IDUwLCByZWR1Y3Rpb24gPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EnKQpnZ3NhdmUoZmlsZW5hbWUgPSAncmVzdWx0cy9maWd1cmVzL3FjX3NjdF9lbGJvd19wbG90LnBuZycpCmBgYAoKIVtdKC4vaW1hZ2VzL2N1cnJpY3VsdW0vMDQtUENBYW5kRGltUmVkdWN0aW9uL3FjX3NjdF9lbGJvd19wbG90LnBuZykKCkluIHRoaXMgcGxvdCwgd2UgY291bGQgYXJiaXRyYXJpbHkgY2hvb3NlIGEgbnVtYmVyIGFsb25nIHRoZSB4LWF4aXMgdGhhdCBsb29rcyBsaWtlIGEgc2hhcnAgY2hhbmdlIGluIHRoZSB2YXJpYW5jZSBmcm9tIG9uZSBQQyB0byB0aGUgbmV4dCwgdGhhdCBpcywgYW4gZWxib3cuIE9mIGNvdXJzZSwgdGhlIGNob2ljZSBpcyBub3QgYWx3YXlzIG9idmlvdXMsIGFuZCB0aGlzIHBsb3QgaXMgbm8gZGlmZmVyZW50LiBXZSBjb3VsZCBhbHNvIHRyeSB0byBxdWFudGlmeSBvdXIgY2hvaWNlLgoKCiMjIyBVc2luZyBhIChjcnVkZSkgb3B0aW1pemF0aW9uIHRvIHNlbGVjdCBhIHN0YXJ0aW5nIHBvaW50CgpGdW5jdGlvbiB0byByZXR1cm4gbWluaW11bSBQQ3MgYmFzZWQgb24gdHdvIHBvc3NpYmxlIG1ldHJpY3M6CgpgYGB7ciwgZXZhbD1GQUxTRX0KIyBGdW5jdGlvbiB0byBkZXRlcm1pbmUgb3B0aW1hbCBQQ3MgYWZ0ZXIgUnVuUENBKCkKb3B0aW1hbF9wY3MgPSBmdW5jdGlvbihzbywgcmVkdWN0aW9uKSB7CiAgICAjIHF1YW50aXRhdGl2ZSBjaGVjayBmb3IgbnVtYmVyIG9mIFBDcyB0byBpbmNsdWRlCiAgICBwY3QgPSBzb0ByZWR1Y3Rpb25zW1tyZWR1Y3Rpb25dXUBzdGRldiAvIHN1bShzb0ByZWR1Y3Rpb25zW1tyZWR1Y3Rpb25dXUBzdGRldikgKiAxMDAKICAgIGN1bSA9IGN1bXN1bShwY3QpCiAgICBjbzEgPSB3aGljaChjdW0gPiA5MCAmIHBjdCA8IDUpWzFdCiAgICBjbzIgPSBzb3J0KHdoaWNoKChwY3RbMTpsZW5ndGgocGN0KS0xXSAtIHBjdFsyOmxlbmd0aChwY3QpXSkgPiAuMSksIGRlY3JlYXNpbmcgPSBUKVsxXSArIDEKICAgIHBjcyA9IG1pbihjbzEsIGNvMikgCiAgICAKICAgIHJldHVybihwY3MpCn0KYGBgCgpJZiB3ZSBhcHBseSB0aGlzIGZ1bmN0aW9uIHRvIG91ciBkYXRhLCB0aGVuIHdlIGV4cGVjdCBhIG51bWJlciBvZiBQQ3Mgc29tZXdoZXJlIHdpdGhpbiB0aGUgYmVuZCBvZiB0aGUgZWxib3cgcGxvdCB0byBiZSByZXR1cm5lZDoKCmBgYHtyLCBldmFsPUZBTFNFfQpwY3MgPSBvcHRpbWFsX3BjcyhnZW9fc28sICd1bmludGVncmF0ZWQuc2N0LnBjYScpCnBjcwpgYGAKfn5+fgoxNQp+fn5+CgpBZ2FpbiwgdGhpcyBudW1iZXIgaXMgbGlrZWx5IGEgc3RhcnRpbmcgcG9pbnQgYW5kIG1heSBuZWVkIHRvIHJldmlzZSBkZXBlbmRpbmcgb24gdGhlIG91dGNvbWUgb2YgdGhlIGRvd25zdHJlYW0gc3RlcHMuIAoKV2hpbGUgb3V0c2lkZSB0aGUgc2NvcGUgb2YgdGhpcyB3b3Jrc2hvcCwgdGhlcmUgYXJlIGNvbW11bml0eSBlZmZvcnRzIHRvIGRldmVsb3AgbW9yZSBzb3BoaXN0aWNhdGVkIG1ldGhvZHMgdG8gc2VsZWN0IGxpa2UgdGhlIFtjaG9vc2VSIHBhY2thZ2VdIG9yIHRoZSBvcHRpb24gdG8gdXNlIGNsdXN0ZXJpbmcgdHJlZXMgdG8gZXZhbHVhdGUgdGhlIHN0YWJpbGl0eSBvZiB0aGlzIHBhcmFtZXRlciBjaG9pY2UuCgoKIyBJbnRlZ3JhdGUgTGF5ZXJzCgoKSGF2aW5nIG5vcm1hbGl6ZWQgdGhlIGRhdGEgd2l0aCBgU0NUcmFuc2Zvcm0oKWAgYW5kIHBlcmZvcm1lZCB0aGUgZGltZW5zaW9uIHJlZHVjdGlvbiB3aXRoIGBSdW5QQ0EoKWAsIHdlIGFyZSBub3cgcmVhZHkgdG8gaW50ZWdyYXRlIG91ciBkYXRhLgoKTmV3IHRvIFNldXJhdCB2NSBpcyB0aGUgaW1wcm92ZWQgYEludGVncmF0ZUxheWVycygpYCBmdW5jdGlvbiB3aGljaCBtYWtlcyBzZWxlY3RpbmcgZGlmZmVyZW50IGludGVncmF0aW9uIG1ldGhvZHMgbXVjaCBlYXNpZXIuIFRoZSByZXN1bHRzIG9mIGVhY2ggYWx0ZXJuYXRpdmUgaW50ZWdyYXRpb24gbWV0aG9kIGFyZSBzdG9yZWQgd2l0aGluIHRoZSBzYW1lIGBTZXVyYXRgIG9iamVjdCwgd2hpY2ggbWFrZXMgY29tcGFyaW5nIGRvd25zdHJlYW0gZWZmZWN0cyBtdWNoIGVhc2llci4gIFNvLCBpZiB3ZSB3YW50ZWQgdG8gcnVuIHRoZSBzbGlnaHRseSBmYXN0ZXIgYFJQQ0FJbnRlZ3JhdGlvbmAgbWV0aG9kLCB3ZSB3b3VsZCBydW46CgpgYGB7ciwgZXZhbCA9IEZBTFNFfQpnZW9fc28gPSBJbnRlZ3JhdGVMYXllcnMoCiAgb2JqZWN0ID0gZ2VvX3NvLCAKICBtZXRob2QgPSBSUENBSW50ZWdyYXRpb24sIAogIG9yaWcucmVkdWN0aW9uID0gJ3VuaW50ZWdyYXRlZC5zY3QucGNhJywKICBub3JtYWxpemF0aW9uLm1ldGhvZCA9ICdTQ1QnLAogIG5ldy5yZWR1Y3Rpb24gPSAnaW50ZWdyYXRlZC5zY3QucnBjYScpCmBgYAoKW1RoaXMgU2V1cmF0IHZpZ25ldHRlIG9uIGludGVncmF0aXZlIGFuYWx5c2lzIGluIHY1XShodHRwczovL3NhdGlqYWxhYi5vcmcvc2V1cmF0L2FydGljbGVzL3NldXJhdDVfaW50ZWdyYXRpb24jcGVyZm9ybS1zdHJlYW1saW5lZC1vbmUtbGluZS1pbnRlZ3JhdGl2ZS1hbmFseXNpcykgcHJvdmlkZXMgZXhhbXBsZXMgb2YgZWFjaCBpbnRlZ3JhdGlvbiBtZXRob2QuIE5vdGUsIHRoYXQgdGhlIGNvZGUgaW4gdGhpcyB2aWduZXR0ZSBhc3N1bWVzIHRoZSBgTm9ybWFsaXplRGF0YSgpID4gU2NhbGVEYXRhKCkgPiBGaW5kVmFyaWFibGVGZWF0dXJlcygpYCBwaXBlbGluZSB3YXMgdXNlZCBhbmQgb3VyIGBub3JtYWxpemF0aW9uLm1ldGhvZCA9ICdTQ1QnYCBhbHNvIGRpZmZlcnMuCgpOb3RlIHdlIGhhdmUgc3BlY2lmaWVkIHRoZSB1bmludGVncmF0ZWQgcmVkdWN0aW9uIGB1bmludGVncmF0ZWQuc2N0LnBjYWAsIHdoaWNoIGlzIHdoYXQgYEludGVncmF0ZUxheWVycygpYCBvcGVyYXRlcyBvbiwgYWxvbmcgd2l0aCB0aGUgYFNDVGAgYXNzYXkuIExldCdzIHRha2UgYSBsb29rIHRvIHNlZSB3aGF0J3MgZGlmZmVyZW50IGFib3V0IHRoZSBgU2V1cmF0YCBvYmplY3Q6CgpgYGB7ciwgZXZhbCA9IEZBTFNFfQpnZW9fc28KYGBgCgp+fn4KIyBBbiBvYmplY3Qgb2YgY2xhc3MgU2V1cmF0IAojIDQ3MDM3IGZlYXR1cmVzIGFjcm9zcyAyOTYxNSBzYW1wbGVzIHdpdGhpbiAyIGFzc2F5cyAKIyBBY3RpdmUgYXNzYXk6IFNDVCAoMjA1NDggZmVhdHVyZXMsIDMwMDAgdmFyaWFibGUgZmVhdHVyZXMpCiMgIDMgbGF5ZXJzIHByZXNlbnQ6IGNvdW50cywgZGF0YSwgc2NhbGUuZGF0YQojICAxIG90aGVyIGFzc2F5IHByZXNlbnQ6IFJOQQojICAyIGRpbWVuc2lvbmFsIHJlZHVjdGlvbnMgY2FsY3VsYXRlZDogdW5pbnRlZ3JhdGVkLnNjdC5wY2EsIGludGVncmF0ZWQuc2N0LnJwY2EKfn5+CgpPYnNlcnZlIHRoYXQgd2Ugbm93IGhhdmUgYSBuZXcgcmVkdWN0aW9uLCBgaW50ZWdyYXRlZC5zY3QuY2NhYCwgd2hpY2ggd2Ugd2lsbCB1c2UgZG93bnN0cmVhbS4KCgo8IS0tLSBOb3RlOiBvdXRwdXQgcGxvdCBiZWxvdyBhcHBlYXJzIHRvIG5vdCByZWZsZWN0IGludGVncmF0ZWQgZGF0YQpXZSBjYW4gYWxzbyBjb25maXJtIHRoYXQgb3VyIGludGVncmF0aW9uIG1ldGhvZCBoYXMgaGVscGVkIHRvIGNvcnJlY3QgdGhlIGBEYXlgIGVmZmVjdHMgd2Ugc2F3IGluIHRoZSBpbml0aWFsIFBDQSBwbG90cwoKYGBge3IsIGV2YWw9RkFMU0V9CkRpbVBsb3QoZ2VvX3NvLCByZWR1Y3Rpb24gPSAnaW50ZWdyYXRlZC5zY3QucGNhJywgZ3JvdXAuYnkgPSAnZGF5JykKZ2dzYXZlKGZpbGVuYW1lID0gJ3Jlc3VsdHMvZmlndXJlcy9xY19wY2FfcGxvdF9pbnRlZ3JhdGVkX3NjdF9kYXkucG5nJywgd2lkdGggPSA3LCBoZWlnaHQgPSA2LCB1bml0cyA9ICdpbicpCmBgYAoKIVtdKC4vaW1hZ2VzL2N1cnJpY3VsdW0vMDQtUENBYW5kRGltUmVkdWN0aW9uL3FjX3BjYV9wbG90X2ludGVncmF0ZWRfc2N0X2RheS5wbmcpCgotLS0+CgpCZWZvcmUgd2UgbW92ZSBvbiwgbGV0J3Mgc2F2ZSBvdXIgdXBkYXRlZCBTZXVyYXQgb2JqZWN0IHRvIGZpbGU6CgpgYGB7ciwgZXZhbD1GQUxTRX0Kc2F2ZVJEUyhvYmplY3QgPSBnZW9fc28sIGZpbGUgPSAncmVzdWx0cy9yZGF0YS9nZW9fc29fc2N0X2ludGVncmF0ZWQucmRhJykKYGBgCgoKIyMgQWx0ZXJuYXRlIGludGVncmF0aW9uIG1ldGhvZHMKCgoKQWZ0ZXIgbm9ybWFsaXplZCB0aGUgZGF0YSB3aXRoIGBTQ1RyYW5zZm9ybSgpYCBhbmQgcGVyZm9ybWVkIHRoZSBkaW1lbnNpb24gcmVkdWN0aW9uIHdpdGggYFJ1blBDQSgpYCwgYWx0ZXJuYXRpdmVseSB3ZSBjb3VsZCBhbHNvIHVzZSB0aGUgYENDQWAgaW50ZWdyYXRpb24gbWV0aG9kIHdpdGggdGhlIDoKCmBgYHtyLCBldmFsID0gRkFMU0V9Cmdlb19zbyA9IEludGVncmF0ZUxheWVycygKICAgIG9iamVjdCA9IGdlb19zbywgCiAgICBtZXRob2QgPSBDQ0FJbnRlZ3JhdGlvbiwgCiAgICBvcmlnLnJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScsCiAgICBub3JtYWxpemF0aW9uLm1ldGhvZCA9ICdTQ1QnLAogICAgbmV3LnJlZHVjdGlvbiA9ICdpbnRlZ3JhdGVkLnNjdC5jY2EnKQpgYGAKCgojIFN1bW1hcnkKCkluIHRoaXMgc2VjdGlvbiwgd2U6CgotIFNlbGVjdGVkIGEgbnVtYmVyIG9mIHByaW5jaXBhbCBjb21wb25lbnRzIHRoYXQgbGlrZWx5IGNvcnJlc3BvbmQgdG8gYmlvbG9naWNhbCB2YXJpYXRpb24gb2YgaW50ZXJlc3QgaW4gb3VyIGRhdGEKLSBJbnRlZ3JhdGVkIG91ciBgU0NUcmFuc2Zvcm1lZGAgZGF0YSB1c2luZyB0aGUgYFJQQ0FgIG1ldGhvZAoKTmV4dCBzdGVwczogQ2x1c3RlcmluZyBhbmQgcHJvamVjdGlvbgoKCi0tLS0KClRoZXNlIG1hdGVyaWFscyBoYXZlIGJlZW4gYWRhcHRlZCBhbmQgZXh0ZW5kZWQgZnJvbSBtYXRlcmlhbHMgbGlzdGVkIGFib3ZlLiBUaGVzZSBhcmUgb3BlbiBhY2Nlc3MgbWF0ZXJpYWxzIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgW0NyZWF0aXZlIENvbW1vbnMgQXR0cmlidXRpb24gbGljZW5zZSAoQ0MgQlkgNC4wKV0oaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbGljZW5zZXMvYnkvNC4wLyksIHdoaWNoIHBlcm1pdHMgdW5yZXN0cmljdGVkIHVzZSwgZGlzdHJpYnV0aW9uLCBhbmQgcmVwcm9kdWN0aW9uIGluIGFueSBtZWRpdW0sIHByb3ZpZGVkIHRoZSBvcmlnaW5hbCBhdXRob3IgYW5kIHNvdXJjZSBhcmUgY3JlZGl0ZWQuCgo8YnIvPgo8YnIvPgo8aHIvPgp8IFtQcmV2aW91cyBsZXNzb25dKDAzLUludGVncmF0aW9uLmh0bWwpIHwgW1RvcCBvZiB0aGlzIGxlc3Nvbl0oI3RvcCkgfCBbTmV4dCBsZXNzb25dKDA1LVByb2plY3Rpb25BbmRDbHVzdGVyaW5nLmh0bWwpIHwKfCA6LS0tIHwgOi0tLS06IHwgLS0tOiB8CgoKCg==</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("04-PCAandDimReduction.Rmd");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
