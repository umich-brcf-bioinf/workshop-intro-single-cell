<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="UM Bioinformatics Core" />

<meta name="date" content="2024-10-02" />

<title>Secondary Quality Control and Filtering</title>

<script src="site_libs/header-attrs-2.28/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>
<!--
Favicon dervied from
https://twemoji.twitter.com/
https://favicon.io/emoji-favicons/dna/
-->
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="shortcut icon" href="favicon-16x16.png" />
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>




<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Intro to scRNA-Seq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="workshop_intro.html">Intro</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="00A-OrientingOnScRNASeq.html">Orienting on scRNA-Seq</a>
    </li>
    <li>
      <a href="01-GettingStarted.html">Getting Started with Seurat</a>
    </li>
    <li>
      <a href="00B-CellRangerInAction.html">Cell Ranger in Action</a>
    </li>
    <li>
      <a href="02-QCandFiltering.html">Secondary QC &amp; Filtering</a>
    </li>
    <li>
      <a href="03-Normalization.html">Normalization</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04-PCAandIntegration.html">PCA &amp; Integration</a>
    </li>
    <li>
      <a href="05-ProjectionAndClustering.html">Projection &amp; Clustering</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="06-MarkerVisualization.html">Marker identification and visualization</a>
    </li>
    <li>
      <a href="07-CellTypeAnnos.html">Cell type annotation</a>
    </li>
    <li>
      <a href="08-DifferentialExpression.html">Differential expression analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="workshop_wrap_up.html">Wrap up</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Secondary Quality Control and
Filtering</h1>
<h4 class="author">UM Bioinformatics Core</h4>
<h4 class="date">2024-10-02</h4>

</div>


<script>
  addClassKlippyTo("pre.r, pre.markdown, pre.bash");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<style type="text/css">
body, td {
   font-size: 18px;
}
code.r{
  font-size: 12px;
}
pre {
  font-size: 12px
}

table.fig, th.fig, td.fig {
  border: 1px solid black;
  border-collapse: collapse;
  padding: 15px;
}

table{
   width:100%;
}
</style>
<div id="workflow-overview" class="section level1 unlisted unnumbered">
<h1 class="unlisted unnumbered">Workflow Overview</h1>
<p><br/>
<img src="images/wayfinder/wayfinder.png" alt="wayfinder" style="height: 400px;"/>
<br/> <br/></p>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>As discussed at the start of the workshop, single-cell experiments
using 10x Chromium instrument aim to have droplets with one cell plus
one bead. However this is an inherently imperfect process and there are
other important considerations like how healthy or intact the cell was
at the time of measurement.</p>
<p>In this section, our goal is to use filtering thresholds to remove
“cells” that were poorly measured, not cells at all, or included more
than one cell.</p>
<table class="fig">
<tr>
<td class="fig">
<img
src="images/graphical_abstracts/graphical_abstract_QC_and_filtering.png" />
</td>
</tr>
<tr>
<td class="fig">
The Cell Ranger barcode feature matrix outputs (A) is a mix of good and
poor quality cells (B). We can use expression patterns to further
visualize and filter to the subset of putative healthy cells (C) to
improve downstream analysis.
</td>
</tr>
</table>
<p><br/> Similar to many other areas of research, there are often gaps
between how single-cell data is presented versus the reality of running
an analysis. For example, only the final filtering thresholds might be
reported in a paper but our process for choosing those is likely to be
more iterative and include some trial and error.</p>
<div id="objectives" class="section level2">
<h2>Objectives</h2>
<ul>
<li>Discuss QC measures and learn how to calculate and plot them.</li>
<li>Discuss cell-filtering approaches and apply them to our
dataset.</li>
</ul>
<!-- Challenge for instructors: Every vignette uses different filters, how to harmonize/give guidance? Related, how much to discuss arbitrary cutoffs and continued maturation of field?-->
<!-- Add links to relevant resources throughout -->
<!-- General guidance - likely to be moved to earlier section:
- Note with each function call what gets added to the Seurat object.
- Adding checks to ensure object is updated by learners since want to avoid generating copied objects
- Note what layers should be used for what, for example, counts used for FeaturePlots. RNA vs SCT assay. -->
<hr />
</div>
</div>
<div id="adding-metadata" class="section level1">
<h1>Adding metadata</h1>
<p>We’re going to alter and add some columns to <code>meta.data</code>
to ease some downstream analysis and plotting steps. This will often be
necessary, as sample names contain combined information about
phenotypes. Let’s take a look at the first few rows again, to reacquaint
ourselves.</p>
<pre class="r"><code># Examine Seurat metdata  ----------------------------------------------
head(geo_so@meta.data)</code></pre>
<pre><code>                                          orig.ident nCount_RNA nFeature_RNA
HODay0replicate1_AAACCTGAGAGAACAG-1 HODay0replicate1      10234         3226
HODay0replicate1_AAACCTGGTCATGCAT-1 HODay0replicate1       3158         1499
HODay0replicate1_AAACCTGTCAGAGCTT-1 HODay0replicate1      13464         4102
HODay0replicate1_AAACGGGAGAGACTTA-1 HODay0replicate1        577          346
HODay0replicate1_AAACGGGAGGCCCGTT-1 HODay0replicate1       1189          629
HODay0replicate1_AAACGGGCAACTGGCC-1 HODay0replicate1       7726         2602</code></pre>
<p>We can add arbitrary per-cell information to this table such as:</p>
<ul>
<li>Summary statistics, such as percent mitochondrial reads for each
cell.</li>
<li>Batch, condition, etc. for each cell.</li>
<li>Cluster membership for each cell.</li>
<li>Cell cycle phase for each cell.</li>
<li>Other custom annotations for each cell.</li>
</ul>
<p>The following code chunk will create new columns from the
<code>orig.ident</code> column, one for the <code>day</code> and one for
the <code>replicate</code>. We’ll also use factors to make the days
appear in the correct order (by default R will order them Day0, Day21,
Day7).</p>
<pre class="r"><code># Make metadata more granular ------------------------------------------
# (So it&#39;s easier for us to understand)  

orig.ident_levels = apply(
    expand.grid(c(&#39;HO&#39;), c(&#39;replicate1&#39;, &#39;replicate2&#39;, &#39;replicate3&#39;, &#39;replicate4&#39;), c(&#39;Day0&#39;,&#39;Day7&#39;,&#39;Day21&#39;)), 
    MARGIN = 1, FUN = function(row){paste(row[1], row[3], row[2], sep = &#39;.&#39;)})

tmp_meta = geo_so@meta.data

tmp_meta$orig.ident = gsub(&#39;HO&#39;, &#39;HO.&#39;, tmp_meta$orig.ident)
tmp_meta$orig.ident = gsub(&#39;rep&#39;, &#39;.rep&#39;, tmp_meta$orig.ident)

tmp_meta$orig.ident = factor(tmp_meta$orig.ident, levels = orig.ident_levels)

# Add day information
tmp_meta$day = factor(str_split(tmp_meta$orig.ident, pattern = &#39;[.]&#39;, simplify = TRUE)[,2], levels = c(&#39;Day0&#39;, &#39;Day7&#39;, &#39;Day21&#39;))

# Add replicate column
tmp_meta$replicate = str_split(tmp_meta$orig.ident, pattern = &#39;[.]&#39;, simplify = TRUE)[,3]

# Assign the updated metadata to that in the Seurat object
geo_so@meta.data = tmp_meta

# Set the Idents(geo_so) to the new orig.ident
Idents(geo_so) = &#39;orig.ident&#39;</code></pre>
<p>Taking a look at the result, we see <code>orig.ident</code> looks a
little different, and we have new <code>day</code> and
<code>replicate</code> columns. Note that there are many ways to have
accomplished this, the above code is just one route.</p>
<pre class="r"><code># Re-examine Seurat metdata  -------------------------------------------
head(geo_so@meta.data)</code></pre>
<pre><code>                                            orig.ident nCount_RNA nFeature_RNA  day  replicate
HODay0replicate1_AAACCTGAGAGAACAG-1 HO.Day0.replicate1      10234         3226 Day0 replicate1
HODay0replicate1_AAACCTGGTCATGCAT-1 HO.Day0.replicate1       3158         1499 Day0 replicate1
HODay0replicate1_AAACCTGTCAGAGCTT-1 HO.Day0.replicate1      13464         4102 Day0 replicate1
HODay0replicate1_AAACGGGAGAGACTTA-1 HO.Day0.replicate1        577          346 Day0 replicate1
HODay0replicate1_AAACGGGAGGCCCGTT-1 HO.Day0.replicate1       1189          629 Day0 replicate1
HODay0replicate1_AAACGGGCAACTGGCC-1 HO.Day0.replicate1       7726         2602 Day0 replicate1</code></pre>
<div id="percent-mitochondrial-reads" class="section level2">
<h2>Percent mitochondrial reads</h2>
<p>The <code>PercentageFeatureSet()</code> function enables us to
quickly determine the counts belonging to a subset of the possible
features for each cell. Since mitochondrial transcripts in mouse begin
with “mt”, we will use that pattern to count the percentage of reads
coming from mitochondrial transcripts.</p>
<pre class="r"><code># Consider mitochondrial transcripts  ----------------------------------

# We use &quot;mt&quot; because this is mouse, depending on the organism, this might need to be changed
geo_so$percent.mt = PercentageFeatureSet(geo_so, pattern = &#39;^mt-&#39;)

# Use summary() to quickly check the range of values
summary(geo_so$percent.mt)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  0.000   1.817   2.582   5.281   3.865  98.244 </code></pre>
<p>Just looking at the summary, we can see that there are some cells
with a high percentage of mitochondrial reads.</p>
</div>
</div>
<div id="quality-metrics" class="section level1">
<h1>Quality Metrics</h1>
<p>Cell Ranger is a first-pass filter to determine what is a “cell” and
what is not. It only considers one sample at a time, and does not
consider the cells relative to one another.</p>
<p>Let’s dig deeper to determine when a droplet might contain two cells,
a very stressed cell, or some technical issue in the library
preparation. We will use three metrics to determine low-quality cells
based on their expression profiles (<a
href="https://bioconductor.org/books/3.12/OSCA/quality-control.html#choice-of-qc-metrics">reference</a>).</p>
<ol style="list-style-type: decimal">
<li>The total number of UMIs detected. Cells with a small number of UMIs
detected may indicate loss of RNA during library preparation via cell
lysis or inefficient cDNA capture / amplification. Cells with relatively
high number of UMIs detected may indicate a doublet.</li>
<li>The number of expressed features, defined as number of genes with
non-zero counts. Cells with very few measured genes are likely to be of
low-quality, and may distort downstream variance estimation or dimension
reduction steps.</li>
<li>The proportion of reads mapped to the mitochondrial genome. High
proportions of mitochondrial transcripts may indicate a damaged cell,
the measure of which may also distort downstream analysis steps.</li>
</ol>
<p>The number of UMIs detected (<code>nCount</code>) and number of
expressed features (<code>nFeature</code>) are already given in the meta
data table.</p>
<blockquote>
<p><strong>Why total UMIs instead of total reads?</strong></p>
<p>Since a single-cell inherently contains a limited amount of RNA
molecules, a higher amount of PCR amplification is required to generate
the final sequencing library.</p>
<p>Since PCR can skew proportions of initial input materials, specific
sequences are included in the initial capture probes called unique
molecule identifiers (UMIs). As each initial probe has a different UMI
sequence, each RNA captured will be tagged with a different UMI, which
allows those initial RNAs and subsequent PCR duplicates to be identified
and duplicates collapsed as part of the initial processing by
CellRanger.</p>
</blockquote>
<blockquote>
<p><strong>Other meanings of <code>nFeatures</code></strong></p>
<p>For other single-cell data types, <code>nFeatures</code> would
represent what’s being measured in that experiment. For single-cell
ATAC-seq, <code>nFeatures</code> would represents the total number of
peaks (e.g. accessible areas of DNA) per cell.</p>
</blockquote>
<!-- Matt may have discussed UMIs as part of CellRanger processing and Liv/Tricia may touch on as part of library generation at end of Day 2 -->
<div id="cell-counts" class="section level2">
<h2>Cell counts</h2>
<p>Cell counts per sample (based on the numbrer of unique cellular
barcodes detected by Cell Ranger) can indicate if an entire sample was
of poor quality. The table below is the number of cells called by Cell
Ranger, with the added filter from <code>CreateSeurateObject()</code> in
the previous lesson: <code>min.cells = 1, min.features = 50</code>.
Recall, this means a gene is removed if it is expressed in 1 or fewer
cells, and a cell is removed if it contains reads for 50 or fewer
genes.</p>
<pre class="r"><code># Assign overall cell counts  ------------------------------------------
cell_counts_pre_tbl = geo_so@meta.data %&gt;% count(orig.ident, name = &#39;prefilter_cells&#39;)
cell_counts_pre_tbl</code></pre>
<pre><code>            orig.ident prefilter_cells
1   HO.Day0.replicate1            1183
2   HO.Day0.replicate2             689
3   HO.Day0.replicate3            1310
4   HO.Day0.replicate4            1053
5   HO.Day7.replicate1            5765
6   HO.Day7.replicate2            6020
7   HO.Day7.replicate3            6285
8   HO.Day7.replicate4            5166
9  HO.Day21.replicate1            2321
10 HO.Day21.replicate2            1322
11 HO.Day21.replicate3            1275
12 HO.Day21.replicate4            2827</code></pre>
<p>It appears that the Day 7 samples have systematically more cells than
the other days. If you had an idea of how many cells you expected to see
per sample, this table can help you check that expectation and determine
if a sample failed and should be dropped.</p>
</div>
<div id="visualizing-quality-metrics" class="section level2">
<h2>Visualizing quality metrics</h2>
<p>A violin plot shows the distribution of a quantity among the cells in
a single sample, or across many samples. Seurat has a built-in function,
<code>VlnPlot()</code> for this purpose. Let’s orient with a violin plot
of <code>nFeature_RNA</code> for only one sample,
<code>HO.Day21.replicate1</code>:</p>
<p><img src="images/curriculum/02-QCandFiltering/02-single_violin_plot-1.png" width="816" style="display: block; margin: auto;" /></p>
<p>A violin plot is similar to a box plot, but it shows the density of
the data at different values. Here the individual points are the cells
from <code>HO.Day21.replicate1</code> and the y-axis is the value of
<code>nFeature_RNA</code> for that cell. The violin part of the function
is essentially showing the density of the cells at different values of
<code>nFeature_RNA</code>.</p>
<div id="genes-per-cell" class="section level3">
<h3>Genes per cell</h3>
<p>Let’s look at the <code>nFeature_RNA</code> violin plot across all
the samples. Again, this is the number of genes detected per cell.</p>
<pre class="r"><code># Review feature violin plots   ----------------------------------------
VlnPlot(geo_so, features = &#39;nFeature_RNA&#39;, assay = &#39;RNA&#39;, layer = &#39;counts&#39;) + NoLegend() + geom_hline(yintercept = 500) + geom_hline(yintercept = 400) + geom_hline(yintercept = 300) + geom_hline(yintercept = 200)
ggsave(filename = &#39;results/figures/qc_nFeature_violin.png&#39;, width = 12, height = 6, units = &#39;in&#39;)</code></pre>
<p><img src="images/curriculum/02-QCandFiltering/02-feature_plot-1.png" width="816" style="display: block; margin: auto;" /></p>
<p>We observe that samples behave similarly within a day, but have
different distributions across days. We also note that many cells appear
to have a low number of genes detected (&lt; 500).</p>
</div>
<div id="umi-counts-per-cell" class="section level3">
<h3>UMI counts per cell</h3>
<p>Now let’s look at <code>nCount_RNA</code> plot, the total number of
UMIs detected.</p>
<pre class="r"><code># Review count violin plots   ------------------------------------------
VlnPlot(geo_so, features = &#39;nCount_RNA&#39;, assay = &#39;RNA&#39;, layer = &#39;counts&#39;) + NoLegend()
ggsave(filename = &#39;results/figures/qc_nCount_violin.png&#39;, width = 12, height = 6, units = &#39;in&#39;)</code></pre>
<p><img src="images/curriculum/02-QCandFiltering/02-count_plot-1.png" width="816" style="display: block; margin: auto;" /></p>
<p>We observe a similar within-and-across day behavior among the
samples. Overall it appears that the Day 0 samples have fewer UMIs
detected per cell than Day 7 and Day 21. Also of note is the outlier
cell in HO.Day0.replicate1, with around 100K UMIs detected. This cell
might be a doublet.</p>
</div>
<div id="percent-mitochondrial-reads-1" class="section level3">
<h3>Percent mitochondrial reads</h3>
<p>Finally, lets plot the percent mitochondrial reads,
<code>percent.mt</code>.</p>
<pre class="r"><code># Review mitochondrial violin plots   ----------------------------------
VlnPlot(geo_so, features = &#39;percent.mt&#39;, assay = &#39;RNA&#39;, layer = &#39;counts&#39;) + NoLegend() + geom_hline(yintercept = 25) + geom_hline(yintercept = 20) + geom_hline(yintercept = 15) + geom_hline(yintercept = 10)
ggsave(filename = &#39;results/figures/qc_mito_violin.png&#39;, width = 12, height = 6, units = &#39;in&#39;)</code></pre>
<p><img src="images/curriculum/02-QCandFiltering/02-mito_plot-1.png" width="816" style="display: block; margin: auto;" /></p>
<p>We observe the majority of cells seem to have &lt; 25% mitochondrial
reads, but there are many cells with &gt; 25% that we may want to
remove.</p>
<p>Generally, many tutorials use a cutoff of 5 - 10% mitochondrial
reads. However, for some experiments, high mitochondrial reads would be
expected (such as in cases where the condition/treatment or genotype
increases cell death). In this case, a relaxed threshold would help
preserve biologically relevant cells. In our case, the cells were
collected as part of an injury model, perhaps justifying a more lenient
percent mitochondrial read filter.</p>
</div>
</div>
</div>
<div id="filtering-approaches" class="section level1">
<h1>Filtering approaches</h1>
<div id="fixed-thresholds" class="section level2">
<h2>Fixed thresholds</h2>
<p>Fixed thresholds for any combination of <code>nFeature_RNA</code>,
<code>nCount_RNA</code>, and <code>percent.mt</code> can be selected to
remove low quality cells. In general, selecting very stringent
thresholds for each of the metrics may lead to removing informative
cells. As per the HBC training materials (<a
href="https://hbctraining.github.io/scRNA-seq_online/lessons/04_SC_quality_control.html">link</a>),
we recommend setting individual thresholds to err on the permissive
side.</p>
<p><a
href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7002453/">Sorkin et
al.</a> chose these thresholds:</p>
<blockquote>
<p>We filtered out cells with less than 500 genes per cell and with more
than 25% mitochondrial read content.</p>
</blockquote>
<p>In other words, cells with &gt; 500 <code>nFeature_RNA</code> and
&lt; 25% <code>percent.mt</code> were retained by the authors. We could
preview what the resulting cell counts would be with these
thresholds:</p>
<pre class="r"><code># Consider excluding suspect cells -------------------------------------
subset(geo_so, subset = nFeature_RNA &gt; 500 &amp; percent.mt &lt; 25)@meta.data %&gt;% 
    count(orig.ident, name = &#39;postfilter_cells&#39;)</code></pre>
<pre><code>            orig.ident postfilter_cells
1   HO.Day0.replicate1             1049
2   HO.Day0.replicate2              615
3   HO.Day0.replicate3             1191
4   HO.Day0.replicate4              943
5   HO.Day7.replicate1             4928
6   HO.Day7.replicate2             4932
7   HO.Day7.replicate3             4897
8   HO.Day7.replicate4             4242
9  HO.Day21.replicate1             2000
10 HO.Day21.replicate2             1182
11 HO.Day21.replicate3             1166
12 HO.Day21.replicate4             2470</code></pre>
</div>
<div id="adaptive-thresholds" class="section level2">
<h2>Adaptive thresholds</h2>
<p>For this workshop we will use fixed thresholds, but another option is
to remove low-quality cells adaptively. This approach assumes that most
of the cells are of acceptable quality. For more information see the
relevant section in Bioconductor’s online book: Orchestrating
Single-Cell Analysis (<a
href="https://bioconductor.org/books/3.12/OSCA/quality-control.html#quality-control-outlier">link</a>).</p>
</div>
</div>
<div id="removing-low-quality-cells" class="section level1">
<h1>Removing low-quality cells</h1>
<p>We will deviate from the publication slightly and retain the cells
with <code>nFeature_RNA &gt; 300</code> and
<code>percent.mt &lt; 15</code>. Noting that the
<code>nFeature_RNA</code> plot had a gap around 300, and that we want to
be more lenient than the usual 5-10% cutoff for mitochondrial reads.</p>
<pre class="r"><code># Filter to exclude suspect cells and assign to new Seurat object ------
geo_so = subset(geo_so, subset = nFeature_RNA &gt; 300 &amp; percent.mt &lt; 15)
geo_so</code></pre>
<pre><code>An object of class Seurat 
26489 features across 31560 samples within 1 assay 
Active assay: RNA (26489 features, 0 variable features)
 1 layer present: counts</code></pre>
<p>And let’s record the number of cells remaining after filtering:</p>
<pre class="r"><code># Remaining cell counts ------------------------------------------------
cell_counts_post_tbl = geo_so@meta.data %&gt;% count(orig.ident, name = &#39;postfilter_cells&#39;)
cell_counts_post_tbl</code></pre>
<pre><code>            orig.ident postfilter_cells
1   HO.Day0.replicate1             1053
2   HO.Day0.replicate2              629
3   HO.Day0.replicate3             1222
4   HO.Day0.replicate4              971
5   HO.Day7.replicate1             5215
6   HO.Day7.replicate2             5324
7   HO.Day7.replicate3             5626
8   HO.Day7.replicate4             4690
9  HO.Day21.replicate1             2004
10 HO.Day21.replicate2             1186
11 HO.Day21.replicate3             1178
12 HO.Day21.replicate4             2462</code></pre>
<p>Let’s combine the pre and post tables:</p>
<pre class="r"><code># Show cell counts before and after filtering --------------------------
cell_counts_tbl = cell_counts_pre_tbl %&gt;% left_join(cell_counts_post_tbl, by = &#39;orig.ident&#39;)
cell_counts_tbl</code></pre>
<pre><code>            orig.ident prefilter_cells postfilter_cells
1   HO.Day0.replicate1            1183             1053
2   HO.Day0.replicate2             689              629
3   HO.Day0.replicate3            1310             1222
4   HO.Day0.replicate4            1053              971
5   HO.Day7.replicate1            5765             5215
6   HO.Day7.replicate2            6020             5324
7   HO.Day7.replicate3            6285             5626
8   HO.Day7.replicate4            5166             4690
9  HO.Day21.replicate1            2321             2004
10 HO.Day21.replicate2            1322             1186
11 HO.Day21.replicate3            1275             1178
12 HO.Day21.replicate4            2827             2462</code></pre>
<p>We can now easily see how many cells we started with, and how many we
retained for downstream analysis. Let’s write this table to a file.</p>
<pre class="r"><code>write_csv(cell_counts_tbl, file = &#39;results/tables/cell_filtering_counts.csv&#39;)</code></pre>
<!--What thresholds would we start with based on the plots alone? How does that compare to the thresholds reported in paper?-->
<!--Other “advanced” methods: out of scope for this workshop but there are packages  specifically developed to detect "doublets", e.g. droplets that contained more than one cell, such as DoubleFinder-->
<!--Additional aside - For single-nuclei experiments removing background/ambient RNA with CellBlender OR DecontX is an important additional step since nuclei are both sticky and porous-->
</div>
<div id="revising-thresholds" class="section level1">
<h1>Revising thresholds</h1>
<p>It is important to recognize that thresholds for retaining cells are
not set in stone. It may happen that the downstream analysis suggests
that thresholds should be more or less stringent. In which case, you may
experiment with the thresholds and observe the downstream effects.</p>
</div>
<div id="save-our-progress" class="section level1">
<h1>Save our progress</h1>
<p>Let’s save this filtered form of our Seurat object. It will also
include our changes to the <code>meta.data</code>:</p>
<pre class="r"><code># Save the current Seurat object ---------------------------------------
saveRDS(geo_so, file = &#39;results/rdata/geo_so_filtered.rds&#39;)</code></pre>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>In this section we:</p>
<ul>
<li>Discussed the big three quality metrics: <code>nFeature</code>s,
<code>nCount</code>s, and <code>percent.mt</code>.</li>
<li>Visualized these metrics across cells / samples to help identify
low-quality cells.</li>
<li>Filtered low-quality cells using fixed thresholds.</li>
</ul>
<p>Next steps: Normalization</p>
<hr />
<p>These materials have been adapted and extended from materials listed
above. These are open access materials distributed under the terms of
the <a href="http://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution license (CC BY 4.0)</a>, which permits unrestricted
use, distribution, and reproduction in any medium, provided the original
author and source are credited.</p>
<p><br/> <br/></p>
<hr />
<table style="width:100%;">
<colgroup>
<col width="28%" />
<col width="42%" />
<col width="28%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"><a href="00B-CellRangerInAction.html">Previous
lesson</a></th>
<th align="center"><a href="#top">Top of this lesson</a></th>
<th align="right"><a href="03-Normalization.html">Next lesson</a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAiU2Vjb25kYXJ5IFF1YWxpdHkgQ29udHJvbCBhbmQgRmlsdGVyaW5nIgphdXRob3I6ICJVTSBCaW9pbmZvcm1hdGljcyBDb3JlIgpkYXRlOiAiYHIgU3lzLkRhdGUoKWAiCm91dHB1dDoKICAgICAgICBodG1sX2RvY3VtZW50OgogICAgICAgICAgICBpbmNsdWRlczoKICAgICAgICAgICAgICAgIGluX2hlYWRlcjogaGVhZGVyLmh0bWwKICAgICAgICAgICAgdGhlbWU6IHBhcGVyCiAgICAgICAgICAgIHRvYzogdHJ1ZQogICAgICAgICAgICB0b2NfZGVwdGg6IDQKICAgICAgICAgICAgdG9jX2Zsb2F0OiB0cnVlCiAgICAgICAgICAgIG51bWJlcl9zZWN0aW9uczogZmFsc2UKICAgICAgICAgICAgZmlnX2NhcHRpb246IHRydWUKICAgICAgICAgICAgbWFya2Rvd246IEdGTQogICAgICAgICAgICBjb2RlX2Rvd25sb2FkOiB0cnVlCi0tLQoKYGBge3Iga2xpcHB5LCBlY2hvPUZBTFNFLCBpbmNsdWRlPVRSVUV9CmtsaXBweTo6a2xpcHB5KGxhbmcgPSBjKCJyIiwgIm1hcmtkb3duIiwgImJhc2giKSwgcG9zaXRpb24gPSBjKCJ0b3AiLCAicmlnaHQiKSkKYGBgCgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgpib2R5LCB0ZCB7CiAgIGZvbnQtc2l6ZTogMThweDsKfQpjb2RlLnJ7CiAgZm9udC1zaXplOiAxMnB4Owp9CnByZSB7CiAgZm9udC1zaXplOiAxMnB4Cn0KCnRhYmxlLmZpZywgdGguZmlnLCB0ZC5maWcgewogIGJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOwogIGJvcmRlci1jb2xsYXBzZTogY29sbGFwc2U7CiAgcGFkZGluZzogMTVweDsKfQoKdGFibGV7CiAgIHdpZHRoOjEwMCU7Cn0KPC9zdHlsZT4KCmBgYHtyLCBpbmNsdWRlID0gRkFMU0V9CnNvdXJjZSgiLi4vYmluL2NodW5rLW9wdGlvbnMuUiIpCmtuaXRyX2ZpZ19wYXRoKCIwMi1RQ2FuZEZpbHRlcmluZy8wMi0iKQpgYGAKCiMgV29ya2Zsb3cgT3ZlcnZpZXcgey51bmxpc3RlZCAudW5udW1iZXJlZH0KCjxici8+CjxpbWcgc3JjPSJpbWFnZXMvd2F5ZmluZGVyL3dheWZpbmRlci5wbmciIGFsdD0id2F5ZmluZGVyIiBzdHlsZT0iaGVpZ2h0OiA0MDBweDsiLz4KPGJyLz4KPGJyLz4KCiMgSW50cm9kdWN0aW9uCgpBcyBkaXNjdXNzZWQgYXQgdGhlIHN0YXJ0IG9mIHRoZSB3b3Jrc2hvcCwgc2luZ2xlLWNlbGwgZXhwZXJpbWVudHMgdXNpbmcgMTB4IENocm9taXVtIGluc3RydW1lbnQgYWltIHRvIGhhdmUgZHJvcGxldHMgd2l0aCBvbmUgY2VsbCBwbHVzIG9uZSBiZWFkLiBIb3dldmVyIHRoaXMgaXMgYW4gaW5oZXJlbnRseSBpbXBlcmZlY3QgcHJvY2VzcyBhbmQgdGhlcmUgYXJlIG90aGVyIGltcG9ydGFudCBjb25zaWRlcmF0aW9ucyBsaWtlIGhvdyBoZWFsdGh5IG9yIGludGFjdCB0aGUgY2VsbCB3YXMgYXQgdGhlIHRpbWUgb2YgbWVhc3VyZW1lbnQuCgpJbiB0aGlzIHNlY3Rpb24sIG91ciBnb2FsIGlzIHRvIHVzZSBmaWx0ZXJpbmcgdGhyZXNob2xkcyB0byByZW1vdmUgImNlbGxzIiB0aGF0IHdlcmUgcG9vcmx5IG1lYXN1cmVkLCBub3QgY2VsbHMgYXQgYWxsLCBvciBpbmNsdWRlZCBtb3JlIHRoYW4gb25lIGNlbGwuCgo8dGFibGUgY2xhc3M9J2ZpZyc+PHRyPjx0ZCBjbGFzcz0nZmlnJz4KIVtdKGltYWdlcy9ncmFwaGljYWxfYWJzdHJhY3RzL2dyYXBoaWNhbF9hYnN0cmFjdF9RQ19hbmRfZmlsdGVyaW5nLnBuZykKPC90ZD48L3RyPjx0cj48dGQgY2xhc3M9J2ZpZyc+VGhlIENlbGwgUmFuZ2VyIGJhcmNvZGUgZmVhdHVyZSBtYXRyaXggb3V0cHV0cyAoQSkgaXMgYSBtaXggb2YgZ29vZCBhbmQgcG9vciBxdWFsaXR5IGNlbGxzIChCKS4gV2UgY2FuIHVzZSBleHByZXNzaW9uIHBhdHRlcm5zIHRvIGZ1cnRoZXIgdmlzdWFsaXplIGFuZCBmaWx0ZXIgdG8gdGhlIHN1YnNldCBvZiBwdXRhdGl2ZSBoZWFsdGh5IGNlbGxzIChDKSB0byBpbXByb3ZlIGRvd25zdHJlYW0gYW5hbHlzaXMuCjwvdGQ+PC90cj48L3RhYmxlPgo8YnIvPgpTaW1pbGFyIHRvIG1hbnkgb3RoZXIgYXJlYXMgb2YgcmVzZWFyY2gsIHRoZXJlIGFyZSBvZnRlbiBnYXBzIGJldHdlZW4gaG93IHNpbmdsZS1jZWxsIGRhdGEgaXMgcHJlc2VudGVkIHZlcnN1cyB0aGUgcmVhbGl0eSBvZiBydW5uaW5nIGFuIGFuYWx5c2lzLiBGb3IgZXhhbXBsZSwgb25seSB0aGUgZmluYWwgZmlsdGVyaW5nIHRocmVzaG9sZHMgbWlnaHQgYmUgcmVwb3J0ZWQgaW4gYSBwYXBlciBidXQgb3VyIHByb2Nlc3MgZm9yIGNob29zaW5nIHRob3NlIGlzIGxpa2VseSB0byBiZSBtb3JlIGl0ZXJhdGl2ZSBhbmQgaW5jbHVkZSBzb21lIHRyaWFsIGFuZCBlcnJvci4KCgojIyBPYmplY3RpdmVzCgotIERpc2N1c3MgUUMgbWVhc3VyZXMgYW5kIGxlYXJuIGhvdyB0byBjYWxjdWxhdGUgYW5kIHBsb3QgdGhlbS4KLSBEaXNjdXNzIGNlbGwtZmlsdGVyaW5nIGFwcHJvYWNoZXMgYW5kIGFwcGx5IHRoZW0gdG8gb3VyIGRhdGFzZXQuCgo8IS0tIENoYWxsZW5nZSBmb3IgaW5zdHJ1Y3RvcnM6IEV2ZXJ5IHZpZ25ldHRlIHVzZXMgZGlmZmVyZW50IGZpbHRlcnMsIGhvdyB0byBoYXJtb25pemUvZ2l2ZSBndWlkYW5jZT8gUmVsYXRlZCwgaG93IG11Y2ggdG8gZGlzY3VzcyBhcmJpdHJhcnkgY3V0b2ZmcyBhbmQgY29udGludWVkIG1hdHVyYXRpb24gb2YgZmllbGQ/LS0+IAo8IS0tIEFkZCBsaW5rcyB0byByZWxldmFudCByZXNvdXJjZXMgdGhyb3VnaG91dCAtLT4gCgo8IS0tIEdlbmVyYWwgZ3VpZGFuY2UgLSBsaWtlbHkgdG8gYmUgbW92ZWQgdG8gZWFybGllciBzZWN0aW9uOgotIE5vdGUgd2l0aCBlYWNoIGZ1bmN0aW9uIGNhbGwgd2hhdCBnZXRzIGFkZGVkIHRvIHRoZSBTZXVyYXQgb2JqZWN0LgotIEFkZGluZyBjaGVja3MgdG8gZW5zdXJlIG9iamVjdCBpcyB1cGRhdGVkIGJ5IGxlYXJuZXJzIHNpbmNlIHdhbnQgdG8gYXZvaWQgZ2VuZXJhdGluZyBjb3BpZWQgb2JqZWN0cwotIE5vdGUgd2hhdCBsYXllcnMgc2hvdWxkIGJlIHVzZWQgZm9yIHdoYXQsIGZvciBleGFtcGxlLCBjb3VudHMgdXNlZCBmb3IgRmVhdHVyZVBsb3RzLiBSTkEgdnMgU0NUIGFzc2F5LiAtLT4KCi0tLQoKYGBge3IsIHJlYWRfcmRzX2hpZGRlbiwgZWNobyA9IEZBTFNFLCB3YXJuaW5nID0gRkFMU0UsIG1lc3NhZ2UgPSBGQUxTRX0KaWYoIWV4aXN0cygnZ2VvX3NvJykpIHsKICBsaWJyYXJ5KFNldXJhdCkKICBsaWJyYXJ5KEJQQ2VsbHMpCiAgbGlicmFyeSh0aWR5dmVyc2UpCgogIG9wdGlvbnMoZnV0dXJlLmdsb2JhbHMubWF4U2l6ZSA9IDFlOSkKCiAgZ2VvX3NvID0gcmVhZFJEUygncmVzdWx0cy9yZGF0YS9nZW9fc29fdW5maWx0ZXJlZC5yZHMnKQp9CmBgYAoKIyBBZGRpbmcgbWV0YWRhdGEKCldlJ3JlIGdvaW5nIHRvIGFsdGVyIGFuZCBhZGQgc29tZSBjb2x1bW5zIHRvIGBtZXRhLmRhdGFgIHRvIGVhc2Ugc29tZSBkb3duc3RyZWFtIGFuYWx5c2lzIGFuZCBwbG90dGluZyBzdGVwcy4gVGhpcyB3aWxsIG9mdGVuIGJlIG5lY2Vzc2FyeSwgYXMgc2FtcGxlIG5hbWVzIGNvbnRhaW4gY29tYmluZWQgaW5mb3JtYXRpb24gYWJvdXQgcGhlbm90eXBlcy4gTGV0J3MgdGFrZSBhIGxvb2sgYXQgdGhlIGZpcnN0IGZldyByb3dzIGFnYWluLCB0byByZWFjcXVhaW50IG91cnNlbHZlcy4KCmBgYHtyLCBwcmV2aWV3X21ldGFkYXRhMX0KIyBFeGFtaW5lIFNldXJhdCBtZXRkYXRhICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmhlYWQoZ2VvX3NvQG1ldGEuZGF0YSkKYGBgCgpXZSBjYW4gYWRkIGFyYml0cmFyeSBwZXItY2VsbCBpbmZvcm1hdGlvbiB0byB0aGlzIHRhYmxlIHN1Y2ggYXM6CgotIFN1bW1hcnkgc3RhdGlzdGljcywgc3VjaCBhcyBwZXJjZW50IG1pdG9jaG9uZHJpYWwgcmVhZHMgZm9yIGVhY2ggY2VsbC4KLSBCYXRjaCwgY29uZGl0aW9uLCBldGMuIGZvciBlYWNoIGNlbGwuCi0gQ2x1c3RlciBtZW1iZXJzaGlwIGZvciBlYWNoIGNlbGwuCi0gQ2VsbCBjeWNsZSBwaGFzZSBmb3IgZWFjaCBjZWxsLgotIE90aGVyIGN1c3RvbSBhbm5vdGF0aW9ucyBmb3IgZWFjaCBjZWxsLgoKVGhlIGZvbGxvd2luZyBjb2RlIGNodW5rIHdpbGwgY3JlYXRlIG5ldyBjb2x1bW5zIGZyb20gdGhlIGBvcmlnLmlkZW50YCBjb2x1bW4sIG9uZSBmb3IgdGhlIGBkYXlgIGFuZCBvbmUgZm9yIHRoZSBgcmVwbGljYXRlYC4gV2UnbGwgYWxzbyB1c2UgZmFjdG9ycyB0byBtYWtlIHRoZSBkYXlzIGFwcGVhciBpbiB0aGUgY29ycmVjdCBvcmRlciAoYnkgZGVmYXVsdCBSIHdpbGwgb3JkZXIgdGhlbSBEYXkwLCBEYXkyMSwgRGF5NykuCgpgYGB7ciwgYWx0ZXJfbWV0YWRhdGF9CiMgTWFrZSBtZXRhZGF0YSBtb3JlIGdyYW51bGFyIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIChTbyBpdCdzIGVhc2llciBmb3IgdXMgdG8gdW5kZXJzdGFuZCkgIAoKb3JpZy5pZGVudF9sZXZlbHMgPSBhcHBseSgKICAgIGV4cGFuZC5ncmlkKGMoJ0hPJyksIGMoJ3JlcGxpY2F0ZTEnLCAncmVwbGljYXRlMicsICdyZXBsaWNhdGUzJywgJ3JlcGxpY2F0ZTQnKSwgYygnRGF5MCcsJ0RheTcnLCdEYXkyMScpKSwgCiAgICBNQVJHSU4gPSAxLCBGVU4gPSBmdW5jdGlvbihyb3cpe3Bhc3RlKHJvd1sxXSwgcm93WzNdLCByb3dbMl0sIHNlcCA9ICcuJyl9KQoKdG1wX21ldGEgPSBnZW9fc29AbWV0YS5kYXRhCgp0bXBfbWV0YSRvcmlnLmlkZW50ID0gZ3N1YignSE8nLCAnSE8uJywgdG1wX21ldGEkb3JpZy5pZGVudCkKdG1wX21ldGEkb3JpZy5pZGVudCA9IGdzdWIoJ3JlcCcsICcucmVwJywgdG1wX21ldGEkb3JpZy5pZGVudCkKCnRtcF9tZXRhJG9yaWcuaWRlbnQgPSBmYWN0b3IodG1wX21ldGEkb3JpZy5pZGVudCwgbGV2ZWxzID0gb3JpZy5pZGVudF9sZXZlbHMpCgojIEFkZCBkYXkgaW5mb3JtYXRpb24KdG1wX21ldGEkZGF5ID0gZmFjdG9yKHN0cl9zcGxpdCh0bXBfbWV0YSRvcmlnLmlkZW50LCBwYXR0ZXJuID0gJ1suXScsIHNpbXBsaWZ5ID0gVFJVRSlbLDJdLCBsZXZlbHMgPSBjKCdEYXkwJywgJ0RheTcnLCAnRGF5MjEnKSkKCiMgQWRkIHJlcGxpY2F0ZSBjb2x1bW4KdG1wX21ldGEkcmVwbGljYXRlID0gc3RyX3NwbGl0KHRtcF9tZXRhJG9yaWcuaWRlbnQsIHBhdHRlcm4gPSAnWy5dJywgc2ltcGxpZnkgPSBUUlVFKVssM10KCiMgQXNzaWduIHRoZSB1cGRhdGVkIG1ldGFkYXRhIHRvIHRoYXQgaW4gdGhlIFNldXJhdCBvYmplY3QKZ2VvX3NvQG1ldGEuZGF0YSA9IHRtcF9tZXRhCgojIFNldCB0aGUgSWRlbnRzKGdlb19zbykgdG8gdGhlIG5ldyBvcmlnLmlkZW50CklkZW50cyhnZW9fc28pID0gJ29yaWcuaWRlbnQnCmBgYAoKVGFraW5nIGEgbG9vayBhdCB0aGUgcmVzdWx0LCB3ZSBzZWUgYG9yaWcuaWRlbnRgIGxvb2tzIGEgbGl0dGxlIGRpZmZlcmVudCwgYW5kIHdlIGhhdmUgbmV3IGBkYXlgIGFuZCBgcmVwbGljYXRlYCBjb2x1bW5zLiBOb3RlIHRoYXQgdGhlcmUgYXJlIG1hbnkgd2F5cyB0byBoYXZlIGFjY29tcGxpc2hlZCB0aGlzLCB0aGUgYWJvdmUgY29kZSBpcyBqdXN0IG9uZSByb3V0ZS4KCmBgYHtyLCBwcmV2aWV3X21ldGFkYXRhM30KIyBSZS1leGFtaW5lIFNldXJhdCBtZXRkYXRhICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmhlYWQoZ2VvX3NvQG1ldGEuZGF0YSkKYGBgCgojIyBQZXJjZW50IG1pdG9jaG9uZHJpYWwgcmVhZHMKClRoZSBgUGVyY2VudGFnZUZlYXR1cmVTZXQoKWAgZnVuY3Rpb24gZW5hYmxlcyB1cyB0byBxdWlja2x5IGRldGVybWluZSB0aGUgY291bnRzIGJlbG9uZ2luZyB0byBhIHN1YnNldCBvZiB0aGUgcG9zc2libGUgZmVhdHVyZXMgZm9yIGVhY2ggY2VsbC4gU2luY2UgbWl0b2Nob25kcmlhbCB0cmFuc2NyaXB0cyBpbiBtb3VzZSBiZWdpbiB3aXRoICJtdCIsIHdlIHdpbGwgdXNlIHRoYXQgcGF0dGVybiB0byBjb3VudCB0aGUgcGVyY2VudGFnZSBvZiByZWFkcyBjb21pbmcgZnJvbSBtaXRvY2hvbmRyaWFsIHRyYW5zY3JpcHRzLgoKYGBge3IsIGFzc2lnbl9wZXJjZW50X210fQojIENvbnNpZGVyIG1pdG9jaG9uZHJpYWwgdHJhbnNjcmlwdHMgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiMgV2UgdXNlICJtdCIgYmVjYXVzZSB0aGlzIGlzIG1vdXNlLCBkZXBlbmRpbmcgb24gdGhlIG9yZ2FuaXNtLCB0aGlzIG1pZ2h0IG5lZWQgdG8gYmUgY2hhbmdlZApnZW9fc28kcGVyY2VudC5tdCA9IFBlcmNlbnRhZ2VGZWF0dXJlU2V0KGdlb19zbywgcGF0dGVybiA9ICdebXQtJykKCiMgVXNlIHN1bW1hcnkoKSB0byBxdWlja2x5IGNoZWNrIHRoZSByYW5nZSBvZiB2YWx1ZXMKc3VtbWFyeShnZW9fc28kcGVyY2VudC5tdCkKYGBgCgpKdXN0IGxvb2tpbmcgYXQgdGhlIHN1bW1hcnksIHdlIGNhbiBzZWUgdGhhdCB0aGVyZSBhcmUgc29tZSBjZWxscyB3aXRoIGEgaGlnaCBwZXJjZW50YWdlIG9mIG1pdG9jaG9uZHJpYWwgcmVhZHMuCgojIFF1YWxpdHkgTWV0cmljcwoKQ2VsbCBSYW5nZXIgaXMgYSBmaXJzdC1wYXNzIGZpbHRlciB0byBkZXRlcm1pbmUgd2hhdCBpcyBhICJjZWxsIiBhbmQgd2hhdCBpcyBub3QuIEl0IG9ubHkgY29uc2lkZXJzIG9uZSBzYW1wbGUgYXQgYSB0aW1lLCBhbmQgZG9lcyBub3QgY29uc2lkZXIgdGhlIGNlbGxzIHJlbGF0aXZlIHRvIG9uZSBhbm90aGVyLiAKCkxldCdzIGRpZyBkZWVwZXIgdG8gZGV0ZXJtaW5lIHdoZW4gYSBkcm9wbGV0IG1pZ2h0IGNvbnRhaW4gdHdvIGNlbGxzLCBhIHZlcnkgc3RyZXNzZWQgY2VsbCwgb3Igc29tZSB0ZWNobmljYWwgaXNzdWUgaW4gdGhlIGxpYnJhcnkgcHJlcGFyYXRpb24uIFdlIHdpbGwgdXNlIHRocmVlIG1ldHJpY3MgdG8gZGV0ZXJtaW5lIGxvdy1xdWFsaXR5IGNlbGxzIGJhc2VkIG9uIHRoZWlyIGV4cHJlc3Npb24gcHJvZmlsZXMgKFtyZWZlcmVuY2VdKGh0dHBzOi8vYmlvY29uZHVjdG9yLm9yZy9ib29rcy8zLjEyL09TQ0EvcXVhbGl0eS1jb250cm9sLmh0bWwjY2hvaWNlLW9mLXFjLW1ldHJpY3MpKS4KCjEuIFRoZSB0b3RhbCBudW1iZXIgb2YgVU1JcyBkZXRlY3RlZC4gQ2VsbHMgd2l0aCBhIHNtYWxsIG51bWJlciBvZiBVTUlzIGRldGVjdGVkIG1heSBpbmRpY2F0ZSBsb3NzIG9mIFJOQSBkdXJpbmcgbGlicmFyeSBwcmVwYXJhdGlvbiB2aWEgY2VsbCBseXNpcyBvciBpbmVmZmljaWVudCBjRE5BIGNhcHR1cmUgLyBhbXBsaWZpY2F0aW9uLiBDZWxscyB3aXRoIHJlbGF0aXZlbHkgaGlnaCBudW1iZXIgb2YgVU1JcyBkZXRlY3RlZCBtYXkgaW5kaWNhdGUgYSBkb3VibGV0LgoyLiBUaGUgbnVtYmVyIG9mIGV4cHJlc3NlZCBmZWF0dXJlcywgZGVmaW5lZCBhcyBudW1iZXIgb2YgZ2VuZXMgd2l0aCBub24temVybyBjb3VudHMuIENlbGxzIHdpdGggdmVyeSBmZXcgbWVhc3VyZWQgZ2VuZXMgYXJlIGxpa2VseSB0byBiZSBvZiBsb3ctcXVhbGl0eSwgYW5kIG1heSBkaXN0b3J0IGRvd25zdHJlYW0gdmFyaWFuY2UgZXN0aW1hdGlvbiBvciBkaW1lbnNpb24gcmVkdWN0aW9uIHN0ZXBzLgozLiBUaGUgcHJvcG9ydGlvbiBvZiByZWFkcyBtYXBwZWQgdG8gdGhlIG1pdG9jaG9uZHJpYWwgZ2Vub21lLiBIaWdoIHByb3BvcnRpb25zIG9mIG1pdG9jaG9uZHJpYWwgdHJhbnNjcmlwdHMgbWF5IGluZGljYXRlIGEgZGFtYWdlZCBjZWxsLCB0aGUgbWVhc3VyZSBvZiB3aGljaCBtYXkgYWxzbyBkaXN0b3J0IGRvd25zdHJlYW0gYW5hbHlzaXMgc3RlcHMuCgpUaGUgbnVtYmVyIG9mIFVNSXMgZGV0ZWN0ZWQgKGBuQ291bnRgKSBhbmQgbnVtYmVyIG9mIGV4cHJlc3NlZCBmZWF0dXJlcyAoYG5GZWF0dXJlYCkgYXJlIGFscmVhZHkgZ2l2ZW4gaW4gdGhlIG1ldGEgZGF0YSB0YWJsZS4KCj4gKipXaHkgdG90YWwgVU1JcyBpbnN0ZWFkIG9mIHRvdGFsIHJlYWRzPyoqCj4gCj4gU2luY2UgYSBzaW5nbGUtY2VsbCBpbmhlcmVudGx5IGNvbnRhaW5zIGEgbGltaXRlZCBhbW91bnQgb2YgUk5BIG1vbGVjdWxlcywgYSBoaWdoZXIgYW1vdW50IG9mIFBDUiBhbXBsaWZpY2F0aW9uIGlzIHJlcXVpcmVkIHRvIGdlbmVyYXRlIHRoZSBmaW5hbCBzZXF1ZW5jaW5nIGxpYnJhcnkuCj4gCj4gU2luY2UgUENSIGNhbiBza2V3IHByb3BvcnRpb25zIG9mIGluaXRpYWwgaW5wdXQgbWF0ZXJpYWxzLCBzcGVjaWZpYyBzZXF1ZW5jZXMgYXJlIGluY2x1ZGVkIGluIHRoZSBpbml0aWFsIGNhcHR1cmUgcHJvYmVzIGNhbGxlZCB1bmlxdWUgbW9sZWN1bGUgaWRlbnRpZmllcnMgKFVNSXMpLiBBcyBlYWNoIGluaXRpYWwgcHJvYmUgaGFzIGEgZGlmZmVyZW50IFVNSSBzZXF1ZW5jZSwgZWFjaCBSTkEgY2FwdHVyZWQgd2lsbCBiZSB0YWdnZWQgd2l0aCBhIGRpZmZlcmVudCBVTUksIHdoaWNoIGFsbG93cyB0aG9zZSBpbml0aWFsIFJOQXMgYW5kIHN1YnNlcXVlbnQgUENSIGR1cGxpY2F0ZXMgdG8gYmUgaWRlbnRpZmllZCBhbmQgZHVwbGljYXRlcyBjb2xsYXBzZWQgYXMgcGFydCBvZiB0aGUgaW5pdGlhbCBwcm9jZXNzaW5nIGJ5IENlbGxSYW5nZXIuICAKPgoKPiAqKk90aGVyIG1lYW5pbmdzIG9mIGBuRmVhdHVyZXNgKioKPiAKPiBGb3Igb3RoZXIgc2luZ2xlLWNlbGwgZGF0YSB0eXBlcywgYG5GZWF0dXJlc2Agd291bGQgcmVwcmVzZW50IHdoYXQncyBiZWluZyBtZWFzdXJlZCBpbiB0aGF0IGV4cGVyaW1lbnQuIEZvciBzaW5nbGUtY2VsbCBBVEFDLXNlcSwgYG5GZWF0dXJlc2Agd291bGQgcmVwcmVzZW50cyB0aGUgdG90YWwgbnVtYmVyIG9mIHBlYWtzIChlLmcuIGFjY2Vzc2libGUgYXJlYXMgb2YgRE5BKSBwZXIgY2VsbC4KPgoKPCEtLSBNYXR0IG1heSBoYXZlIGRpc2N1c3NlZCBVTUlzIGFzIHBhcnQgb2YgQ2VsbFJhbmdlciBwcm9jZXNzaW5nIGFuZCBMaXYvVHJpY2lhIG1heSB0b3VjaCBvbiBhcyBwYXJ0IG9mIGxpYnJhcnkgZ2VuZXJhdGlvbiBhdCBlbmQgb2YgRGF5IDIgLS0+CgojIyBDZWxsIGNvdW50cwoKQ2VsbCBjb3VudHMgcGVyIHNhbXBsZSAoYmFzZWQgb24gdGhlIG51bWJyZXIgb2YgdW5pcXVlIGNlbGx1bGFyIGJhcmNvZGVzIGRldGVjdGVkIGJ5IENlbGwgUmFuZ2VyKSBjYW4gaW5kaWNhdGUgaWYgYW4gZW50aXJlIHNhbXBsZSB3YXMgb2YgcG9vciBxdWFsaXR5LiBUaGUgdGFibGUgYmVsb3cgaXMgdGhlIG51bWJlciBvZiBjZWxscyBjYWxsZWQgYnkgQ2VsbCBSYW5nZXIsIHdpdGggdGhlIGFkZGVkIGZpbHRlciBmcm9tIGBDcmVhdGVTZXVyYXRlT2JqZWN0KClgIGluIHRoZSBwcmV2aW91cyBsZXNzb246IGBtaW4uY2VsbHMgPSAxLCBtaW4uZmVhdHVyZXMgPSA1MGAuIFJlY2FsbCwgdGhpcyBtZWFucyBhIGdlbmUgaXMgcmVtb3ZlZCBpZiBpdCBpcyBleHByZXNzZWQgaW4gMSBvciBmZXdlciBjZWxscywgYW5kIGEgY2VsbCBpcyByZW1vdmVkIGlmIGl0IGNvbnRhaW5zIHJlYWRzIGZvciA1MCBvciBmZXdlciBnZW5lcy4KCmBgYHtyLCBwcmVmaWx0ZXJfY2VsbF9jb3VudHN9CiMgQXNzaWduIG92ZXJhbGwgY2VsbCBjb3VudHMgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjZWxsX2NvdW50c19wcmVfdGJsID0gZ2VvX3NvQG1ldGEuZGF0YSAlPiUgY291bnQob3JpZy5pZGVudCwgbmFtZSA9ICdwcmVmaWx0ZXJfY2VsbHMnKQpjZWxsX2NvdW50c19wcmVfdGJsCmBgYAoKSXQgYXBwZWFycyB0aGF0IHRoZSBEYXkgNyBzYW1wbGVzIGhhdmUgc3lzdGVtYXRpY2FsbHkgbW9yZSBjZWxscyB0aGFuIHRoZSBvdGhlciBkYXlzLiBJZiB5b3UgaGFkIGFuIGlkZWEgb2YgaG93IG1hbnkgY2VsbHMgeW91IGV4cGVjdGVkIHRvIHNlZSBwZXIgc2FtcGxlLCB0aGlzIHRhYmxlIGNhbiBoZWxwIHlvdSBjaGVjayB0aGF0IGV4cGVjdGF0aW9uIGFuZCBkZXRlcm1pbmUgaWYgYSBzYW1wbGUgZmFpbGVkIGFuZCBzaG91bGQgYmUgZHJvcHBlZC4KCiMjIFZpc3VhbGl6aW5nIHF1YWxpdHkgbWV0cmljcwoKQSB2aW9saW4gcGxvdCBzaG93cyB0aGUgZGlzdHJpYnV0aW9uIG9mIGEgcXVhbnRpdHkgYW1vbmcgdGhlIGNlbGxzIGluIGEgc2luZ2xlIHNhbXBsZSwgb3IgYWNyb3NzIG1hbnkgc2FtcGxlcy4gU2V1cmF0IGhhcyBhIGJ1aWx0LWluIGZ1bmN0aW9uLCBgVmxuUGxvdCgpYCBmb3IgdGhpcyBwdXJwb3NlLiBMZXQncyBvcmllbnQgd2l0aCBhIHZpb2xpbiBwbG90IG9mIGBuRmVhdHVyZV9STkFgIGZvciBvbmx5IG9uZSBzYW1wbGUsIGBITy5EYXkyMS5yZXBsaWNhdGUxYDoKCmBgYHtyLCBzaW5nbGVfdmlvbGluX3Bsb3QsIGVjaG8gPSBGQUxTRX0KVmxuUGxvdChzdWJzZXQoZ2VvX3NvLCBvcmlnLmlkZW50ID09ICdITy5EYXkyMS5yZXBsaWNhdGUxJyksIGZlYXR1cmVzID0gJ25GZWF0dXJlX1JOQScsIGFzc2F5ID0gJ1JOQScsIGxheWVyID0gJ2NvdW50cycpICsgTm9MZWdlbmQoKQpgYGAKCkEgdmlvbGluIHBsb3QgaXMgc2ltaWxhciB0byBhIGJveCBwbG90LCBidXQgaXQgc2hvd3MgdGhlIGRlbnNpdHkgb2YgdGhlIGRhdGEgYXQgZGlmZmVyZW50IHZhbHVlcy4gSGVyZSB0aGUgaW5kaXZpZHVhbCBwb2ludHMgYXJlIHRoZSBjZWxscyBmcm9tIGBITy5EYXkyMS5yZXBsaWNhdGUxYCBhbmQgdGhlIHktYXhpcyBpcyB0aGUgdmFsdWUgb2YgYG5GZWF0dXJlX1JOQWAgZm9yIHRoYXQgY2VsbC4gVGhlIHZpb2xpbiBwYXJ0IG9mIHRoZSBmdW5jdGlvbiBpcyBlc3NlbnRpYWxseSBzaG93aW5nIHRoZSBkZW5zaXR5IG9mIHRoZSBjZWxscyBhdCBkaWZmZXJlbnQgdmFsdWVzIG9mIGBuRmVhdHVyZV9STkFgLgoKIyMjIEdlbmVzIHBlciBjZWxsCgpMZXQncyBsb29rIGF0IHRoZSBgbkZlYXR1cmVfUk5BYCB2aW9saW4gcGxvdCBhY3Jvc3MgYWxsIHRoZSBzYW1wbGVzLiBBZ2FpbiwgdGhpcyBpcyB0aGUgbnVtYmVyIG9mIGdlbmVzIGRldGVjdGVkIHBlciBjZWxsLgoKYGBge3IsIGZlYXR1cmVfcGxvdCwgZmlnLnNob3cgPSAnaG9sZCd9CiMgUmV2aWV3IGZlYXR1cmUgdmlvbGluIHBsb3RzICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpWbG5QbG90KGdlb19zbywgZmVhdHVyZXMgPSAnbkZlYXR1cmVfUk5BJywgYXNzYXkgPSAnUk5BJywgbGF5ZXIgPSAnY291bnRzJykgKyBOb0xlZ2VuZCgpICsgZ2VvbV9obGluZSh5aW50ZXJjZXB0ID0gNTAwKSArIGdlb21faGxpbmUoeWludGVyY2VwdCA9IDQwMCkgKyBnZW9tX2hsaW5lKHlpbnRlcmNlcHQgPSAzMDApICsgZ2VvbV9obGluZSh5aW50ZXJjZXB0ID0gMjAwKQpnZ3NhdmUoZmlsZW5hbWUgPSAncmVzdWx0cy9maWd1cmVzL3FjX25GZWF0dXJlX3Zpb2xpbi5wbmcnLCB3aWR0aCA9IDEyLCBoZWlnaHQgPSA2LCB1bml0cyA9ICdpbicpCmBgYAoKV2Ugb2JzZXJ2ZSB0aGF0IHNhbXBsZXMgYmVoYXZlIHNpbWlsYXJseSB3aXRoaW4gYSBkYXksIGJ1dCBoYXZlIGRpZmZlcmVudCBkaXN0cmlidXRpb25zIGFjcm9zcyBkYXlzLiBXZSBhbHNvIG5vdGUgdGhhdCBtYW55IGNlbGxzIGFwcGVhciB0byBoYXZlIGEgbG93IG51bWJlciBvZiBnZW5lcyBkZXRlY3RlZCAoPCA1MDApLgoKIyMjIFVNSSBjb3VudHMgcGVyIGNlbGwKCk5vdyBsZXQncyBsb29rIGF0IGBuQ291bnRfUk5BYCBwbG90LCB0aGUgdG90YWwgbnVtYmVyIG9mIFVNSXMgZGV0ZWN0ZWQuCgpgYGB7ciwgY291bnRfcGxvdCwgZmlnLnNob3cgPSAnaG9sZCd9CiMgUmV2aWV3IGNvdW50IHZpb2xpbiBwbG90cyAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpWbG5QbG90KGdlb19zbywgZmVhdHVyZXMgPSAnbkNvdW50X1JOQScsIGFzc2F5ID0gJ1JOQScsIGxheWVyID0gJ2NvdW50cycpICsgTm9MZWdlbmQoKQpnZ3NhdmUoZmlsZW5hbWUgPSAncmVzdWx0cy9maWd1cmVzL3FjX25Db3VudF92aW9saW4ucG5nJywgd2lkdGggPSAxMiwgaGVpZ2h0ID0gNiwgdW5pdHMgPSAnaW4nKQpgYGAKCldlIG9ic2VydmUgYSBzaW1pbGFyIHdpdGhpbi1hbmQtYWNyb3NzIGRheSBiZWhhdmlvciBhbW9uZyB0aGUgc2FtcGxlcy4gT3ZlcmFsbCBpdCBhcHBlYXJzIHRoYXQgdGhlIERheSAwIHNhbXBsZXMgaGF2ZSBmZXdlciBVTUlzIGRldGVjdGVkIHBlciBjZWxsIHRoYW4gRGF5IDcgYW5kIERheSAyMS4gQWxzbyBvZiBub3RlIGlzIHRoZSBvdXRsaWVyIGNlbGwgaW4gSE8uRGF5MC5yZXBsaWNhdGUxLCB3aXRoIGFyb3VuZCAxMDBLIFVNSXMgZGV0ZWN0ZWQuIFRoaXMgY2VsbCBtaWdodCBiZSBhIGRvdWJsZXQuCgojIyMgUGVyY2VudCBtaXRvY2hvbmRyaWFsIHJlYWRzCgpGaW5hbGx5LCBsZXRzIHBsb3QgdGhlIHBlcmNlbnQgbWl0b2Nob25kcmlhbCByZWFkcywgYHBlcmNlbnQubXRgLgoKYGBge3IsIG1pdG9fcGxvdCwgZmlnLnNob3cgPSAnaG9sZCd9CiMgUmV2aWV3IG1pdG9jaG9uZHJpYWwgdmlvbGluIHBsb3RzICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpWbG5QbG90KGdlb19zbywgZmVhdHVyZXMgPSAncGVyY2VudC5tdCcsIGFzc2F5ID0gJ1JOQScsIGxheWVyID0gJ2NvdW50cycpICsgTm9MZWdlbmQoKSArIGdlb21faGxpbmUoeWludGVyY2VwdCA9IDI1KSArIGdlb21faGxpbmUoeWludGVyY2VwdCA9IDIwKSArIGdlb21faGxpbmUoeWludGVyY2VwdCA9IDE1KSArIGdlb21faGxpbmUoeWludGVyY2VwdCA9IDEwKQpnZ3NhdmUoZmlsZW5hbWUgPSAncmVzdWx0cy9maWd1cmVzL3FjX21pdG9fdmlvbGluLnBuZycsIHdpZHRoID0gMTIsIGhlaWdodCA9IDYsIHVuaXRzID0gJ2luJykKYGBgCgpXZSBvYnNlcnZlIHRoZSBtYWpvcml0eSBvZiBjZWxscyBzZWVtIHRvIGhhdmUgPCAyNSUgbWl0b2Nob25kcmlhbCByZWFkcywgYnV0IHRoZXJlIGFyZSBtYW55IGNlbGxzIHdpdGggPiAyNSUgdGhhdCB3ZSBtYXkgd2FudCB0byByZW1vdmUuCgpHZW5lcmFsbHksIG1hbnkgdHV0b3JpYWxzIHVzZSBhIGN1dG9mZiBvZiA1IC0gMTAlIG1pdG9jaG9uZHJpYWwgcmVhZHMuIEhvd2V2ZXIsIGZvciBzb21lIGV4cGVyaW1lbnRzLCBoaWdoIG1pdG9jaG9uZHJpYWwgcmVhZHMgd291bGQgYmUgZXhwZWN0ZWQgKHN1Y2ggYXMgaW4gY2FzZXMgd2hlcmUgdGhlIGNvbmRpdGlvbi90cmVhdG1lbnQgb3IgZ2Vub3R5cGUgaW5jcmVhc2VzIGNlbGwgZGVhdGgpLiBJbiB0aGlzIGNhc2UsIGEgcmVsYXhlZCB0aHJlc2hvbGQgd291bGQgaGVscCBwcmVzZXJ2ZSBiaW9sb2dpY2FsbHkgcmVsZXZhbnQgY2VsbHMuIEluIG91ciBjYXNlLCB0aGUgY2VsbHMgd2VyZSBjb2xsZWN0ZWQgYXMgcGFydCBvZiBhbiBpbmp1cnkgbW9kZWwsIHBlcmhhcHMganVzdGlmeWluZyBhIG1vcmUgbGVuaWVudCBwZXJjZW50IG1pdG9jaG9uZHJpYWwgcmVhZCBmaWx0ZXIuCgojIEZpbHRlcmluZyBhcHByb2FjaGVzCgojIyBGaXhlZCB0aHJlc2hvbGRzCgpGaXhlZCB0aHJlc2hvbGRzIGZvciBhbnkgY29tYmluYXRpb24gb2YgYG5GZWF0dXJlX1JOQWAsIGBuQ291bnRfUk5BYCwgYW5kIGBwZXJjZW50Lm10YCBjYW4gYmUgc2VsZWN0ZWQgdG8gcmVtb3ZlIGxvdyBxdWFsaXR5IGNlbGxzLiBJbiBnZW5lcmFsLCBzZWxlY3RpbmcgdmVyeSBzdHJpbmdlbnQgdGhyZXNob2xkcyBmb3IgZWFjaCBvZiB0aGUgbWV0cmljcyBtYXkgbGVhZCB0byByZW1vdmluZyBpbmZvcm1hdGl2ZSBjZWxscy4gQXMgcGVyIHRoZSBIQkMgdHJhaW5pbmcgbWF0ZXJpYWxzIChbbGlua10oaHR0cHM6Ly9oYmN0cmFpbmluZy5naXRodWIuaW8vc2NSTkEtc2VxX29ubGluZS9sZXNzb25zLzA0X1NDX3F1YWxpdHlfY29udHJvbC5odG1sKSksIHdlIHJlY29tbWVuZCBzZXR0aW5nIGluZGl2aWR1YWwgdGhyZXNob2xkcyB0byBlcnIgb24gdGhlIHBlcm1pc3NpdmUgc2lkZS4KCltTb3JraW4gZXQgYWwuXShodHRwczovL3d3dy5uY2JpLm5sbS5uaWguZ292L3BtYy9hcnRpY2xlcy9QTUM3MDAyNDUzLykgY2hvc2UgdGhlc2UgdGhyZXNob2xkczoKCj4gV2UgZmlsdGVyZWQgb3V0IGNlbGxzIHdpdGggbGVzcyB0aGFuIDUwMCBnZW5lcyBwZXIgY2VsbCBhbmQgd2l0aCBtb3JlIHRoYW4gMjUlIG1pdG9jaG9uZHJpYWwgcmVhZCBjb250ZW50LgoKSW4gb3RoZXIgd29yZHMsIGNlbGxzIHdpdGggPiA1MDAgYG5GZWF0dXJlX1JOQWAgYW5kIDwgMjUlIGBwZXJjZW50Lm10YCB3ZXJlIHJldGFpbmVkIGJ5IHRoZSBhdXRob3JzLiBXZSBjb3VsZCBwcmV2aWV3IHdoYXQgdGhlIHJlc3VsdGluZyBjZWxsIGNvdW50cyB3b3VsZCBiZSB3aXRoIHRoZXNlIHRocmVzaG9sZHM6CgpgYGB7ciwgcHJldmlld19wb3N0ZmlsdGVyX2NlbGxfY291bnRzfQojIENvbnNpZGVyIGV4Y2x1ZGluZyBzdXNwZWN0IGNlbGxzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0Kc3Vic2V0KGdlb19zbywgc3Vic2V0ID0gbkZlYXR1cmVfUk5BID4gNTAwICYgcGVyY2VudC5tdCA8IDI1KUBtZXRhLmRhdGEgJT4lIAogICAgY291bnQob3JpZy5pZGVudCwgbmFtZSA9ICdwb3N0ZmlsdGVyX2NlbGxzJykKYGBgCgojIyBBZGFwdGl2ZSB0aHJlc2hvbGRzCgpGb3IgdGhpcyB3b3Jrc2hvcCB3ZSB3aWxsIHVzZSBmaXhlZCB0aHJlc2hvbGRzLCBidXQgYW5vdGhlciBvcHRpb24gaXMgdG8gcmVtb3ZlIGxvdy1xdWFsaXR5IGNlbGxzIGFkYXB0aXZlbHkuIFRoaXMgYXBwcm9hY2ggYXNzdW1lcyB0aGF0IG1vc3Qgb2YgdGhlIGNlbGxzIGFyZSBvZiBhY2NlcHRhYmxlIHF1YWxpdHkuIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB0aGUgcmVsZXZhbnQgc2VjdGlvbiBpbiBCaW9jb25kdWN0b3IncyBvbmxpbmUgYm9vazogT3JjaGVzdHJhdGluZyBTaW5nbGUtQ2VsbCBBbmFseXNpcyAoW2xpbmtdKGh0dHBzOi8vYmlvY29uZHVjdG9yLm9yZy9ib29rcy8zLjEyL09TQ0EvcXVhbGl0eS1jb250cm9sLmh0bWwjcXVhbGl0eS1jb250cm9sLW91dGxpZXIpKS4KCiMgUmVtb3ZpbmcgbG93LXF1YWxpdHkgY2VsbHMKCldlIHdpbGwgZGV2aWF0ZSBmcm9tIHRoZSBwdWJsaWNhdGlvbiBzbGlnaHRseSBhbmQgcmV0YWluIHRoZSBjZWxscyB3aXRoIGBuRmVhdHVyZV9STkEgPiAzMDBgIGFuZCBgcGVyY2VudC5tdCA8IDE1YC4gTm90aW5nIHRoYXQgdGhlIGBuRmVhdHVyZV9STkFgIHBsb3QgaGFkIGEgZ2FwIGFyb3VuZCAzMDAsIGFuZCB0aGF0IHdlIHdhbnQgdG8gYmUgbW9yZSBsZW5pZW50IHRoYW4gdGhlIHVzdWFsIDUtMTAlIGN1dG9mZiBmb3IgbWl0b2Nob25kcmlhbCByZWFkcy4KCmBgYHtyLCBmaWx0ZXJfc2V1cmF0fQojIEZpbHRlciB0byBleGNsdWRlIHN1c3BlY3QgY2VsbHMgYW5kIGFzc2lnbiB0byBuZXcgU2V1cmF0IG9iamVjdCAtLS0tLS0KZ2VvX3NvID0gc3Vic2V0KGdlb19zbywgc3Vic2V0ID0gbkZlYXR1cmVfUk5BID4gMzAwICYgcGVyY2VudC5tdCA8IDE1KQpnZW9fc28KYGBgCgpBbmQgbGV0J3MgcmVjb3JkIHRoZSBudW1iZXIgb2YgY2VsbHMgcmVtYWluaW5nIGFmdGVyIGZpbHRlcmluZzoKCmBgYHtyLCBwb3N0ZmlsdGVyX2NlbGxfY291bnRzfQojIFJlbWFpbmluZyBjZWxsIGNvdW50cyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KY2VsbF9jb3VudHNfcG9zdF90YmwgPSBnZW9fc29AbWV0YS5kYXRhICU+JSBjb3VudChvcmlnLmlkZW50LCBuYW1lID0gJ3Bvc3RmaWx0ZXJfY2VsbHMnKQpjZWxsX2NvdW50c19wb3N0X3RibApgYGAKCkxldCdzIGNvbWJpbmUgdGhlIHByZSBhbmQgcG9zdCB0YWJsZXM6CgpgYGB7ciwgY2VsbF9jb3VudHN9CiMgU2hvdyBjZWxsIGNvdW50cyBiZWZvcmUgYW5kIGFmdGVyIGZpbHRlcmluZyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjZWxsX2NvdW50c190YmwgPSBjZWxsX2NvdW50c19wcmVfdGJsICU+JSBsZWZ0X2pvaW4oY2VsbF9jb3VudHNfcG9zdF90YmwsIGJ5ID0gJ29yaWcuaWRlbnQnKQpjZWxsX2NvdW50c190YmwKYGBgCgpXZSBjYW4gbm93IGVhc2lseSBzZWUgaG93IG1hbnkgY2VsbHMgd2Ugc3RhcnRlZCB3aXRoLCBhbmQgaG93IG1hbnkgd2UgcmV0YWluZWQgZm9yIGRvd25zdHJlYW0gYW5hbHlzaXMuIExldCdzIHdyaXRlIHRoaXMgdGFibGUgdG8gYSBmaWxlLgoKYGBge3IsIHdyaXRlX2NlbGxfY291bnRzfQp3cml0ZV9jc3YoY2VsbF9jb3VudHNfdGJsLCBmaWxlID0gJ3Jlc3VsdHMvdGFibGVzL2NlbGxfZmlsdGVyaW5nX2NvdW50cy5jc3YnKQpgYGAKCjwhLS1XaGF0IHRocmVzaG9sZHMgd291bGQgd2Ugc3RhcnQgd2l0aCBiYXNlZCBvbiB0aGUgcGxvdHMgYWxvbmU/IEhvdyBkb2VzIHRoYXQgY29tcGFyZSB0byB0aGUgdGhyZXNob2xkcyByZXBvcnRlZCBpbiBwYXBlcj8tLT4KCjwhLS1PdGhlciDigJxhZHZhbmNlZOKAnSBtZXRob2RzOiBvdXQgb2Ygc2NvcGUgZm9yIHRoaXMgd29ya3Nob3AgYnV0IHRoZXJlIGFyZSBwYWNrYWdlcyAgc3BlY2lmaWNhbGx5IGRldmVsb3BlZCB0byBkZXRlY3QgImRvdWJsZXRzIiwgZS5nLiBkcm9wbGV0cyB0aGF0IGNvbnRhaW5lZCBtb3JlIHRoYW4gb25lIGNlbGwsIHN1Y2ggYXMgRG91YmxlRmluZGVyLS0+Cgo8IS0tQWRkaXRpb25hbCBhc2lkZSAtIEZvciBzaW5nbGUtbnVjbGVpIGV4cGVyaW1lbnRzIHJlbW92aW5nIGJhY2tncm91bmQvYW1iaWVudCBSTkEgd2l0aCBDZWxsQmxlbmRlciBPUiBEZWNvbnRYIGlzIGFuIGltcG9ydGFudCBhZGRpdGlvbmFsIHN0ZXAgc2luY2UgbnVjbGVpIGFyZSBib3RoIHN0aWNreSBhbmQgcG9yb3VzLS0+CgojIFJldmlzaW5nIHRocmVzaG9sZHMKCkl0IGlzIGltcG9ydGFudCB0byByZWNvZ25pemUgdGhhdCB0aHJlc2hvbGRzIGZvciByZXRhaW5pbmcgY2VsbHMgYXJlIG5vdCBzZXQgaW4gc3RvbmUuIEl0IG1heSBoYXBwZW4gdGhhdCB0aGUgZG93bnN0cmVhbSBhbmFseXNpcyBzdWdnZXN0cyB0aGF0IHRocmVzaG9sZHMgc2hvdWxkIGJlIG1vcmUgb3IgbGVzcyBzdHJpbmdlbnQuIEluIHdoaWNoIGNhc2UsIHlvdSBtYXkgZXhwZXJpbWVudCB3aXRoIHRoZSB0aHJlc2hvbGRzIGFuZCBvYnNlcnZlIHRoZSBkb3duc3RyZWFtIGVmZmVjdHMuCgojIFNhdmUgb3VyIHByb2dyZXNzCgpMZXQncyBzYXZlIHRoaXMgZmlsdGVyZWQgZm9ybSBvZiBvdXIgU2V1cmF0IG9iamVjdC4gSXQgd2lsbCBhbHNvIGluY2x1ZGUgb3VyIGNoYW5nZXMgdG8gdGhlIGBtZXRhLmRhdGFgOgoKYGBge3IsIHNhdmVfcmRzX2hpZGRlbiwgZWNobyA9IEZBTFNFfQppZighZmlsZS5leGlzdHMoJ3Jlc3VsdHMvcmRhdGEvZ2VvX3NvX2ZpbHRlcmVkLnJkcycpKSB7CiAgc2F2ZVJEUyhnZW9fc28sIGZpbGUgPSAncmVzdWx0cy9yZGF0YS9nZW9fc29fZmlsdGVyZWQucmRzJykKfQpgYGAKCmBgYHtyLCBzYXZlX3JkcywgZXZhbCA9IEZBTFNFfQojIFNhdmUgdGhlIGN1cnJlbnQgU2V1cmF0IG9iamVjdCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0Kc2F2ZVJEUyhnZW9fc28sIGZpbGUgPSAncmVzdWx0cy9yZGF0YS9nZW9fc29fZmlsdGVyZWQucmRzJykKYGBgCgojIFN1bW1hcnkKCkluIHRoaXMgc2VjdGlvbiB3ZToKCi0gRGlzY3Vzc2VkIHRoZSBiaWcgdGhyZWUgcXVhbGl0eSBtZXRyaWNzOiBgbkZlYXR1cmVgcywgYG5Db3VudGBzLCBhbmQgYHBlcmNlbnQubXRgLgotIFZpc3VhbGl6ZWQgdGhlc2UgbWV0cmljcyBhY3Jvc3MgY2VsbHMgLyBzYW1wbGVzIHRvIGhlbHAgaWRlbnRpZnkgbG93LXF1YWxpdHkgY2VsbHMuCi0gRmlsdGVyZWQgbG93LXF1YWxpdHkgY2VsbHMgdXNpbmcgZml4ZWQgdGhyZXNob2xkcy4KCk5leHQgc3RlcHM6IE5vcm1hbGl6YXRpb24KCi0tLS0KClRoZXNlIG1hdGVyaWFscyBoYXZlIGJlZW4gYWRhcHRlZCBhbmQgZXh0ZW5kZWQgZnJvbSBtYXRlcmlhbHMgbGlzdGVkIGFib3ZlLiBUaGVzZSBhcmUgb3BlbiBhY2Nlc3MgbWF0ZXJpYWxzIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgW0NyZWF0aXZlIENvbW1vbnMgQXR0cmlidXRpb24gbGljZW5zZSAoQ0MgQlkgNC4wKV0oaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbGljZW5zZXMvYnkvNC4wLyksIHdoaWNoIHBlcm1pdHMgdW5yZXN0cmljdGVkIHVzZSwgZGlzdHJpYnV0aW9uLCBhbmQgcmVwcm9kdWN0aW9uIGluIGFueSBtZWRpdW0sIHByb3ZpZGVkIHRoZSBvcmlnaW5hbCBhdXRob3IgYW5kIHNvdXJjZSBhcmUgY3JlZGl0ZWQuCgo8YnIvPgo8YnIvPgoKLS0tLS0tLQoKfCBbUHJldmlvdXMgbGVzc29uXSgwMEItQ2VsbFJhbmdlckluQWN0aW9uLmh0bWwpIHwgW1RvcCBvZiB0aGlzIGxlc3Nvbl0oI3RvcCkgfCBbTmV4dCBsZXNzb25dKDAzLU5vcm1hbGl6YXRpb24uaHRtbCkgfAp8IDotLS0gfCA6LS0tLTogfCAtLS06IHwK</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("02-QCandFiltering.Rmd");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
