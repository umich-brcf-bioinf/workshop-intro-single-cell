<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="UM Bioinformatics Core" />

<meta name="date" content="2024-04-12" />

<title>Clustering and Projection</title>

<script src="site_libs/header-attrs-2.25/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<!--
Favicon dervied from
https://twemoji.twitter.com/
https://favicon.io/emoji-favicons/dna/
-->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="shortcut icon" href="favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>




<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Intro to scRNA-Seq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="workshop_intro.html">Intro</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="00A-OrientingOnScRNASeq.html">Orienting on scRNA-Seq</a>
    </li>
    <li>
      <a href="01-GettingStarted.html">Getting Started with Seurat</a>
    </li>
    <li>
      <a href="00B-CellRangerInAction.html">Cell Ranger in Action</a>
    </li>
    <li>
      <a href="02-QCandFiltering.html">Secondary QC &amp; Filtering</a>
    </li>
    <li>
      <a href="03-Normalization.html">Normalization</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04-PCAandIntegration.html">PCA &amp; Integration</a>
    </li>
    <li>
      <a href="05-ProjectionAndClustering.html">Projection &amp; Clustering</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Day 3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="06-MarkerVisualization.html">Marker identification and visualization</a>
    </li>
    <li>
      <a href="07-CellTypeAnnos.html">Cell type annotation</a>
    </li>
    <li>
      <a href="08-DifferentialExpression.html">Differential expression analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="workshop_wrap_up.html">Wrap up</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Clustering and Projection</h1>
<h4 class="author">UM Bioinformatics Core</h4>
<h4 class="date">2024-04-12</h4>

</div>


<style type="text/css">
body, td {
   font-size: 18px;
}
code.r{
  font-size: 12px;
}
pre {
  font-size: 12px
}

table.fig, th.fig, td.fig {
  border: 1px solid black;
  border-collapse: collapse;
  padding: 15px;
}

table.fig, th.fig, td.fig {
  border: 1px solid black;
  border-collapse: collapse;
  padding: 15px;
}
</style>
<div id="workflow-overview" class="section level1 unlisted unnumbered">
<h1 class="unlisted unnumbered">Workflow Overview</h1>
<p><br/>
<img src="images/wayfinder/wayfinder.png" alt="wayfinder" style="height: 400px;"/>
<br/> <br/></p>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<!--- General goal: to generate clusters that reasonably approximate cell-types or sub-types of interest --->
<p>One of our goals in a single-cell analysis is to generate clusters
that reasonably approximate cell-types or sub-types of interest in our
samples before determining if there are differences in the proportions
of these populations or differences in gene expression within these
populations between experimental conditions.</p>
<table class="fig">
<tr class="fig">
<td class="fig">
<img
src="images/graphical_abstracts/graphical_abstract_cluster_projection.png" />
</td>
</tr>
<tr class="fig">
<td class="fig">
A. The filtered, normalized feature barcode matrix is the input to the
clustering step. <br/> B. Cells are plotted in a high-dimensional space
(num dimesnions = num of Principal Components, e.g. 15 dimensions);
cells with similar gene expression profiles are closer to each other and
are clustered together. <br/> C. The cells clusters are projected from
the high-dimensional space down to two-dimensional space for
visualization.
</td>
</tr>
</table>
<p><br/></p>
<p>In this section, we will demonstrate how to generate clusters using
Seurat’s graph based clustering approach and visualize those clustering
assignments via a lower-dimensional projection of the full dataset.</p>
<p>Like other steps in our analysis, multiple parameters may need to be
tested and evaluated while we would expect that only the final would be
reported. Clustering is considered part of data exploration so an
iterative approach is reasonable, and often expected (<a
href="https://bioconductor.org/books/3.15/OSCA.basic/clustering.html">source</a>).</p>
<div id="objectives" class="section level2">
<h2>Objectives</h2>
<ul>
<li>Understand the clustering process and input parameters</li>
<li>Generate initial clusters using ``</li>
<li>Visualize our clustering results</li>
</ul>
<hr />
</div>
</div>
<div id="clustering-and-projection" class="section level1">
<h1>Clustering and projection</h1>
<p>Now that we selected a number of PCs that we think are likely to
represent biological variation and integrated our data across
samples/batches, our next task is clustering.</p>
<p>An important aspect of parameter selection for clustering is to
understand the “resolution” of the underlying biology and your
experimental design:</p>
<ul>
<li>Is answering your biological question dependent on identifying rarer
cell types or specific subtypes?<br />
</li>
<li>Or are broader cell-types more relevant to address your biological
question?</li>
</ul>
<p>The OSCA book has a <a
href="https://bioconductor.org/books/3.15/OSCA.basic/clustering.html#overview-1">helpful
analogy comparing clustering to microscopy</a> and points out that
“asking for an unqualified ‘best’ clustering is akin to asking for the
best magnification on a microscope without any context”.</p>
<p>To generate clusters, we will generate “communities” of cells using
the PCs we selected, before choosing a resolution parameter to divide
those communities into discrete clusters.</p>
<!--- Contrast the previous dimensionality reduction versus nearest neighbors clustering and plotting the cells in lower dimensionality with the cluster labels? --->
<div id="clustering" class="section level2">
<h2>Clustering</h2>
<p>Seurat uses a graph-based clustering approach to assign cells to
clusters using a distance metric based on the previously generated PCs,
with improvements based on work by (<a
href="https://academic.oup.com/bioinformatics/article/31/12/1974/214505">Xu
and Su 2015</a>) and CyTOF data (<a
href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4508757/">Levine et
al. 2015</a>) implemented in Seurat v3 and v5 and building on the
initial strategies for droplet-based single-cell technology (<a
href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4481139/">Macosko et
al. 2015</a>) (<a
href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html">source</a>).
A key aspect of this process is that while the clusters are based on
similarity of expression between the cells, the clustering is based on
the selected PCs and not the full data set.</p>
<center>
<div class="float">
<img
src="images/curriculum/05-ProjectionAndClustering/BioCellGene-NearestNeighborNetworks.png"
alt="Image: kNN example - section on graph based clustering (from Cambridge Bioinformatics course)" />
<div class="figcaption">Image: kNN example - section on graph based
clustering (from Cambridge Bioinformatics course)</div>
</div>
</center>
<p>To briefly summarize, cells are embedded in a k-nearest neighbors
(kNN) graph (illustrated above) based on “the euclidean distance in PCA
space” between the cells and the edge weights between any two cells
(e.g. their “closeness”) is refined based on Jaccard similarity (<a
href="https://hbctraining.github.io/scRNA-seq_online/lessons/07_SC_clustering_cells_SCT.html">source</a>).</p>
<details>
<summary>
<em>Additional context and sources for graph-based clustering</em>
</summary>
<a
href="https://biocellgen-public.svi.edu.au/mig_2019_scrnaseq-workshop/clustering-and-cell-annotation.html">Cambridge
Bioinformatics’ Analysis of single cell RNA-seq data course
materials</a>, the source of the image above, delves into kNN and other
graph based clustering methods in much greater detail, including
outlining possible downsides for these methods. To described kNN, we
have also drawn from the <a
href="https://holab-hku.github.io/Fundamental-scRNA/downstream.html#perform-linear-dimensional-reduction">Ho
Lab’s description of this process for Seurat v3</a> as well as the <a
href="https://hbctraining.github.io/scRNA-seq_online/lessons/07_SC_clustering_cells_SCT.html">HBC
materials on clustering</a> and the <a
href="https://bioconductor.org/books/3.15/OSCA.basic/clustering.html#clustering-graph">OSCA
book’s more general overview of graph based clustering</a>, which also
describes the drawbacks for these methods.
</details>
<p><br></p>
<p>This process is performed with the <code>FindNeighbors()</code> <a
href="https://satijalab.org/seurat/reference/findneighbors">command</a>,
using the number of principal components we selected in the previous
section.</p>
<p>The second step is to iteratively partition the kNN graph into
“cliques” or clusters using the Louvain modularity optimization
algorithm (for the default parameters), with the “granularity” of the
clusters set by a <code>resolution</code> parameter (<a
href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html">source</a>).</p>
<div class="float">
<img
src="images/curriculum/05-ProjectionAndClustering/HBC-07-k-meansFigure.png"
alt="Image: K-means clustering example (from Cambridge Bioinformatics course)" />
<div class="figcaption">Image: K-means clustering example (from
Cambridge Bioinformatics course)</div>
</div>
<p>We’ll use the <code>FindClusters()</code> <a
href="https://satijalab.org/seurat/reference/findclusters">function</a>,
selecting a resolution of <code>0.4</code> to start, although we could
also add other resolutions at this stage to look at in later steps. See
<a
href="https://link.springer.com/article/10.1140/epjb/e2013-40829-0">Waltman
and Jan van Eck (2013)</a> for the underlying algorithms.</p>
<p>Again, how a “cell type” or “subtype” should be defined for your data
is important to consider in selecting a resolution - we’d start with a
higher resolution for smaller/more rare clusters and a lower resolution
for larger/more general clusters.</p>
<p>Then, when we look at the meta data we should see that cluster labels
have been added for each cell:</p>
<pre class="r"><code># Code block - clustering
# Create KNN graph with `FindNeighbors()`
geo_so = FindNeighbors(geo_so, dims = 1:pcs, reduction = &#39;integrated.sct.rpca&#39;)

# generate clusters
geo_so = FindClusters(geo_so, resolution = 0.4, cluster.name = &#39;integrated.sct.rpca.clusters&#39;)</code></pre>
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 29615
Number of edges: 978512

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.9388
Number of communities: 19
Elapsed time: 4 seconds</code></pre>
<pre class="r"><code># look at meta.data to see cluster labels
head(geo_so@meta.data)</code></pre>
<pre><code>                                            orig.ident nCount_RNA nFeature_RNA  day  replicate percent.mt nCount_SCT nFeature_SCT integrated.sct.rpca.clusters seurat_clusters
HODay0replicate1_AAACCTGAGAGAACAG-1 HO.Day0.replicate1      10234         3226 Day0 replicate1   1.240962       6061         2865                            1               1
HODay0replicate1_AAACCTGGTCATGCAT-1 HO.Day0.replicate1       3158         1499 Day0 replicate1   7.536415       4625         1510                            1               1
HODay0replicate1_AAACCTGTCAGAGCTT-1 HO.Day0.replicate1      13464         4102 Day0 replicate1   3.112002       5426         2485                            5               5
HODay0replicate1_AAACGGGAGGCCCGTT-1 HO.Day0.replicate1       1189          629 Day0 replicate1   3.700589       4165          919                            1               1
HODay0replicate1_AAACGGGCAACTGGCC-1 HO.Day0.replicate1       7726         2602 Day0 replicate1   2.938131       5858         2585                            1               1
HODay0replicate1_AAACGGGGTCCGAATT-1 HO.Day0.replicate1       5165         2362 Day0 replicate1   9.196515       5162         2348                            8               8</code></pre>
<p>Generally it’s preferable to err on the side of too many clusters, as
they can be combined manually in later steps. In our experience, this is
another parameter that often needs to be iteratively revised and
reviewed.</p>
<details>
<summary>
<em>Resolution parameter recommendations</em>
</summary>
The <a
href="https://holab-hku.github.io/Fundamental-scRNA/downstream.html#perform-linear-dimensional-reduction">Seurat
clustering tutorial</a> recommends selecting a resolution between 0.4 -
1.2 for datasets of approximately 3k cells, while the <a
href="https://hbctraining.github.io/scRNA-seq_online/lessons/07_SC_clustering_cells_SCT.html">HBC
course</a> recommends 0.4-1.4 for 3k-5k cells. However, in our
experience reasonable starting resolutions can be very dataset
dependent.
</details>
<p><br></p>
</div>
</div>
<div id="cluster-plots" class="section level1">
<h1>Cluster plots</h1>
<p>To visualize the cell clusters, we can use dimensionality reduction
techniques to visualize and explore our large, high-dimensional dataset.
Two popular methods that are supported by Seurat are t-distributed
stochastic neighbor embedding (t-SNE) and Uniform Manifold Approximation
and Projection (UMAP) techniques. These techniques allow us to visualize
our high-dimensional single-cell data in 2D space and see if cells
grouped together within graph-based clusters co-localize in these
representations (<a
href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html#run-non-linear-dimensional-reduction-umaptsne">source</a>).</p>
<p>While we unfortunately don’t have time to compare and contrast tSNE,
and UMAP, we would highly recommend <a
href="https://pair-code.github.io/understanding-umap/">this blog post
contrasting tSNE and UMAP</a> for illustrative examples. The Seurat
authors additionally caution that while these methods are useful for
data exploration, to avoid drawing biological conclusions solely based
on these visualizations (<a
href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html#run-non-linear-dimensional-reduction-umaptsne">source</a>).</p>
<p>To start this process, we’ll use the <code>RunUMAP()</code> <a
href="https://satijalab.org/seurat/reference/runumap">function</a> to
calculate the UMAP reduction for our data. Notice how the previous
dimensionality choices carry through the downstream analysis and that
the number of PCs selected in the previous steps are included as an
argument.</p>
<pre class="r"><code>geo_so = RunUMAP(geo_so, dims = 1:pcs, reduction = &#39;integrated.sct.rpca&#39;, reduction.name = &#39;umap.integrated.sct.rpca&#39;)
geo_so # Notice a third reduction has been added: `umap.integrated.sct.rpca`</code></pre>
<pre><code>An object of class Seurat 
47037 features across 29615 samples within 2 assays 
Active assay: SCT (20548 features, 3000 variable features)
 3 layers present: counts, data, scale.data
 1 other assay present: RNA
 3 dimensional reductions calculated: unintegrated.sct.pca, integrated.sct.rpca, umap.integrated.sct.rpca</code></pre>
</div>
<div id="visualizing-and-evaluating-clustering" class="section level1">
<h1>Visualizing and evaluating clustering</h1>
<!--- How many clusters should I get and how do I adjust the number? --->
<!--- Add example of changing resolution?--->
<p>After we generate the UMAP reduction, we can then visualize the
results using the <code>DimPlot()</code> <a
href="https://satijalab.org/seurat/reference/dimplot">function</a>,
labeling our plot by the auto generated <code>seurat_clusters</code>
that correspond to the most recent clustering results generated.</p>
<p>At this stage, we want to determine if the clusters look fairly well
separated, if they seem to correspond to how cells are grouped in the
UMAP, and if the number of clusters is generally aligned with the
resolution of our biological question. Again, if there are “too many”
clusters that’s not necessarily a problem.</p>
<p>We can also look at the same UMAP labeled by <code>day</code> to
visually inspect if the UMAP structure corresponds to the
<code>day</code>.</p>
<pre class="r"><code># Code block - UMAP cluster visualization 
# cluster ID labels
post_integration_umap_plot_clusters = DimPlot(geo_so, group.by = &#39;seurat_clusters&#39;, label = TRUE, reduction = &#39;umap.integrated.sct.rpca&#39;) + NoLegend()
post_integration_umap_plot_clusters</code></pre>
<p><img src="images/curriculum/05-ProjectionAndClustering/05-umap_by_clusters-1.png" width="816" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggsave(filename = &#39;results/figures/umap_integrated_sct_clusters.png&#39;, plot = post_integration_umap_plot_clusters, width = 6, height = 6, units = &#39;in&#39;)

# UMAP with day labels (note - we added this column to the meta-data yesterday)
post_integration_umap_plot_day = DimPlot(geo_so, group.by = &#39;day&#39;, label = FALSE, reduction = &#39;umap.integrated.sct.rpca&#39;)
post_integration_umap_plot_day</code></pre>
<p><img src="images/curriculum/05-ProjectionAndClustering/05-umap_by_clusters-2.png" width="816" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggsave(filename = &#39;results/figures/umap_integrated_sct_day.png&#39;, plot = post_integration_umap_plot_day, width = 8, height = 6, units = &#39;in&#39;)</code></pre>
<p>Similar to the PCA plots, the <code>day</code> labeled UMAP can tell
us if technical sources of variation might be driving or stratifying the
clusters, which would suggest that the normalization and integration
steps should be revisted before proceeding.</p>
<p>Another approach is to evaluate the number of cells per cluster using
the <code>table()</code> function, split by <code>day</code> or split by
<code>orig.ident</code> to see if the individual samples are driving any
of the UMAP structure:</p>
<pre class="r"><code># Code block - cell count tables
# cells per cluster, split by condition
table(geo_so@meta.data$day, geo_so@meta.data$integrated.sct.rpca.clusters)</code></pre>
<pre><code>       
           0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16   17   18
  Day0    88  938  239  167   38  242   36   94  814  132  119  298   55   29  159  133   57  141   19
  Day7  3434 1138 2507 2022 2409 1330 1594  935  119  546  562  325  626  659  309   98  262   88   36
  Day21 1438 1138  368  463  141  482   81  430  402  500  375  201  108   69   42  256  117  195   12</code></pre>
<pre class="r"><code># cells per cluster per sample
table(geo_so@meta.data$orig.ident, geo_so@meta.data$integrated.sct.rpca.clusters)</code></pre>
<pre><code>                     
                         0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16   17   18
  HO.Day0.replicate1    20  278   82   52   17   69   15   18  209   33   32   82   17   11   47   20    5   35    7
  HO.Day0.replicate2    13  127   37   33    5   23    6   24  162   27   20   56    8    6   13   25   13   16    1
  HO.Day0.replicate3    34  331   72   46    3   91    5   18  238   40   38   84   16    5   58   40   16   54    2
  HO.Day0.replicate4    21  202   48   36   13   59   10   34  205   32   29   76   14    7   41   48   23   36    9
  HO.Day7.replicate1   472  309  590  501  769  358  755  155   49  113  190   67  167  212   63   41   72   28   17
  HO.Day7.replicate2  1219  219  615  574  486  280  218  378   10  157  132  105  180  150   86   19   88   13    3
  HO.Day7.replicate3   957  457  727  531  407  465   90  243   50  177  145   90  163  152   93   27   72   37   14
  HO.Day7.replicate4   786  153  575  416  747  227  531  159   10   99   95   63  116  145   67   11   30   10    2
  HO.Day21.replicate1  369  363   99  145   38  172   30  134  119  145  110   63   35   14   13   66   26   56    3
  HO.Day21.replicate2  189  218   74   82   21   57   12   97  123   79   46   36   15   14    6   51   28   29    5
  HO.Day21.replicate3  203  187   73   91   25   67    8   61  102   90   68   31   16   20    7   55   20   39    3
  HO.Day21.replicate4  677  370  122  145   57  186   31  138   58  186  151   71   42   21   16   84   43   71    1</code></pre>
<!-- consider adding later 
Add DimPlot for % mitochondria to see if high % are across dataset or limited to one/few clusters (related to what Olivia talked about during Day 1)

# Other approaches for visualizing scRNA-sq data
e.g. code for tSNE visualization 
-->
</div>
<div id="comparing-to-unintegrated-data" class="section level1">
<h1>Comparing to unintegrated data</h1>
<p>If we had proceeded with our filtered data and only normalized our
data without doing any integration, including through the dimensionality
reduction and clustering steps and then labeled the cells with their
sample of origin, then we would see the following for our data:</p>
<!--Add updated example of UMAP / sample labels for unintegrated data - need to check with Raymond regarding how best to do this in place -->
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 29615
Number of edges: 928527

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.9379
Number of communities: 17
Elapsed time: 4 seconds</code></pre>
<p><img src="images/curriculum/05-ProjectionAndClustering/05-run_umap_unintegrated-1.png" width="816" style="display: block; margin: auto;" /></p>
<p>In the plot at left, we see that while there are distinct clusters,
those clusters seem to stratified by day. This suggests that without
integration, these batch effects could skew the biological variability
in our data. While on the right, we see little stratification within our
clusters which means the integration seems to have removed those batch
effects.</p>
<!-- Edit section to incorporate --->
<details>
<summary>
<strong>Rewind: Pre-integration evaluation clustering and visualization
(code)</strong>
</summary>
<p>Prior to integration, we could follow the same steps we’ve just run
for the integrated to see if the resulting clusters tend to be
determined by sample or condition (in this case, the day):</p>
<pre class="r"><code>geo_so = FindNeighbors(geo_so, dims = 1:pcs, assay = &#39;RNA&#39;, reduction = &#39;unintegrated.sct.pca&#39;, graph.name = c(&#39;RNA_nn&#39;, &#39;RNA_snn&#39;))
geo_so = FindClusters(geo_so, resolution = 0.4, graph.name = &#39;RNA_snn&#39;, cluster.name = &#39;unintegrated.sct.clusters&#39;)
geo_so = RunUMAP(geo_so, dims = 1:pcs, reduction = &#39;unintegrated.sct.pca&#39;, reduction.name = &#39;umap.unintegrated.sct.pca&#39;)</code></pre>
<p>The plots above were generated with:</p>
<pre class="r"><code>pre_integration_umap_plot_orig.ident = DimPlot(geo_so, group.by = &#39;orig.ident&#39;, label = FALSE, reduction = &#39;umap.unintegrated.sct.pca&#39;)
ggsave(filename = &#39;results/figures/umap_unintegrated_sct_orig.ident.png&#39;, plot = pre_integration_umap_plot_orig.ident, width = 8, height = 6, units = &#39;in&#39;)</code></pre>
<pre class="r"><code>pre_integration_umap_plot_day = DimPlot(geo_so, group.by = &#39;day&#39;, label = FALSE, reduction = &#39;umap.unintegrated.sct.pca&#39;)
ggsave(filename = &#39;results/figures/umap_unintegrated_sct_day.png&#39;, plot = pre_integration_umap_plot_day, width = 8, height = 6, units = &#39;in&#39;)</code></pre>
</details>
<p><br> <br></p>
<details>
<summary>
<strong>Alternative clustering resolutions</strong>
</summary>
<p>While we show a single resolution, we can generate and plot multiple
resolutions iteratively and compare between them before selecting a
clustering result for the next steps:</p>
<pre class="r"><code>resolutions = c(0.4, 0.8)

for(res in resolutions) {
    message(res)

    cluster_column = sprintf(&#39;SCT_snn_res.%s&#39;, res)
    umap_file = sprintf(&#39;results/figures/umap_integrated_sct_%s.png&#39;, res)

    geo_so = FindClusters(geo_so, resolution = res)

    DimPlot(geo_so, group.by = cluster_column, label = TRUE, reduction = &#39;umap.integrated.sct.rpca&#39;) + NoLegend()
    ggsave(filename = umap_file, width = 8, height = 7, units = &#39;in&#39;)
}</code></pre>
<p>In the results, we’ll see multiple resolutions should now be added to
the metadata slot.</p>
<pre class="r"><code>head(geo_so@meta.data)</code></pre>
</details>
<p><br> <br></p>
</div>
<div id="save-our-progress" class="section level1">
<h1>Save our progress</h1>
<p>Before moving on to our next section, we will output our updated
Seurat object to file:</p>
<pre class="r"><code>saveRDS(geo_so, file = &#39;results/rdata/geo_so_sct_clustered.rds&#39;)</code></pre>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>In this section we:</p>
<ul>
<li>Generated cluster assignments for our cells using
<code>FindNeighbors()</code> and <code>FindClusters()</code></li>
<li>Evaluated our initial clusters using <code>RunUMAP</code>
dimensional reduction and visualization</li>
</ul>
<p>Next steps: Marker genes</p>
<hr />
<p>These materials have been adapted and extended from materials listed
above. These are open access materials distributed under the terms of
the <a href="http://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution license (CC BY 4.0)</a>, which permits unrestricted
use, distribution, and reproduction in any medium, provided the original
author and source are credited.</p>
<br/> <br/>
<hr/>
<table style="width:100%;">
<colgroup>
<col width="28%" />
<col width="42%" />
<col width="28%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"><a href="04-PCAandIntegration.html">Previous
lesson</a></th>
<th align="center"><a href="#top">Top of this lesson</a></th>
<th align="right"><a href="06-MarkerVisualization.html">Next
lesson</a></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAiQ2x1c3RlcmluZyBhbmQgUHJvamVjdGlvbiIKYXV0aG9yOiAiVU0gQmlvaW5mb3JtYXRpY3MgQ29yZSIKZGF0ZTogImByIFN5cy5EYXRlKClgIgpvdXRwdXQ6CiAgICAgICAgaHRtbF9kb2N1bWVudDoKICAgICAgICAgICAgaW5jbHVkZXM6CiAgICAgICAgICAgICAgICBpbl9oZWFkZXI6IGhlYWRlci5odG1sCiAgICAgICAgICAgIHRoZW1lOiBwYXBlcgogICAgICAgICAgICB0b2M6IHRydWUKICAgICAgICAgICAgdG9jX2RlcHRoOiA0CiAgICAgICAgICAgIHRvY19mbG9hdDogdHJ1ZQogICAgICAgICAgICBudW1iZXJfc2VjdGlvbnM6IGZhbHNlCiAgICAgICAgICAgIGZpZ19jYXB0aW9uOiB0cnVlCiAgICAgICAgICAgIG1hcmtkb3duOiBHRk0KICAgICAgICAgICAgY29kZV9kb3dubG9hZDogdHJ1ZQotLS0KCjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CmJvZHksIHRkIHsKICAgZm9udC1zaXplOiAxOHB4Owp9CmNvZGUucnsKICBmb250LXNpemU6IDEycHg7Cn0KcHJlIHsKICBmb250LXNpemU6IDEycHgKfQoKdGFibGUuZmlnLCB0aC5maWcsIHRkLmZpZyB7CiAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7CiAgYm9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsKICBwYWRkaW5nOiAxNXB4Owp9Cgp0YWJsZS5maWcsIHRoLmZpZywgdGQuZmlnIHsKICBib3JkZXI6IDFweCBzb2xpZCBibGFjazsKICBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOwogIHBhZGRpbmc6IDE1cHg7Cn0KPC9zdHlsZT4KCmBgYHtyLCBpbmNsdWRlID0gRkFMU0V9CnNvdXJjZSgiLi4vYmluL2NodW5rLW9wdGlvbnMuUiIpCmtuaXRyX2ZpZ19wYXRoKCIwNS1Qcm9qZWN0aW9uQW5kQ2x1c3RlcmluZy8wNS0iKQpgYGAKCiMgV29ya2Zsb3cgT3ZlcnZpZXcgey51bmxpc3RlZCAudW5udW1iZXJlZH0KCjxici8+CjxpbWcgc3JjPSJpbWFnZXMvd2F5ZmluZGVyL3dheWZpbmRlci5wbmciIGFsdD0id2F5ZmluZGVyIiBzdHlsZT0iaGVpZ2h0OiA0MDBweDsiLz4KPGJyLz4KPGJyLz4KCiMgSW50cm9kdWN0aW9uCgo8IS0tLSBHZW5lcmFsIGdvYWw6IHRvIGdlbmVyYXRlIGNsdXN0ZXJzIHRoYXQgcmVhc29uYWJseSBhcHByb3hpbWF0ZSBjZWxsLXR5cGVzIG9yIHN1Yi10eXBlcyBvZiBpbnRlcmVzdCAtLS0+Ck9uZSBvZiBvdXIgZ29hbHMgaW4gYSBzaW5nbGUtY2VsbCBhbmFseXNpcyBpcyB0byBnZW5lcmF0ZSBjbHVzdGVycyB0aGF0IHJlYXNvbmFibHkgYXBwcm94aW1hdGUgY2VsbC10eXBlcyBvciBzdWItdHlwZXMgb2YgaW50ZXJlc3QgaW4gb3VyIHNhbXBsZXMgYmVmb3JlIGRldGVybWluaW5nIGlmIHRoZXJlIGFyZSBkaWZmZXJlbmNlcyBpbiB0aGUgcHJvcG9ydGlvbnMgb2YgdGhlc2UgcG9wdWxhdGlvbnMgb3IgZGlmZmVyZW5jZXMgaW4gZ2VuZSBleHByZXNzaW9uIHdpdGhpbiB0aGVzZSBwb3B1bGF0aW9ucyBiZXR3ZWVuIGV4cGVyaW1lbnRhbCBjb25kaXRpb25zLgoKPHRhYmxlIGNsYXNzPSdmaWcnPgo8dHIgY2xhc3M9J2ZpZyc+PHRkIGNsYXNzPSdmaWcnPiFbXShpbWFnZXMvZ3JhcGhpY2FsX2Fic3RyYWN0cy9ncmFwaGljYWxfYWJzdHJhY3RfY2x1c3Rlcl9wcm9qZWN0aW9uLnBuZyk8L3RkPjwvdHI+Cjx0ciBjbGFzcz0nZmlnJz48dGQgY2xhc3M9J2ZpZyc+QS4gVGhlIGZpbHRlcmVkLCBub3JtYWxpemVkIGZlYXR1cmUgYmFyY29kZSBtYXRyaXggaXMgdGhlIGlucHV0IHRvIHRoZSBjbHVzdGVyaW5nIHN0ZXAuIDxici8+CkIuIENlbGxzIGFyZSBwbG90dGVkIGluIGEgaGlnaC1kaW1lbnNpb25hbCBzcGFjZSAobnVtIGRpbWVzbmlvbnMgPSBudW0gb2YgUHJpbmNpcGFsIENvbXBvbmVudHMsIGUuZy4gMTUgZGltZW5zaW9ucyk7IGNlbGxzIHdpdGggc2ltaWxhciBnZW5lIGV4cHJlc3Npb24gcHJvZmlsZXMgYXJlIGNsb3NlciB0byBlYWNoIG90aGVyIGFuZCBhcmUgY2x1c3RlcmVkIHRvZ2V0aGVyLiA8YnIvPgpDLiBUaGUgY2VsbHMgY2x1c3RlcnMgYXJlIHByb2plY3RlZCBmcm9tIHRoZSBoaWdoLWRpbWVuc2lvbmFsIHNwYWNlIGRvd24gdG8gdHdvLWRpbWVuc2lvbmFsIHNwYWNlIGZvciB2aXN1YWxpemF0aW9uLgo8L3RkPjwvdHI+CjwvdGFibGU+Cjxici8+CgoKSW4gdGhpcyBzZWN0aW9uLCB3ZSB3aWxsIGRlbW9uc3RyYXRlIGhvdyB0byBnZW5lcmF0ZSBjbHVzdGVycyB1c2luZyBTZXVyYXQncyBncmFwaCBiYXNlZCBjbHVzdGVyaW5nIGFwcHJvYWNoIGFuZCB2aXN1YWxpemUgdGhvc2UgY2x1c3RlcmluZyBhc3NpZ25tZW50cyB2aWEgYSBsb3dlci1kaW1lbnNpb25hbCBwcm9qZWN0aW9uIG9mIHRoZSBmdWxsIGRhdGFzZXQuCgpMaWtlIG90aGVyIHN0ZXBzIGluIG91ciBhbmFseXNpcywgbXVsdGlwbGUgcGFyYW1ldGVycyBtYXkgbmVlZCB0byBiZSB0ZXN0ZWQgYW5kIGV2YWx1YXRlZCB3aGlsZSB3ZSB3b3VsZCBleHBlY3QgdGhhdCBvbmx5IHRoZSBmaW5hbCB3b3VsZCBiZSByZXBvcnRlZC4gQ2x1c3RlcmluZyBpcyBjb25zaWRlcmVkIHBhcnQgb2YgZGF0YSBleHBsb3JhdGlvbiBzbyBhbiBpdGVyYXRpdmUgYXBwcm9hY2ggaXMgcmVhc29uYWJsZSwgYW5kIG9mdGVuIGV4cGVjdGVkIChbc291cmNlXShodHRwczovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xNS9PU0NBLmJhc2ljL2NsdXN0ZXJpbmcuaHRtbCkpLiAKCgojIyBPYmplY3RpdmVzCgotIFVuZGVyc3RhbmQgdGhlIGNsdXN0ZXJpbmcgcHJvY2VzcyBhbmQgaW5wdXQgcGFyYW1ldGVycwotIEdlbmVyYXRlIGluaXRpYWwgY2x1c3RlcnMgdXNpbmcgYGAgCi0gVmlzdWFsaXplIG91ciBjbHVzdGVyaW5nIHJlc3VsdHMKCi0tLQoKYGBge3IsIHJlYWRfcmRzX2hpZGRlbiwgZWNobyA9IEZBTFNFLCB3YXJuaW5nID0gRkFMU0UsIG1lc3NhZ2UgPSBGQUxTRX0KaWYoIWV4aXN0cygnZ2VvX3NvJykpIHsKICBsaWJyYXJ5KFNldXJhdCkKICBsaWJyYXJ5KEJQQ2VsbHMpCiAgbGlicmFyeSh0aWR5dmVyc2UpCgogIG9wdGlvbnMoZnV0dXJlLmdsb2JhbHMubWF4U2l6ZSA9IDFlOSkKCiAgZ2VvX3NvID0gcmVhZFJEUygncmVzdWx0cy9yZGF0YS9nZW9fc29fc2N0X2ludGVncmF0ZWQucmRzJykKfQpgYGAKCiMgQ2x1c3RlcmluZyBhbmQgcHJvamVjdGlvbgoKTm93IHRoYXQgd2Ugc2VsZWN0ZWQgYSBudW1iZXIgb2YgUENzIHRoYXQgd2UgdGhpbmsgYXJlIGxpa2VseSB0byByZXByZXNlbnQgYmlvbG9naWNhbCB2YXJpYXRpb24gYW5kIGludGVncmF0ZWQgb3VyIGRhdGEgYWNyb3NzIHNhbXBsZXMvYmF0Y2hlcywgb3VyIG5leHQgdGFzayBpcyBjbHVzdGVyaW5nLiAKCgpBbiBpbXBvcnRhbnQgYXNwZWN0IG9mIHBhcmFtZXRlciBzZWxlY3Rpb24gZm9yIGNsdXN0ZXJpbmcgaXMgdG8gdW5kZXJzdGFuZCB0aGUgInJlc29sdXRpb24iIG9mIHRoZSB1bmRlcmx5aW5nIGJpb2xvZ3kgYW5kIHlvdXIgZXhwZXJpbWVudGFsIGRlc2lnbjogICAKCi0gSXMgYW5zd2VyaW5nIHlvdXIgYmlvbG9naWNhbCBxdWVzdGlvbiBkZXBlbmRlbnQgb24gaWRlbnRpZnlpbmcgcmFyZXIgY2VsbCB0eXBlcyBvciBzcGVjaWZpYyBzdWJ0eXBlcz8gICAKLSBPciBhcmUgYnJvYWRlciBjZWxsLXR5cGVzIG1vcmUgcmVsZXZhbnQgdG8gYWRkcmVzcyB5b3VyIGJpb2xvZ2ljYWwgcXVlc3Rpb24/ICAgCgpUaGUgT1NDQSBib29rIGhhcyBhIFtoZWxwZnVsIGFuYWxvZ3kgY29tcGFyaW5nIGNsdXN0ZXJpbmcgdG8gbWljcm9zY29weV0oaHR0cHM6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzLzMuMTUvT1NDQS5iYXNpYy9jbHVzdGVyaW5nLmh0bWwjb3ZlcnZpZXctMSkgYW5kIHBvaW50cyBvdXQgdGhhdCAiYXNraW5nIGZvciBhbiB1bnF1YWxpZmllZCAnYmVzdCcgY2x1c3RlcmluZyBpcyBha2luIHRvIGFza2luZyBmb3IgdGhlIGJlc3QgbWFnbmlmaWNhdGlvbiBvbiBhIG1pY3Jvc2NvcGUgd2l0aG91dCBhbnkgY29udGV4dCIuIAoKVG8gZ2VuZXJhdGUgY2x1c3RlcnMsIHdlIHdpbGwgZ2VuZXJhdGUgImNvbW11bml0aWVzIiBvZiBjZWxscyB1c2luZyB0aGUgUENzIHdlIHNlbGVjdGVkLCBiZWZvcmUgY2hvb3NpbmcgYSByZXNvbHV0aW9uIHBhcmFtZXRlciB0byBkaXZpZGUgdGhvc2UgY29tbXVuaXRpZXMgaW50byBkaXNjcmV0ZSBjbHVzdGVycy4KCjwhLS0tIENvbnRyYXN0IHRoZSBwcmV2aW91cyBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24gdmVyc3VzIG5lYXJlc3QgbmVpZ2hib3JzIGNsdXN0ZXJpbmcgYW5kIHBsb3R0aW5nIHRoZSBjZWxscyBpbiBsb3dlciBkaW1lbnNpb25hbGl0eSB3aXRoIHRoZSBjbHVzdGVyIGxhYmVscz8gLS0tPgoKIyMgQ2x1c3RlcmluZwoKU2V1cmF0IHVzZXMgYSBncmFwaC1iYXNlZCBjbHVzdGVyaW5nIGFwcHJvYWNoIHRvIGFzc2lnbiBjZWxscyB0byBjbHVzdGVycyB1c2luZyBhIGRpc3RhbmNlIG1ldHJpYyBiYXNlZCBvbiB0aGUgcHJldmlvdXNseSBnZW5lcmF0ZWQgUENzLCB3aXRoIGltcHJvdmVtZW50cyBiYXNlZCBvbiB3b3JrIGJ5IChbWHUgYW5kIFN1IDIwMTVdKGh0dHBzOi8vYWNhZGVtaWMub3VwLmNvbS9iaW9pbmZvcm1hdGljcy9hcnRpY2xlLzMxLzEyLzE5NzQvMjE0NTA1KSkgYW5kIEN5VE9GIGRhdGEgKFtMZXZpbmUgZXQgYWwuIDIwMTVdKGh0dHBzOi8vd3d3Lm5jYmkubmxtLm5paC5nb3YvcG1jL2FydGljbGVzL1BNQzQ1MDg3NTcvKSkgaW1wbGVtZW50ZWQgaW4gU2V1cmF0IHYzIGFuZCB2NSBhbmQgYnVpbGRpbmcgb24gdGhlIGluaXRpYWwgc3RyYXRlZ2llcyBmb3IgZHJvcGxldC1iYXNlZCBzaW5nbGUtY2VsbCB0ZWNobm9sb2d5IChbTWFjb3NrbyBldCBhbC4gMjAxNV0oaHR0cHM6Ly93d3cubmNiaS5ubG0ubmloLmdvdi9wbWMvYXJ0aWNsZXMvUE1DNDQ4MTEzOS8pKSAgKFtzb3VyY2VdKGh0dHBzOi8vc2F0aWphbGFiLm9yZy9zZXVyYXQvYXJ0aWNsZXMvcGJtYzNrX3R1dG9yaWFsLmh0bWwpKS4gQSBrZXkgYXNwZWN0IG9mIHRoaXMgcHJvY2VzcyBpcyB0aGF0IHdoaWxlIHRoZSBjbHVzdGVycyBhcmUgYmFzZWQgb24gc2ltaWxhcml0eSBvZiBleHByZXNzaW9uIGJldHdlZW4gdGhlIGNlbGxzLCB0aGUgY2x1c3RlcmluZyBpcyBiYXNlZCBvbiB0aGUgc2VsZWN0ZWQgUENzIGFuZCBub3QgdGhlIGZ1bGwgZGF0YSBzZXQuIAoKPGNlbnRlcj4KIVtJbWFnZToga05OIGV4YW1wbGUgLSBzZWN0aW9uIG9uIGdyYXBoIGJhc2VkIGNsdXN0ZXJpbmcgKGZyb20gQ2FtYnJpZGdlIEJpb2luZm9ybWF0aWNzIGNvdXJzZSldKC4vaW1hZ2VzL2N1cnJpY3VsdW0vMDUtUHJvamVjdGlvbkFuZENsdXN0ZXJpbmcvQmlvQ2VsbEdlbmUtTmVhcmVzdE5laWdoYm9yTmV0d29ya3MucG5nKQo8L2NlbnRlcj4KClRvIGJyaWVmbHkgc3VtbWFyaXplLCBjZWxscyBhcmUgZW1iZWRkZWQgaW4gYSBrLW5lYXJlc3QgbmVpZ2hib3JzIChrTk4pIGdyYXBoIChpbGx1c3RyYXRlZCBhYm92ZSkgYmFzZWQgb24gInRoZSBldWNsaWRlYW4gZGlzdGFuY2UgaW4gUENBIHNwYWNlIiBiZXR3ZWVuIHRoZSBjZWxscyBhbmQgdGhlIGVkZ2Ugd2VpZ2h0cyBiZXR3ZWVuIGFueSB0d28gY2VsbHMgKGUuZy4gdGhlaXIgImNsb3NlbmVzcyIpIGlzIHJlZmluZWQgYmFzZWQgb24gSmFjY2FyZCBzaW1pbGFyaXR5IChbc291cmNlXShodHRwczovL2hiY3RyYWluaW5nLmdpdGh1Yi5pby9zY1JOQS1zZXFfb25saW5lL2xlc3NvbnMvMDdfU0NfY2x1c3RlcmluZ19jZWxsc19TQ1QuaHRtbCkpLgoKPGRldGFpbHM+CiAgICA8c3VtbWFyeT4qQWRkaXRpb25hbCBjb250ZXh0IGFuZCBzb3VyY2VzIGZvciBncmFwaC1iYXNlZCBjbHVzdGVyaW5nKjwvc3VtbWFyeT4KICAgIFtDYW1icmlkZ2UgQmlvaW5mb3JtYXRpY3MnIEFuYWx5c2lzIG9mIHNpbmdsZSBjZWxsIFJOQS1zZXEgZGF0YSBjb3Vyc2UgbWF0ZXJpYWxzXShodHRwczovL2Jpb2NlbGxnZW4tcHVibGljLnN2aS5lZHUuYXUvbWlnXzIwMTlfc2NybmFzZXEtd29ya3Nob3AvY2x1c3RlcmluZy1hbmQtY2VsbC1hbm5vdGF0aW9uLmh0bWwpLCB0aGUgc291cmNlIG9mIHRoZSBpbWFnZSBhYm92ZSwgZGVsdmVzIGludG8ga05OIGFuZCBvdGhlciBncmFwaCBiYXNlZCBjbHVzdGVyaW5nIG1ldGhvZHMgaW4gbXVjaCBncmVhdGVyIGRldGFpbCwgaW5jbHVkaW5nIG91dGxpbmluZyBwb3NzaWJsZSBkb3duc2lkZXMgZm9yIHRoZXNlIG1ldGhvZHMuIAogICAgIFRvIGRlc2NyaWJlZCBrTk4sIHdlIGhhdmUgYWxzbyBkcmF3biBmcm9tIHRoZSBbSG8gTGFiJ3MgZGVzY3JpcHRpb24gb2YgdGhpcyBwcm9jZXNzIGZvciBTZXVyYXQgdjNdKGh0dHBzOi8vaG9sYWItaGt1LmdpdGh1Yi5pby9GdW5kYW1lbnRhbC1zY1JOQS9kb3duc3RyZWFtLmh0bWwjcGVyZm9ybS1saW5lYXItZGltZW5zaW9uYWwtcmVkdWN0aW9uKSBhcyB3ZWxsIGFzIHRoZSBbSEJDIG1hdGVyaWFscyBvbiBjbHVzdGVyaW5nXShodHRwczovL2hiY3RyYWluaW5nLmdpdGh1Yi5pby9zY1JOQS1zZXFfb25saW5lL2xlc3NvbnMvMDdfU0NfY2x1c3RlcmluZ19jZWxsc19TQ1QuaHRtbCkgYW5kIHRoZSBbT1NDQSBib29rJ3MgbW9yZSBnZW5lcmFsIG92ZXJ2aWV3IG9mIGdyYXBoIGJhc2VkIGNsdXN0ZXJpbmddKGh0dHBzOi8vYmlvY29uZHVjdG9yLm9yZy9ib29rcy8zLjE1L09TQ0EuYmFzaWMvY2x1c3RlcmluZy5odG1sI2NsdXN0ZXJpbmctZ3JhcGgpLCB3aGljaCBhbHNvIGRlc2NyaWJlcyB0aGUgZHJhd2JhY2tzIGZvciB0aGVzZSBtZXRob2RzLgo8L2RldGFpbHM+Cjxicj4KClRoaXMgcHJvY2VzcyBpcyBwZXJmb3JtZWQgd2l0aCB0aGUgYEZpbmROZWlnaGJvcnMoKWAgW2NvbW1hbmRdKGh0dHBzOi8vc2F0aWphbGFiLm9yZy9zZXVyYXQvcmVmZXJlbmNlL2ZpbmRuZWlnaGJvcnMpLCB1c2luZyB0aGUgbnVtYmVyIG9mIHByaW5jaXBhbCBjb21wb25lbnRzIHdlIHNlbGVjdGVkIGluIHRoZSBwcmV2aW91cyBzZWN0aW9uLgoKVGhlIHNlY29uZCBzdGVwIGlzIHRvIGl0ZXJhdGl2ZWx5IHBhcnRpdGlvbiB0aGUga05OIGdyYXBoIGludG8gImNsaXF1ZXMiIG9yIGNsdXN0ZXJzIHVzaW5nIHRoZSBMb3V2YWluIG1vZHVsYXJpdHkgb3B0aW1pemF0aW9uIGFsZ29yaXRobSAoZm9yIHRoZSBkZWZhdWx0IHBhcmFtZXRlcnMpLCB3aXRoIHRoZSAiZ3JhbnVsYXJpdHkiIG9mIHRoZSBjbHVzdGVycyBzZXQgYnkgYSBgcmVzb2x1dGlvbmAgcGFyYW1ldGVyIChbc291cmNlXShodHRwczovL3NhdGlqYWxhYi5vcmcvc2V1cmF0L2FydGljbGVzL3BibWMza190dXRvcmlhbC5odG1sKSkuCgohW0ltYWdlOiBLLW1lYW5zIGNsdXN0ZXJpbmcgZXhhbXBsZSAoZnJvbSBDYW1icmlkZ2UgQmlvaW5mb3JtYXRpY3MgY291cnNlKV0oLi9pbWFnZXMvY3VycmljdWx1bS8wNS1Qcm9qZWN0aW9uQW5kQ2x1c3RlcmluZy9IQkMtMDctay1tZWFuc0ZpZ3VyZS5wbmcpCgpXZSdsbCB1c2UgdGhlIGBGaW5kQ2x1c3RlcnMoKWAgW2Z1bmN0aW9uXShodHRwczovL3NhdGlqYWxhYi5vcmcvc2V1cmF0L3JlZmVyZW5jZS9maW5kY2x1c3RlcnMpLCBzZWxlY3RpbmcgYSByZXNvbHV0aW9uIG9mIGAwLjRgIHRvIHN0YXJ0LCBhbHRob3VnaCB3ZSBjb3VsZCBhbHNvIGFkZCBvdGhlciByZXNvbHV0aW9ucyBhdCB0aGlzIHN0YWdlIHRvIGxvb2sgYXQgaW4gbGF0ZXIgc3RlcHMuIFNlZSBbV2FsdG1hbiBhbmQgSmFuIHZhbiBFY2sgKDIwMTMpXShodHRwczovL2xpbmsuc3ByaW5nZXIuY29tL2FydGljbGUvMTAuMTE0MC9lcGpiL2UyMDEzLTQwODI5LTApIGZvciB0aGUgdW5kZXJseWluZyBhbGdvcml0aG1zLgoKQWdhaW4sIGhvdyBhIOKAnGNlbGwgdHlwZeKAnSBvciDigJxzdWJ0eXBl4oCdIHNob3VsZCBiZSBkZWZpbmVkIGZvciB5b3VyIGRhdGEgaXMgaW1wb3J0YW50IHRvIGNvbnNpZGVyIGluIHNlbGVjdGluZyBhIHJlc29sdXRpb24gLSB3ZSdkIHN0YXJ0IHdpdGggYSBoaWdoZXIgcmVzb2x1dGlvbiBmb3Igc21hbGxlci9tb3JlIHJhcmUgY2x1c3RlcnMgYW5kIGEgbG93ZXIgcmVzb2x1dGlvbiBmb3IgbGFyZ2VyL21vcmUgZ2VuZXJhbCBjbHVzdGVycy4gIAoKVGhlbiwgd2hlbiB3ZSBsb29rIGF0IHRoZSBtZXRhIGRhdGEgd2Ugc2hvdWxkIHNlZSB0aGF0IGNsdXN0ZXIgbGFiZWxzIGhhdmUgYmVlbiBhZGRlZCBmb3IgZWFjaCBjZWxsOgoKYGBge3IsIGZpbmRfbmVpZ2hib3JzLCBjYWNoZSA9IFRSVUUsIGNhY2hlLmxhenkgPSBGQUxTRSwgd2FybmluZyA9IEZBTFNFLCBtZXNzYWdlID0gRkFMU0V9CiMgQ29kZSBibG9jayAtIGNsdXN0ZXJpbmcKIyBDcmVhdGUgS05OIGdyYXBoIHdpdGggYEZpbmROZWlnaGJvcnMoKWAKZ2VvX3NvID0gRmluZE5laWdoYm9ycyhnZW9fc28sIGRpbXMgPSAxOnBjcywgcmVkdWN0aW9uID0gJ2ludGVncmF0ZWQuc2N0LnJwY2EnKQoKIyBnZW5lcmF0ZSBjbHVzdGVycwpnZW9fc28gPSBGaW5kQ2x1c3RlcnMoZ2VvX3NvLCByZXNvbHV0aW9uID0gMC40LCBjbHVzdGVyLm5hbWUgPSAnaW50ZWdyYXRlZC5zY3QucnBjYS5jbHVzdGVycycpCgojIGxvb2sgYXQgbWV0YS5kYXRhIHRvIHNlZSBjbHVzdGVyIGxhYmVscwpoZWFkKGdlb19zb0BtZXRhLmRhdGEpCmBgYAoKR2VuZXJhbGx5IGl0J3MgcHJlZmVyYWJsZSB0byBlcnIgb24gdGhlIHNpZGUgb2YgdG9vIG1hbnkgY2x1c3RlcnMsIGFzIHRoZXkgY2FuIGJlIGNvbWJpbmVkIG1hbnVhbGx5IGluIGxhdGVyIHN0ZXBzLiBJbiBvdXIgZXhwZXJpZW5jZSwgdGhpcyBpcyBhbm90aGVyIHBhcmFtZXRlciB0aGF0IG9mdGVuIG5lZWRzIHRvIGJlIGl0ZXJhdGl2ZWx5IHJldmlzZWQgYW5kIHJldmlld2VkLiAKCjxkZXRhaWxzPgogICAgPHN1bW1hcnk+KlJlc29sdXRpb24gcGFyYW1ldGVyIHJlY29tbWVuZGF0aW9ucyo8L3N1bW1hcnk+CiAgICBUaGUgW1NldXJhdCBjbHVzdGVyaW5nIHR1dG9yaWFsXShodHRwczovL2hvbGFiLWhrdS5naXRodWIuaW8vRnVuZGFtZW50YWwtc2NSTkEvZG93bnN0cmVhbS5odG1sI3BlcmZvcm0tbGluZWFyLWRpbWVuc2lvbmFsLXJlZHVjdGlvbikgcmVjb21tZW5kcyBzZWxlY3RpbmcgYSByZXNvbHV0aW9uIGJldHdlZW4gMC40IC0gMS4yIGZvciBkYXRhc2V0cyBvZiBhcHByb3hpbWF0ZWx5IDNrIGNlbGxzLCB3aGlsZSB0aGUgW0hCQyBjb3Vyc2VdKGh0dHBzOi8vaGJjdHJhaW5pbmcuZ2l0aHViLmlvL3NjUk5BLXNlcV9vbmxpbmUvbGVzc29ucy8wN19TQ19jbHVzdGVyaW5nX2NlbGxzX1NDVC5odG1sKSByZWNvbW1lbmRzIDAuNC0xLjQgZm9yIDNrLTVrIGNlbGxzLiBIb3dldmVyLCBpbiBvdXIgZXhwZXJpZW5jZSByZWFzb25hYmxlIHN0YXJ0aW5nIHJlc29sdXRpb25zIGNhbiBiZSB2ZXJ5IGRhdGFzZXQgZGVwZW5kZW50Lgo8L2RldGFpbHM+Cjxicj4KCiMgQ2x1c3RlciBwbG90cyAKClRvIHZpc3VhbGl6ZSB0aGUgY2VsbCBjbHVzdGVycywgd2UgY2FuIHVzZSBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24gdGVjaG5pcXVlcyB0byB2aXN1YWxpemUgYW5kIGV4cGxvcmUgb3VyIGxhcmdlLCBoaWdoLWRpbWVuc2lvbmFsIGRhdGFzZXQuIFR3byBwb3B1bGFyIG1ldGhvZHMgdGhhdCBhcmUgc3VwcG9ydGVkIGJ5IFNldXJhdCBhcmUgdC1kaXN0cmlidXRlZCBzdG9jaGFzdGljIG5laWdoYm9yIGVtYmVkZGluZyAodC1TTkUpIGFuZCBVbmlmb3JtIE1hbmlmb2xkIEFwcHJveGltYXRpb24gYW5kIFByb2plY3Rpb24gKFVNQVApIHRlY2huaXF1ZXMuIFRoZXNlIHRlY2huaXF1ZXMgYWxsb3cgdXMgdG8gdmlzdWFsaXplIG91ciBoaWdoLWRpbWVuc2lvbmFsIHNpbmdsZS1jZWxsIGRhdGEgaW4gMkQgc3BhY2UgYW5kIHNlZSBpZiBjZWxscyBncm91cGVkIHRvZ2V0aGVyIHdpdGhpbiBncmFwaC1iYXNlZCBjbHVzdGVycyBjby1sb2NhbGl6ZSBpbiB0aGVzZSByZXByZXNlbnRhdGlvbnMgKFtzb3VyY2VdKGh0dHBzOi8vc2F0aWphbGFiLm9yZy9zZXVyYXQvYXJ0aWNsZXMvcGJtYzNrX3R1dG9yaWFsLmh0bWwjcnVuLW5vbi1saW5lYXItZGltZW5zaW9uYWwtcmVkdWN0aW9uLXVtYXB0c25lKSkuCgpXaGlsZSB3ZSB1bmZvcnR1bmF0ZWx5IGRvbid0IGhhdmUgdGltZSB0byBjb21wYXJlIGFuZCBjb250cmFzdCB0U05FLCBhbmQgVU1BUCwgd2Ugd291bGQgaGlnaGx5IHJlY29tbWVuZCBbdGhpcyBibG9nIHBvc3QgY29udHJhc3RpbmcgdFNORSBhbmQgVU1BUF0oaHR0cHM6Ly9wYWlyLWNvZGUuZ2l0aHViLmlvL3VuZGVyc3RhbmRpbmctdW1hcC8pIGZvciBpbGx1c3RyYXRpdmUgZXhhbXBsZXMuIFRoZSBTZXVyYXQgYXV0aG9ycyBhZGRpdGlvbmFsbHkgY2F1dGlvbiB0aGF0IHdoaWxlIHRoZXNlIG1ldGhvZHMgYXJlIHVzZWZ1bCBmb3IgZGF0YSBleHBsb3JhdGlvbiwgdG8gYXZvaWQgZHJhd2luZyBiaW9sb2dpY2FsIGNvbmNsdXNpb25zIHNvbGVseSBiYXNlZCBvbiB0aGVzZSB2aXN1YWxpemF0aW9ucyAoW3NvdXJjZV0oaHR0cHM6Ly9zYXRpamFsYWIub3JnL3NldXJhdC9hcnRpY2xlcy9wYm1jM2tfdHV0b3JpYWwuaHRtbCNydW4tbm9uLWxpbmVhci1kaW1lbnNpb25hbC1yZWR1Y3Rpb24tdW1hcHRzbmUpKS4KClRvIHN0YXJ0IHRoaXMgcHJvY2Vzcywgd2UnbGwgdXNlIHRoZSBgUnVuVU1BUCgpYCBbZnVuY3Rpb25dKGh0dHBzOi8vc2F0aWphbGFiLm9yZy9zZXVyYXQvcmVmZXJlbmNlL3J1bnVtYXApIHRvIGNhbGN1bGF0ZSB0aGUgVU1BUCByZWR1Y3Rpb24gZm9yIG91ciBkYXRhLiBOb3RpY2UgaG93IHRoZSBwcmV2aW91cyBkaW1lbnNpb25hbGl0eSBjaG9pY2VzIGNhcnJ5IHRocm91Z2ggdGhlIGRvd25zdHJlYW0gYW5hbHlzaXMgYW5kIHRoYXQgdGhlIG51bWJlciBvZiBQQ3Mgc2VsZWN0ZWQgaW4gdGhlIHByZXZpb3VzIHN0ZXBzIGFyZSBpbmNsdWRlZCBhcyBhbiBhcmd1bWVudC4KCmBgYHtyLCBydW5fdW1hcCwgY2FjaGUgPSBUUlVFLCBjYWNoZS5sYXp5ID0gRkFMU0UsIHdhcm5pbmcgPSBGQUxTRSwgbWVzc2FnZSA9IEZBTFNFfQpnZW9fc28gPSBSdW5VTUFQKGdlb19zbywgZGltcyA9IDE6cGNzLCByZWR1Y3Rpb24gPSAnaW50ZWdyYXRlZC5zY3QucnBjYScsIHJlZHVjdGlvbi5uYW1lID0gJ3VtYXAuaW50ZWdyYXRlZC5zY3QucnBjYScpCmdlb19zbyAjIE5vdGljZSBhIHRoaXJkIHJlZHVjdGlvbiBoYXMgYmVlbiBhZGRlZDogYHVtYXAuaW50ZWdyYXRlZC5zY3QucnBjYWAKYGBgCgoKIyBWaXN1YWxpemluZyBhbmQgZXZhbHVhdGluZyBjbHVzdGVyaW5nCgo8IS0tLSBIb3cgbWFueSBjbHVzdGVycyBzaG91bGQgSSBnZXQgYW5kIGhvdyBkbyBJIGFkanVzdCB0aGUgbnVtYmVyPyAtLS0+Cgo8IS0tLSBBZGQgZXhhbXBsZSBvZiBjaGFuZ2luZyByZXNvbHV0aW9uPy0tLT4KCkFmdGVyIHdlIGdlbmVyYXRlIHRoZSBVTUFQIHJlZHVjdGlvbiwgd2UgY2FuIHRoZW4gdmlzdWFsaXplIHRoZSByZXN1bHRzIHVzaW5nIHRoZSBgRGltUGxvdCgpYCBbZnVuY3Rpb25dKGh0dHBzOi8vc2F0aWphbGFiLm9yZy9zZXVyYXQvcmVmZXJlbmNlL2RpbXBsb3QpLCBsYWJlbGluZyBvdXIgcGxvdCBieSB0aGUgYXV0byBnZW5lcmF0ZWQgYHNldXJhdF9jbHVzdGVyc2AgdGhhdCBjb3JyZXNwb25kIHRvIHRoZSBtb3N0IHJlY2VudCBjbHVzdGVyaW5nIHJlc3VsdHMgZ2VuZXJhdGVkLgoKQXQgdGhpcyBzdGFnZSwgd2Ugd2FudCB0byBkZXRlcm1pbmUgaWYgdGhlIGNsdXN0ZXJzIGxvb2sgZmFpcmx5IHdlbGwgc2VwYXJhdGVkLCBpZiB0aGV5IHNlZW0gdG8gY29ycmVzcG9uZCB0byBob3cgY2VsbHMgYXJlIGdyb3VwZWQgaW4gdGhlIFVNQVAsIGFuZCBpZiB0aGUgbnVtYmVyIG9mIGNsdXN0ZXJzIGlzIGdlbmVyYWxseSBhbGlnbmVkIHdpdGggdGhlIHJlc29sdXRpb24gb2Ygb3VyIGJpb2xvZ2ljYWwgcXVlc3Rpb24uIEFnYWluLCBpZiB0aGVyZSBhcmUgInRvbyBtYW55IiBjbHVzdGVycyB0aGF0J3Mgbm90IG5lY2Vzc2FyaWx5IGEgcHJvYmxlbS4KCldlIGNhbiBhbHNvIGxvb2sgYXQgdGhlIHNhbWUgVU1BUCBsYWJlbGVkIGJ5IGBkYXlgIHRvIHZpc3VhbGx5IGluc3BlY3QgaWYgdGhlIFVNQVAgc3RydWN0dXJlIGNvcnJlc3BvbmRzIHRvIHRoZSBgZGF5YC4KCmBgYHtyLCB1bWFwX2J5X2NsdXN0ZXJzfQojIENvZGUgYmxvY2sgLSBVTUFQIGNsdXN0ZXIgdmlzdWFsaXphdGlvbiAKIyBjbHVzdGVyIElEIGxhYmVscwpwb3N0X2ludGVncmF0aW9uX3VtYXBfcGxvdF9jbHVzdGVycyA9IERpbVBsb3QoZ2VvX3NvLCBncm91cC5ieSA9ICdzZXVyYXRfY2x1c3RlcnMnLCBsYWJlbCA9IFRSVUUsIHJlZHVjdGlvbiA9ICd1bWFwLmludGVncmF0ZWQuc2N0LnJwY2EnKSArIE5vTGVnZW5kKCkKcG9zdF9pbnRlZ3JhdGlvbl91bWFwX3Bsb3RfY2x1c3RlcnMKCmdnc2F2ZShmaWxlbmFtZSA9ICdyZXN1bHRzL2ZpZ3VyZXMvdW1hcF9pbnRlZ3JhdGVkX3NjdF9jbHVzdGVycy5wbmcnLCBwbG90ID0gcG9zdF9pbnRlZ3JhdGlvbl91bWFwX3Bsb3RfY2x1c3RlcnMsIHdpZHRoID0gNiwgaGVpZ2h0ID0gNiwgdW5pdHMgPSAnaW4nKQoKIyBVTUFQIHdpdGggZGF5IGxhYmVscyAobm90ZSAtIHdlIGFkZGVkIHRoaXMgY29sdW1uIHRvIHRoZSBtZXRhLWRhdGEgeWVzdGVyZGF5KQpwb3N0X2ludGVncmF0aW9uX3VtYXBfcGxvdF9kYXkgPSBEaW1QbG90KGdlb19zbywgZ3JvdXAuYnkgPSAnZGF5JywgbGFiZWwgPSBGQUxTRSwgcmVkdWN0aW9uID0gJ3VtYXAuaW50ZWdyYXRlZC5zY3QucnBjYScpCnBvc3RfaW50ZWdyYXRpb25fdW1hcF9wbG90X2RheQoKZ2dzYXZlKGZpbGVuYW1lID0gJ3Jlc3VsdHMvZmlndXJlcy91bWFwX2ludGVncmF0ZWRfc2N0X2RheS5wbmcnLCBwbG90ID0gcG9zdF9pbnRlZ3JhdGlvbl91bWFwX3Bsb3RfZGF5LCB3aWR0aCA9IDgsIGhlaWdodCA9IDYsIHVuaXRzID0gJ2luJykKYGBgCgpTaW1pbGFyIHRvIHRoZSBQQ0EgcGxvdHMsIHRoZSBgZGF5YCBsYWJlbGVkIFVNQVAgY2FuIHRlbGwgdXMgaWYgdGVjaG5pY2FsIHNvdXJjZXMgb2YgdmFyaWF0aW9uIG1pZ2h0IGJlIGRyaXZpbmcgb3Igc3RyYXRpZnlpbmcgdGhlIGNsdXN0ZXJzLCB3aGljaCB3b3VsZCBzdWdnZXN0IHRoYXQgdGhlIG5vcm1hbGl6YXRpb24gYW5kIGludGVncmF0aW9uIHN0ZXBzIHNob3VsZCBiZSByZXZpc3RlZCBiZWZvcmUgcHJvY2VlZGluZy4KCkFub3RoZXIgYXBwcm9hY2ggaXMgdG8gZXZhbHVhdGUgdGhlIG51bWJlciBvZiBjZWxscyBwZXIgY2x1c3RlciB1c2luZyB0aGUgYHRhYmxlKClgIGZ1bmN0aW9uLCBzcGxpdCBieSBgZGF5YCBvciBzcGxpdCBieSBgb3JpZy5pZGVudGAgdG8gc2VlIGlmIHRoZSBpbmRpdmlkdWFsIHNhbXBsZXMgYXJlIGRyaXZpbmcgYW55IG9mIHRoZSBVTUFQIHN0cnVjdHVyZToKCmBgYHtyLCB0YWJsZV9ieV9kYXl9CiMgQ29kZSBibG9jayAtIGNlbGwgY291bnQgdGFibGVzCiMgY2VsbHMgcGVyIGNsdXN0ZXIsIHNwbGl0IGJ5IGNvbmRpdGlvbgp0YWJsZShnZW9fc29AbWV0YS5kYXRhJGRheSwgZ2VvX3NvQG1ldGEuZGF0YSRpbnRlZ3JhdGVkLnNjdC5ycGNhLmNsdXN0ZXJzKQoKIyBjZWxscyBwZXIgY2x1c3RlciBwZXIgc2FtcGxlCnRhYmxlKGdlb19zb0BtZXRhLmRhdGEkb3JpZy5pZGVudCwgZ2VvX3NvQG1ldGEuZGF0YSRpbnRlZ3JhdGVkLnNjdC5ycGNhLmNsdXN0ZXJzKQpgYGAKCjwhLS0gY29uc2lkZXIgYWRkaW5nIGxhdGVyIApBZGQgRGltUGxvdCBmb3IgJSBtaXRvY2hvbmRyaWEgdG8gc2VlIGlmIGhpZ2ggJSBhcmUgYWNyb3NzIGRhdGFzZXQgb3IgbGltaXRlZCB0byBvbmUvZmV3IGNsdXN0ZXJzIChyZWxhdGVkIHRvIHdoYXQgT2xpdmlhIHRhbGtlZCBhYm91dCBkdXJpbmcgRGF5IDEpCgojIE90aGVyIGFwcHJvYWNoZXMgZm9yIHZpc3VhbGl6aW5nIHNjUk5BLXNxIGRhdGEKZS5nLiBjb2RlIGZvciB0U05FIHZpc3VhbGl6YXRpb24gCi0tPgoKIyBDb21wYXJpbmcgdG8gdW5pbnRlZ3JhdGVkIGRhdGEKCklmIHdlIGhhZCBwcm9jZWVkZWQgd2l0aCBvdXIgZmlsdGVyZWQgZGF0YSBhbmQgb25seSBub3JtYWxpemVkIG91ciBkYXRhIHdpdGhvdXQgZG9pbmcgYW55IGludGVncmF0aW9uLCBpbmNsdWRpbmcgdGhyb3VnaCB0aGUgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uIGFuZCBjbHVzdGVyaW5nIHN0ZXBzIGFuZCB0aGVuIGxhYmVsZWQgdGhlIGNlbGxzIHdpdGggdGhlaXIgc2FtcGxlIG9mIG9yaWdpbiwgdGhlbiB3ZSB3b3VsZCBzZWUgdGhlIGZvbGxvd2luZyBmb3Igb3VyIGRhdGE6Cgo8IS0tQWRkIHVwZGF0ZWQgZXhhbXBsZSBvZiBVTUFQIC8gc2FtcGxlIGxhYmVscyBmb3IgdW5pbnRlZ3JhdGVkIGRhdGEgLSBuZWVkIHRvIGNoZWNrIHdpdGggUmF5bW9uZCByZWdhcmRpbmcgaG93IGJlc3QgdG8gZG8gdGhpcyBpbiBwbGFjZSAtLT4gCgpgYGB7ciwgcnVuX3VtYXBfdW5pbnRlZ3JhdGVkLCBlY2hvID0gRkFMU0UsIGNhY2hlID0gVFJVRSwgY2FjaGUubGF6eSA9IEZBTFNFLCB3YXJuaW5nID0gRkFMU0UsIG1lc3NhZ2UgPSBGQUxTRX0KIyBDcmVhdGUgS05OIGdyYXBoIHdpdGggYEZpbmROZWlnaGJvcnMoKWAgZm9yIHVuaW50ZWdyYXRlZCBkYXRhCmdlb19zbyA9IEZpbmROZWlnaGJvcnMoZ2VvX3NvLCBkaW1zID0gMTpwY3MsIHJlZHVjdGlvbiA9ICd1bmludGVncmF0ZWQuc2N0LnBjYScpCgojIGdlbmVyYXRlIGNsdXN0ZXJzIGZvciB1bmludGVncmF0ZWQgZGF0YQpnZW9fc28gPSBGaW5kQ2x1c3RlcnMoZ2VvX3NvLCByZXNvbHV0aW9uID0gMC40LCBjbHVzdGVyLm5hbWUgPSAndW5pbnRlZ3JhdGVkLnNjdC5wY2EuY2x1c3RlcnMnKQoKZ2VvX3NvID0gUnVuVU1BUChnZW9fc28sIGRpbXMgPSAxOnBjcywgcmVkdWN0aW9uID0gJ3VuaW50ZWdyYXRlZC5zY3QucGNhJywgcmVkdWN0aW9uLm5hbWUgPSAndW1hcC51bmludGVncmF0ZWQuc2N0LnBjYScpCgpwcmVfaW50ZWdyYXRpb25fdW1hcF9wbG90X2RheSA9IERpbVBsb3QoZ2VvX3NvLCBncm91cC5ieSA9ICdkYXknLCBsYWJlbCA9IEZBTFNFLCByZWR1Y3Rpb24gPSAndW1hcC51bmludGVncmF0ZWQuc2N0LnBjYScpCgpwcmludChwcmVfaW50ZWdyYXRpb25fdW1hcF9wbG90X2RheSArIHBvc3RfaW50ZWdyYXRpb25fdW1hcF9wbG90X2RheSkKYGBgCgpJbiB0aGUgcGxvdCBhdCBsZWZ0LCB3ZSBzZWUgdGhhdCB3aGlsZSB0aGVyZSBhcmUgZGlzdGluY3QgY2x1c3RlcnMsIHRob3NlIGNsdXN0ZXJzIHNlZW0gdG8gc3RyYXRpZmllZCBieSBkYXkuIFRoaXMgc3VnZ2VzdHMgdGhhdCB3aXRob3V0IGludGVncmF0aW9uLCB0aGVzZSBiYXRjaCBlZmZlY3RzIGNvdWxkIHNrZXcgdGhlIGJpb2xvZ2ljYWwgdmFyaWFiaWxpdHkgaW4gb3VyIGRhdGEuIFdoaWxlIG9uIHRoZSByaWdodCwgd2Ugc2VlIGxpdHRsZSBzdHJhdGlmaWNhdGlvbiB3aXRoaW4gb3VyIGNsdXN0ZXJzIHdoaWNoIG1lYW5zIHRoZSBpbnRlZ3JhdGlvbiBzZWVtcyB0byBoYXZlIHJlbW92ZWQgdGhvc2UgYmF0Y2ggZWZmZWN0cy4KCjwhLS0gRWRpdCBzZWN0aW9uIHRvIGluY29ycG9yYXRlIC0tLT4KCjxkZXRhaWxzPgo8c3VtbWFyeT4qKlJld2luZDogUHJlLWludGVncmF0aW9uIGV2YWx1YXRpb24gY2x1c3RlcmluZyBhbmQgdmlzdWFsaXphdGlvbiAoY29kZSkqKjwvc3VtbWFyeT4KUHJpb3IgdG8gaW50ZWdyYXRpb24sIHdlIGNvdWxkIGZvbGxvdyB0aGUgc2FtZSBzdGVwcyB3ZSd2ZSBqdXN0IHJ1biBmb3IgdGhlIGludGVncmF0ZWQgdG8gc2VlIGlmIHRoZSByZXN1bHRpbmcgY2x1c3RlcnMgdGVuZCB0byBiZSBkZXRlcm1pbmVkIGJ5IHNhbXBsZSBvciBjb25kaXRpb24gKGluIHRoaXMgY2FzZSwgdGhlIGRheSk6CgpgYGB7ciwgZXZhbD1GQUxTRX0KZ2VvX3NvID0gRmluZE5laWdoYm9ycyhnZW9fc28sIGRpbXMgPSAxOnBjcywgYXNzYXkgPSAnUk5BJywgcmVkdWN0aW9uID0gJ3VuaW50ZWdyYXRlZC5zY3QucGNhJywgZ3JhcGgubmFtZSA9IGMoJ1JOQV9ubicsICdSTkFfc25uJykpCmdlb19zbyA9IEZpbmRDbHVzdGVycyhnZW9fc28sIHJlc29sdXRpb24gPSAwLjQsIGdyYXBoLm5hbWUgPSAnUk5BX3NubicsIGNsdXN0ZXIubmFtZSA9ICd1bmludGVncmF0ZWQuc2N0LmNsdXN0ZXJzJykKZ2VvX3NvID0gUnVuVU1BUChnZW9fc28sIGRpbXMgPSAxOnBjcywgcmVkdWN0aW9uID0gJ3VuaW50ZWdyYXRlZC5zY3QucGNhJywgcmVkdWN0aW9uLm5hbWUgPSAndW1hcC51bmludGVncmF0ZWQuc2N0LnBjYScpCmBgYAoJClRoZSBwbG90cyBhYm92ZSB3ZXJlIGdlbmVyYXRlZCB3aXRoOgoKYGBge3IsIGV2YWw9RkFMU0V9CnByZV9pbnRlZ3JhdGlvbl91bWFwX3Bsb3Rfb3JpZy5pZGVudCA9IERpbVBsb3QoZ2VvX3NvLCBncm91cC5ieSA9ICdvcmlnLmlkZW50JywgbGFiZWwgPSBGQUxTRSwgcmVkdWN0aW9uID0gJ3VtYXAudW5pbnRlZ3JhdGVkLnNjdC5wY2EnKQpnZ3NhdmUoZmlsZW5hbWUgPSAncmVzdWx0cy9maWd1cmVzL3VtYXBfdW5pbnRlZ3JhdGVkX3NjdF9vcmlnLmlkZW50LnBuZycsIHBsb3QgPSBwcmVfaW50ZWdyYXRpb25fdW1hcF9wbG90X29yaWcuaWRlbnQsIHdpZHRoID0gOCwgaGVpZ2h0ID0gNiwgdW5pdHMgPSAnaW4nKQpgYGAKCmBgYHtyLCBldmFsPUZBTFNFfQpwcmVfaW50ZWdyYXRpb25fdW1hcF9wbG90X2RheSA9IERpbVBsb3QoZ2VvX3NvLCBncm91cC5ieSA9ICdkYXknLCBsYWJlbCA9IEZBTFNFLCByZWR1Y3Rpb24gPSAndW1hcC51bmludGVncmF0ZWQuc2N0LnBjYScpCmdnc2F2ZShmaWxlbmFtZSA9ICdyZXN1bHRzL2ZpZ3VyZXMvdW1hcF91bmludGVncmF0ZWRfc2N0X2RheS5wbmcnLCBwbG90ID0gcHJlX2ludGVncmF0aW9uX3VtYXBfcGxvdF9kYXksIHdpZHRoID0gOCwgaGVpZ2h0ID0gNiwgdW5pdHMgPSAnaW4nKQpgYGAKPC9kZXRhaWxzPgo8YnI+Cjxicj4KCjxkZXRhaWxzPgo8c3VtbWFyeT4qKkFsdGVybmF0aXZlIGNsdXN0ZXJpbmcgcmVzb2x1dGlvbnMqKjwvc3VtbWFyeT4KV2hpbGUgd2Ugc2hvdyBhIHNpbmdsZSByZXNvbHV0aW9uLCB3ZSBjYW4gZ2VuZXJhdGUgYW5kIHBsb3QgbXVsdGlwbGUgcmVzb2x1dGlvbnMgaXRlcmF0aXZlbHkgYW5kIGNvbXBhcmUgYmV0d2VlbiB0aGVtIGJlZm9yZSBzZWxlY3RpbmcgYSBjbHVzdGVyaW5nIHJlc3VsdCBmb3IgdGhlIG5leHQgc3RlcHM6CgpgYGB7ciwgZXZhbD1GQUxTRX0KcmVzb2x1dGlvbnMgPSBjKDAuNCwgMC44KQoKZm9yKHJlcyBpbiByZXNvbHV0aW9ucykgewogICAgbWVzc2FnZShyZXMpCgogICAgY2x1c3Rlcl9jb2x1bW4gPSBzcHJpbnRmKCdTQ1Rfc25uX3Jlcy4lcycsIHJlcykKICAgIHVtYXBfZmlsZSA9IHNwcmludGYoJ3Jlc3VsdHMvZmlndXJlcy91bWFwX2ludGVncmF0ZWRfc2N0XyVzLnBuZycsIHJlcykKCiAgICBnZW9fc28gPSBGaW5kQ2x1c3RlcnMoZ2VvX3NvLCByZXNvbHV0aW9uID0gcmVzKQoKICAgIERpbVBsb3QoZ2VvX3NvLCBncm91cC5ieSA9IGNsdXN0ZXJfY29sdW1uLCBsYWJlbCA9IFRSVUUsIHJlZHVjdGlvbiA9ICd1bWFwLmludGVncmF0ZWQuc2N0LnJwY2EnKSArIE5vTGVnZW5kKCkKICAgIGdnc2F2ZShmaWxlbmFtZSA9IHVtYXBfZmlsZSwgd2lkdGggPSA4LCBoZWlnaHQgPSA3LCB1bml0cyA9ICdpbicpCn0KYGBgCgpJbiB0aGUgcmVzdWx0cywgd2UnbGwgc2VlIG11bHRpcGxlIHJlc29sdXRpb25zIHNob3VsZCBub3cgYmUgYWRkZWQgdG8gdGhlIG1ldGFkYXRhIHNsb3QuCgpgYGB7ciwgZXZhbD1GQUxTRX0KaGVhZChnZW9fc29AbWV0YS5kYXRhKQpgYGAKPC9kZXRhaWxzPgo8YnI+Cjxicj4KCiMgU2F2ZSBvdXIgcHJvZ3Jlc3MKCkJlZm9yZSBtb3Zpbmcgb24gdG8gb3VyIG5leHQgc2VjdGlvbiwgd2Ugd2lsbCBvdXRwdXQgb3VyIHVwZGF0ZWQgU2V1cmF0IG9iamVjdCB0byBmaWxlOgoKYGBge3IsIHNhdmVfcmRzX2hpZGRlbiwgZWNobyA9IEZBTFNFfQppZighZmlsZS5leGlzdHMoJ3Jlc3VsdHMvcmRhdGEvZ2VvX3NvX3NjdF9jbHVzdGVyZWQucmRzJykpIHsKICBzYXZlUkRTKGdlb19zbywgZmlsZSA9ICdyZXN1bHRzL3JkYXRhL2dlb19zb19zY3RfY2x1c3RlcmVkLnJkcycpCn0KYGBgCgpgYGB7ciwgZXZhbD1GQUxTRX0Kc2F2ZVJEUyhnZW9fc28sIGZpbGUgPSAncmVzdWx0cy9yZGF0YS9nZW9fc29fc2N0X2NsdXN0ZXJlZC5yZHMnKQpgYGAKCiMgU3VtbWFyeQoKSW4gdGhpcyBzZWN0aW9uIHdlOgoKLSBHZW5lcmF0ZWQgY2x1c3RlciBhc3NpZ25tZW50cyBmb3Igb3VyIGNlbGxzIHVzaW5nIGBGaW5kTmVpZ2hib3JzKClgIGFuZCBgRmluZENsdXN0ZXJzKClgCi0gRXZhbHVhdGVkIG91ciBpbml0aWFsIGNsdXN0ZXJzIHVzaW5nIGBSdW5VTUFQYCBkaW1lbnNpb25hbCByZWR1Y3Rpb24gYW5kIHZpc3VhbGl6YXRpb24KCk5leHQgc3RlcHM6IE1hcmtlciBnZW5lcwoKLS0tLQoKVGhlc2UgbWF0ZXJpYWxzIGhhdmUgYmVlbiBhZGFwdGVkIGFuZCBleHRlbmRlZCBmcm9tIG1hdGVyaWFscyBsaXN0ZWQgYWJvdmUuIFRoZXNlIGFyZSBvcGVuIGFjY2VzcyBtYXRlcmlhbHMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBbQ3JlYXRpdmUgQ29tbW9ucyBBdHRyaWJ1dGlvbiBsaWNlbnNlIChDQyBCWSA0LjApXShodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS80LjAvKSwgd2hpY2ggcGVybWl0cyB1bnJlc3RyaWN0ZWQgdXNlLCBkaXN0cmlidXRpb24sIGFuZCByZXByb2R1Y3Rpb24gaW4gYW55IG1lZGl1bSwgcHJvdmlkZWQgdGhlIG9yaWdpbmFsIGF1dGhvciBhbmQgc291cmNlIGFyZSBjcmVkaXRlZC4KCjxici8+Cjxici8+Cjxoci8+CnwgW1ByZXZpb3VzIGxlc3Nvbl0oMDQtUENBYW5kSW50ZWdyYXRpb24uaHRtbCkgfCBbVG9wIG9mIHRoaXMgbGVzc29uXSgjdG9wKSB8IFtOZXh0IGxlc3Nvbl0oMDYtTWFya2VyVmlzdWFsaXphdGlvbi5odG1sKSB8CnwgOi0tLSB8IDotLS0tOiB8IC0tLTogfAo=</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("05-ProjectionAndClustering.Rmd");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
